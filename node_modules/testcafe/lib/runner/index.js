'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _mapReverse = require('map-reverse');

var _mapReverse2 = _interopRequireDefault(_mapReverse);

var _events = require('events');

var _lodash = require('lodash');

var _bootstrapper = require('./bootstrapper');

var _bootstrapper2 = _interopRequireDefault(_bootstrapper);

var _reporter = require('../reporter');

var _reporter2 = _interopRequireDefault(_reporter);

var _task = require('./task');

var _task2 = _interopRequireDefault(_task);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _typeAssertions = require('../errors/runtime/type-assertions');

var _renderForbiddenCharsList = require('../errors/render-forbidden-chars-list');

var _renderForbiddenCharsList2 = _interopRequireDefault(_renderForbiddenCharsList);

var _checkFilePath = require('../utils/check-file-path');

var _checkFilePath2 = _interopRequireDefault(_checkFilePath);

var _handleErrors = require('../utils/handle-errors');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_SELECTOR_TIMEOUT = 10000;
const DEFAULT_ASSERTION_TIMEOUT = 3000;
const DEFAULT_PAGE_LOAD_TIMEOUT = 3000;

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:runner');

class Runner extends _events.EventEmitter {
    constructor(proxy, browserConnectionGateway, options = {}) {
        super();

        this.proxy = proxy;
        this.bootstrapper = new _bootstrapper2.default(browserConnectionGateway);
        this.pendingTaskPromises = [];

        this.opts = {
            externalProxyHost: null,
            proxyBypass: null,
            screenshotPath: null,
            takeScreenshotsOnFails: false,
            screenshotPathPattern: null,
            skipJsErrors: false,
            quarantineMode: false,
            debugMode: false,
            retryTestPages: options.retryTestPages,
            selectorTimeout: DEFAULT_SELECTOR_TIMEOUT,
            pageLoadTimeout: DEFAULT_PAGE_LOAD_TIMEOUT
        };
    }

    static _disposeBrowserSet(browserSet) {
        return browserSet.dispose().catch(e => DEBUG_LOGGER(e));
    }

    static _disposeReporters(reporters) {
        return _pinkie2.default.all(reporters.map(reporter => reporter.dispose().catch(e => DEBUG_LOGGER(e))));
    }

    static _disposeTestedApp(testedApp) {
        return testedApp ? testedApp.kill().catch(e => DEBUG_LOGGER(e)) : _pinkie2.default.resolve();
    }

    static _disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp) {
        return (0, _asyncToGenerator3.default)(function* () {
            task.abort();
            task.clearListeners();

            yield Runner._disposeAssets(browserSet, reporters, testedApp);
        })();
    }

    static _disposeAssets(browserSet, reporters, testedApp) {
        return _pinkie2.default.all([Runner._disposeBrowserSet(browserSet), Runner._disposeReporters(reporters), Runner._disposeTestedApp(testedApp)]);
    }

    _createCancelablePromise(taskPromise) {
        const promise = taskPromise.then(({ completionPromise }) => completionPromise);
        const removeFromPending = () => (0, _lodash.pull)(this.pendingTaskPromises, promise);

        promise.then(removeFromPending).catch(removeFromPending);

        promise.cancel = () => taskPromise.then(({ cancelTask }) => cancelTask()).then(removeFromPending);

        this.pendingTaskPromises.push(promise);
        return promise;
    }

    // Run task
    _getFailedTestCount(task, reporter) {
        let failedTestCount = reporter.testCount - reporter.passed;

        if (task.opts.stopOnFirstFail && !!failedTestCount) failedTestCount = 1;

        return failedTestCount;
    }

    _getTaskResult(task, browserSet, reporters, testedApp) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            task.on('browser-job-done', function (job) {
                return browserSet.releaseConnection(job.browserConnection);
            });

            const promises = [task.once('done'), (0, _promisifyEvent2.default)(browserSet, 'error')];

            if (testedApp) promises.push(testedApp.errorPromise);

            try {
                yield _pinkie2.default.race(promises);
            } catch (err) {
                yield Runner._disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp);

                throw err;
            }

            yield Runner._disposeAssets(browserSet, reporters, testedApp);

            return _this._getFailedTestCount(task, reporters[0]);
        })();
    }

    _runTask(reporterPlugins, browserSet, tests, testedApp) {
        let completed = false;
        const task = new _task2.default(tests, browserSet.browserConnectionGroups, this.proxy, this.opts);
        const reporters = reporterPlugins.map(reporter => new _reporter2.default(reporter.plugin, task, reporter.outStream));
        const completionPromise = this._getTaskResult(task, browserSet, reporters, testedApp);

        task.on('start', _handleErrors.startHandlingTestErrors);

        if (!this.opts.skipUncaughtErrors) {
            task.once('test-run-start', _handleErrors.addRunningTest);
            task.once('test-run-done', _handleErrors.removeRunningTest);
        }

        task.on('done', _handleErrors.stopHandlingTestErrors);

        const setCompleted = () => {
            completed = true;
        };

        completionPromise.then(setCompleted).catch(setCompleted);

        const cancelTask = (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* () {
                if (!completed) yield Runner._disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp);
            });

            return function cancelTask() {
                return _ref.apply(this, arguments);
            };
        })();

        return { completionPromise, cancelTask };
    }

    _registerAssets(assets) {
        assets.forEach(asset => this.proxy.GET(asset.path, asset.info));
    }

    _validateSpeedOption() {
        const speed = this.opts.speed;

        if (typeof speed !== 'number' || isNaN(speed) || speed < 0.01 || speed > 1) throw new _runtime.GeneralError(_message2.default.invalidSpeedValue);
    }

    _validateConcurrencyOption() {
        const concurrency = this.bootstrapper.concurrency;

        if (typeof concurrency !== 'number' || isNaN(concurrency) || concurrency < 1) throw new _runtime.GeneralError(_message2.default.invalidConcurrencyFactor);
    }

    _validateProxyBypassOption() {
        let proxyBypass = this.opts.proxyBypass;

        if (!proxyBypass) return;

        (0, _typeAssertions.assertType)([_typeAssertions.is.string, _typeAssertions.is.array], null, '"proxyBypass" argument', proxyBypass);

        if (typeof proxyBypass === 'string') proxyBypass = [proxyBypass];

        proxyBypass = proxyBypass.reduce((arr, rules) => {
            (0, _typeAssertions.assertType)(_typeAssertions.is.string, null, '"proxyBypass" argument', rules);

            return arr.concat(rules.split(','));
        }, []);

        this.opts.proxyBypass = proxyBypass;
    }

    _validateScreenshotOptions() {
        const screenshotPath = this.opts.screenshotPath;
        const screenshotPathPattern = this.opts.screenshotPathPattern;

        if (screenshotPath) {
            this._validateScreenshotPath(screenshotPath, 'screenshots base directory path');

            this.opts.screenshotPath = (0, _path.resolve)(screenshotPath);
        }

        if (screenshotPathPattern) this._validateScreenshotPath(screenshotPathPattern, 'screenshots path pattern');

        if (!screenshotPath && screenshotPathPattern) throw new _runtime.GeneralError(_message2.default.cantUseScreenshotPathPatternWithoutBaseScreenshotPathSpecified);
    }

    _validateRunOptions() {
        this._validateScreenshotOptions();
        this._validateSpeedOption();
        this._validateConcurrencyOption();
        this._validateProxyBypassOption();
    }

    _validateScreenshotPath(screenshotPath, pathType) {
        const forbiddenCharsList = (0, _checkFilePath2.default)(screenshotPath);

        if (forbiddenCharsList.length) throw new _runtime.GeneralError(_message2.default.forbiddenCharatersInScreenshotPath, screenshotPath, pathType, (0, _renderForbiddenCharsList2.default)(forbiddenCharsList));
    }

    // API
    embeddingOptions(opts) {
        this._registerAssets(opts.assets);
        this.opts.TestRunCtor = opts.TestRunCtor;

        return this;
    }

    src(...sources) {
        this.bootstrapper.sources = this.bootstrapper.sources.concat((0, _lodash.flattenDeep)(sources));

        return this;
    }

    browsers(...browsers) {
        this.bootstrapper.browsers = this.bootstrapper.browsers.concat((0, _lodash.flattenDeep)(browsers));

        return this;
    }

    concurrency(concurrency) {
        this.bootstrapper.concurrency = concurrency;

        return this;
    }

    reporter(name, outStream) {
        this.bootstrapper.reporters.push({
            name,
            outStream
        });

        return this;
    }

    filter(filter) {
        this.bootstrapper.filter = filter;

        return this;
    }

    useProxy(externalProxyHost, proxyBypass) {
        this.opts.externalProxyHost = externalProxyHost;
        this.opts.proxyBypass = proxyBypass;

        return this;
    }

    screenshots(path, takeOnFails = false, pattern = null) {
        this.opts.takeScreenshotsOnFails = takeOnFails;
        this.opts.screenshotPath = path;
        this.opts.screenshotPathPattern = pattern;

        return this;
    }

    startApp(command, initDelay) {
        this.bootstrapper.appCommand = command;
        this.bootstrapper.appInitDelay = initDelay;

        return this;
    }

    run({ skipJsErrors, disablePageReloads, quarantineMode, debugMode, selectorTimeout, assertionTimeout, pageLoadTimeout, speed = 1, debugOnFail, skipUncaughtErrors, stopOnFirstFail, disableTestSyntaxValidation } = {}) {
        this.opts.skipJsErrors = !!skipJsErrors;
        this.opts.disablePageReloads = !!disablePageReloads;
        this.opts.quarantineMode = !!quarantineMode;
        this.opts.debugMode = !!debugMode;
        this.opts.debugOnFail = !!debugOnFail;
        this.opts.selectorTimeout = selectorTimeout === void 0 ? DEFAULT_SELECTOR_TIMEOUT : selectorTimeout;
        this.opts.assertionTimeout = assertionTimeout === void 0 ? DEFAULT_ASSERTION_TIMEOUT : assertionTimeout;
        this.opts.pageLoadTimeout = pageLoadTimeout === void 0 ? DEFAULT_PAGE_LOAD_TIMEOUT : pageLoadTimeout;
        this.opts.speed = speed;
        this.opts.skipUncaughtErrors = !!skipUncaughtErrors;
        this.opts.stopOnFirstFail = !!stopOnFirstFail;

        this.bootstrapper.disableTestSyntaxValidation = disableTestSyntaxValidation;

        const runTaskPromise = _pinkie2.default.resolve().then(() => {
            this._validateRunOptions();

            return this.bootstrapper.createRunnableConfiguration();
        }).then(({ reporterPlugins, browserSet, tests, testedApp }) => {
            this.emit('done-bootstrapping');

            return this._runTask(reporterPlugins, browserSet, tests, testedApp);
        });

        return this._createCancelablePromise(runTaskPromise);
    }

    stop() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            // NOTE: When taskPromise is cancelled, it is removed from
            // the pendingTaskPromises array, which leads to shifting indexes
            // towards the beginning. So, we must copy the array in order to iterate it,
            // or we can perform iteration from the end to the beginning.
            const cancellationPromises = (0, _mapReverse2.default)(_this2.pendingTaskPromises, function (taskPromise) {
                return taskPromise.cancel();
            });

            yield _pinkie2.default.all(cancellationPromises);
        })();
    }
}
exports.default = Runner;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvaW5kZXguanMiXSwibmFtZXMiOlsiREVGQVVMVF9TRUxFQ1RPUl9USU1FT1VUIiwiREVGQVVMVF9BU1NFUlRJT05fVElNRU9VVCIsIkRFRkFVTFRfUEFHRV9MT0FEX1RJTUVPVVQiLCJERUJVR19MT0dHRVIiLCJSdW5uZXIiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsInByb3h5IiwiYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5Iiwib3B0aW9ucyIsImJvb3RzdHJhcHBlciIsIkJvb3RzdHJhcHBlciIsInBlbmRpbmdUYXNrUHJvbWlzZXMiLCJvcHRzIiwiZXh0ZXJuYWxQcm94eUhvc3QiLCJwcm94eUJ5cGFzcyIsInNjcmVlbnNob3RQYXRoIiwidGFrZVNjcmVlbnNob3RzT25GYWlscyIsInNjcmVlbnNob3RQYXRoUGF0dGVybiIsInNraXBKc0Vycm9ycyIsInF1YXJhbnRpbmVNb2RlIiwiZGVidWdNb2RlIiwicmV0cnlUZXN0UGFnZXMiLCJzZWxlY3RvclRpbWVvdXQiLCJwYWdlTG9hZFRpbWVvdXQiLCJfZGlzcG9zZUJyb3dzZXJTZXQiLCJicm93c2VyU2V0IiwiZGlzcG9zZSIsImNhdGNoIiwiZSIsIl9kaXNwb3NlUmVwb3J0ZXJzIiwicmVwb3J0ZXJzIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsInJlcG9ydGVyIiwiX2Rpc3Bvc2VUZXN0ZWRBcHAiLCJ0ZXN0ZWRBcHAiLCJraWxsIiwicmVzb2x2ZSIsIl9kaXNwb3NlVGFza0FuZFJlbGF0ZWRBc3NldHMiLCJ0YXNrIiwiYWJvcnQiLCJjbGVhckxpc3RlbmVycyIsIl9kaXNwb3NlQXNzZXRzIiwiX2NyZWF0ZUNhbmNlbGFibGVQcm9taXNlIiwidGFza1Byb21pc2UiLCJwcm9taXNlIiwidGhlbiIsImNvbXBsZXRpb25Qcm9taXNlIiwicmVtb3ZlRnJvbVBlbmRpbmciLCJjYW5jZWwiLCJjYW5jZWxUYXNrIiwicHVzaCIsIl9nZXRGYWlsZWRUZXN0Q291bnQiLCJmYWlsZWRUZXN0Q291bnQiLCJ0ZXN0Q291bnQiLCJwYXNzZWQiLCJzdG9wT25GaXJzdEZhaWwiLCJfZ2V0VGFza1Jlc3VsdCIsIm9uIiwicmVsZWFzZUNvbm5lY3Rpb24iLCJqb2IiLCJicm93c2VyQ29ubmVjdGlvbiIsInByb21pc2VzIiwib25jZSIsImVycm9yUHJvbWlzZSIsInJhY2UiLCJlcnIiLCJfcnVuVGFzayIsInJlcG9ydGVyUGx1Z2lucyIsInRlc3RzIiwiY29tcGxldGVkIiwiVGFzayIsImJyb3dzZXJDb25uZWN0aW9uR3JvdXBzIiwiUmVwb3J0ZXIiLCJwbHVnaW4iLCJvdXRTdHJlYW0iLCJzdGFydEhhbmRsaW5nVGVzdEVycm9ycyIsInNraXBVbmNhdWdodEVycm9ycyIsImFkZFJ1bm5pbmdUZXN0IiwicmVtb3ZlUnVubmluZ1Rlc3QiLCJzdG9wSGFuZGxpbmdUZXN0RXJyb3JzIiwic2V0Q29tcGxldGVkIiwiX3JlZ2lzdGVyQXNzZXRzIiwiYXNzZXRzIiwiZm9yRWFjaCIsImFzc2V0IiwiR0VUIiwicGF0aCIsImluZm8iLCJfdmFsaWRhdGVTcGVlZE9wdGlvbiIsInNwZWVkIiwiaXNOYU4iLCJHZW5lcmFsRXJyb3IiLCJNRVNTQUdFIiwiaW52YWxpZFNwZWVkVmFsdWUiLCJfdmFsaWRhdGVDb25jdXJyZW5jeU9wdGlvbiIsImNvbmN1cnJlbmN5IiwiaW52YWxpZENvbmN1cnJlbmN5RmFjdG9yIiwiX3ZhbGlkYXRlUHJveHlCeXBhc3NPcHRpb24iLCJpcyIsInN0cmluZyIsImFycmF5IiwicmVkdWNlIiwiYXJyIiwicnVsZXMiLCJjb25jYXQiLCJzcGxpdCIsIl92YWxpZGF0ZVNjcmVlbnNob3RPcHRpb25zIiwiX3ZhbGlkYXRlU2NyZWVuc2hvdFBhdGgiLCJjYW50VXNlU2NyZWVuc2hvdFBhdGhQYXR0ZXJuV2l0aG91dEJhc2VTY3JlZW5zaG90UGF0aFNwZWNpZmllZCIsIl92YWxpZGF0ZVJ1bk9wdGlvbnMiLCJwYXRoVHlwZSIsImZvcmJpZGRlbkNoYXJzTGlzdCIsImxlbmd0aCIsImZvcmJpZGRlbkNoYXJhdGVyc0luU2NyZWVuc2hvdFBhdGgiLCJlbWJlZGRpbmdPcHRpb25zIiwiVGVzdFJ1bkN0b3IiLCJzcmMiLCJzb3VyY2VzIiwiYnJvd3NlcnMiLCJuYW1lIiwiZmlsdGVyIiwidXNlUHJveHkiLCJzY3JlZW5zaG90cyIsInRha2VPbkZhaWxzIiwicGF0dGVybiIsInN0YXJ0QXBwIiwiY29tbWFuZCIsImluaXREZWxheSIsImFwcENvbW1hbmQiLCJhcHBJbml0RGVsYXkiLCJydW4iLCJkaXNhYmxlUGFnZVJlbG9hZHMiLCJhc3NlcnRpb25UaW1lb3V0IiwiZGVidWdPbkZhaWwiLCJkaXNhYmxlVGVzdFN5bnRheFZhbGlkYXRpb24iLCJydW5UYXNrUHJvbWlzZSIsImNyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbiIsImVtaXQiLCJzdG9wIiwiY2FuY2VsbGF0aW9uUHJvbWlzZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUdBLE1BQU1BLDJCQUE0QixLQUFsQztBQUNBLE1BQU1DLDRCQUE0QixJQUFsQztBQUNBLE1BQU1DLDRCQUE0QixJQUFsQzs7QUFFQSxNQUFNQyxlQUFlLHFCQUFNLGlCQUFOLENBQXJCOztBQUVlLE1BQU1DLE1BQU4sU0FBcUJDLG9CQUFyQixDQUFrQztBQUM3Q0MsZ0JBQWFDLEtBQWIsRUFBb0JDLHdCQUFwQixFQUE4Q0MsVUFBVSxFQUF4RCxFQUE0RDtBQUN4RDs7QUFFQSxhQUFLRixLQUFMLEdBQTJCQSxLQUEzQjtBQUNBLGFBQUtHLFlBQUwsR0FBMkIsSUFBSUMsc0JBQUosQ0FBaUJILHdCQUFqQixDQUEzQjtBQUNBLGFBQUtJLG1CQUFMLEdBQTJCLEVBQTNCOztBQUVBLGFBQUtDLElBQUwsR0FBWTtBQUNSQywrQkFBd0IsSUFEaEI7QUFF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QUFFQSxjQUFNQyxpQkFBaUIxRyxpQkFBUU8sT0FBUixHQUNsQlMsSUFEa0IsQ0FDYixNQUFNO0FBQ1IsaUJBQUtnRSxtQkFBTDs7QUFFQSxtQkFBTyxLQUFLdEcsWUFBTCxDQUFrQmlJLDJCQUFsQixFQUFQO0FBQ0gsU0FMa0IsRUFNbEIzRixJQU5rQixDQU1iLENBQUMsRUFBRXNCLGVBQUYsRUFBbUI1QyxVQUFuQixFQUErQjZDLEtBQS9CLEVBQXNDbEMsU0FBdEMsRUFBRCxLQUF1RDtBQUN6RCxpQkFBS3VHLElBQUwsQ0FBVSxvQkFBVjs7QUFFQSxtQkFBTyxLQUFLdkUsUUFBTCxDQUFjQyxlQUFkLEVBQStCNUMsVUFBL0IsRUFBMkM2QyxLQUEzQyxFQUFrRGxDLFNBQWxELENBQVA7QUFDSCxTQVZrQixDQUF2Qjs7QUFZQSxlQUFPLEtBQUtRLHdCQUFMLENBQThCNkYsY0FBOUIsQ0FBUDtBQUNIOztBQUVLRyxRQUFOLEdBQWM7QUFBQTs7QUFBQTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0JBQU1DLHVCQUF1QiwwQkFBVyxPQUFLbEksbUJBQWhCLEVBQXFDO0FBQUEsdUJBQWVrQyxZQUFZSyxNQUFaLEVBQWY7QUFBQSxhQUFyQyxDQUE3Qjs7QUFFQSxrQkFBTW5CLGlCQUFRQyxHQUFSLENBQVk2RyxvQkFBWixDQUFOO0FBUFU7QUFRYjtBQS9TNEM7a0JBQTVCMUksTSIsImZpbGUiOiJydW5uZXIvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZXNvbHZlIGFzIHJlc29sdmVQYXRoIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCBwcm9taXNpZnlFdmVudCBmcm9tICdwcm9taXNpZnktZXZlbnQnO1xuaW1wb3J0IG1hcFJldmVyc2UgZnJvbSAnbWFwLXJldmVyc2UnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGZsYXR0ZW5EZWVwIGFzIGZsYXR0ZW4sIHB1bGwgYXMgcmVtb3ZlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCb290c3RyYXBwZXIgZnJvbSAnLi9ib290c3RyYXBwZXInO1xuaW1wb3J0IFJlcG9ydGVyIGZyb20gJy4uL3JlcG9ydGVyJztcbmltcG9ydCBUYXNrIGZyb20gJy4vdGFzayc7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgTUVTU0FHRSBmcm9tICcuLi9lcnJvcnMvcnVudGltZS9tZXNzYWdlJztcbmltcG9ydCB7IGFzc2VydFR5cGUsIGlzIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUvdHlwZS1hc3NlcnRpb25zJztcbmltcG9ydCByZW5kZXJGb3JiaWRkZW5DaGFyc0xpc3QgZnJvbSAnLi4vZXJyb3JzL3JlbmRlci1mb3JiaWRkZW4tY2hhcnMtbGlzdCc7XG5pbXBvcnQgY2hlY2tGaWxlUGF0aCBmcm9tICcuLi91dGlscy9jaGVjay1maWxlLXBhdGgnO1xuaW1wb3J0IHsgYWRkUnVubmluZ1Rlc3QsIHJlbW92ZVJ1bm5pbmdUZXN0LCBzdGFydEhhbmRsaW5nVGVzdEVycm9ycywgc3RvcEhhbmRsaW5nVGVzdEVycm9ycyB9IGZyb20gJy4uL3V0aWxzL2hhbmRsZS1lcnJvcnMnO1xuXG5cbmNvbnN0IERFRkFVTFRfU0VMRUNUT1JfVElNRU9VVCAgPSAxMDAwMDtcbmNvbnN0IERFRkFVTFRfQVNTRVJUSU9OX1RJTUVPVVQgPSAzMDAwO1xuY29uc3QgREVGQVVMVF9QQUdFX0xPQURfVElNRU9VVCA9IDMwMDA7XG5cbmNvbnN0IERFQlVHX0xPR0dFUiA9IGRlYnVnKCd0ZXN0Y2FmZTpydW5uZXInKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUnVubmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAocHJveHksIGJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSwgb3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5wcm94eSAgICAgICAgICAgICAgID0gcHJveHk7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyICAgICAgICA9IG5ldyBCb290c3RyYXBwZXIoYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5KTtcbiAgICAgICAgdGhpcy5wZW5kaW5nVGFza1Byb21pc2VzID0gW107XG5cbiAgICAgICAgdGhpcy5vcHRzID0ge1xuICAgICAgICAgICAgZXh0ZXJuYWxQcm94eUhvc3Q6ICAgICAgbnVsbCxcbiAgICAgICAgICAgIHByb3h5QnlwYXNzOiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aDogICAgICAgICBudWxsLFxuICAgICAgICAgICAgdGFrZVNjcmVlbnNob3RzT25GYWlsczogZmFsc2UsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aFBhdHRlcm46ICBudWxsLFxuICAgICAgICAgICAgc2tpcEpzRXJyb3JzOiAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICBxdWFyYW50aW5lTW9kZTogICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGRlYnVnTW9kZTogICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgcmV0cnlUZXN0UGFnZXM6ICAgICAgICAgb3B0aW9ucy5yZXRyeVRlc3RQYWdlcyxcbiAgICAgICAgICAgIHNlbGVjdG9yVGltZW91dDogICAgICAgIERFRkFVTFRfU0VMRUNUT1JfVElNRU9VVCxcbiAgICAgICAgICAgIHBhZ2VMb2FkVGltZW91dDogICAgICAgIERFRkFVTFRfUEFHRV9MT0FEX1RJTUVPVVRcbiAgICAgICAgfTtcbiAgICB9XG5cblxuICAgIHN0YXRpYyBfZGlzcG9zZUJyb3dzZXJTZXQgKGJyb3dzZXJTZXQpIHtcbiAgICAgICAgcmV0dXJuIGJyb3dzZXJTZXQuZGlzcG9zZSgpLmNhdGNoKGUgPT4gREVCVUdfTE9HR0VSKGUpKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2Rpc3Bvc2VSZXBvcnRlcnMgKHJlcG9ydGVycykge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVwb3J0ZXJzLm1hcChyZXBvcnRlciA9PiByZXBvcnRlci5kaXNwb3NlKCkuY2F0Y2goZSA9PiBERUJVR19MT0dHRVIoZSkpKSk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9kaXNwb3NlVGVzdGVkQXBwICh0ZXN0ZWRBcHApIHtcbiAgICAgICAgcmV0dXJuIHRlc3RlZEFwcCA/IHRlc3RlZEFwcC5raWxsKCkuY2F0Y2goZSA9PiBERUJVR19MT0dHRVIoZSkpIDogUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIF9kaXNwb3NlVGFza0FuZFJlbGF0ZWRBc3NldHMgKHRhc2ssIGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKSB7XG4gICAgICAgIHRhc2suYWJvcnQoKTtcbiAgICAgICAgdGFzay5jbGVhckxpc3RlbmVycygpO1xuXG4gICAgICAgIGF3YWl0IFJ1bm5lci5fZGlzcG9zZUFzc2V0cyhicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9kaXNwb3NlQXNzZXRzIChicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgUnVubmVyLl9kaXNwb3NlQnJvd3NlclNldChicm93c2VyU2V0KSxcbiAgICAgICAgICAgIFJ1bm5lci5fZGlzcG9zZVJlcG9ydGVycyhyZXBvcnRlcnMpLFxuICAgICAgICAgICAgUnVubmVyLl9kaXNwb3NlVGVzdGVkQXBwKHRlc3RlZEFwcClcbiAgICAgICAgXSk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZUNhbmNlbGFibGVQcm9taXNlICh0YXNrUHJvbWlzZSkge1xuICAgICAgICBjb25zdCBwcm9taXNlICAgICAgICAgICA9IHRhc2tQcm9taXNlLnRoZW4oKHsgY29tcGxldGlvblByb21pc2UgfSkgPT4gY29tcGxldGlvblByb21pc2UpO1xuICAgICAgICBjb25zdCByZW1vdmVGcm9tUGVuZGluZyA9ICgpID0+IHJlbW92ZSh0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMsIHByb21pc2UpO1xuXG4gICAgICAgIHByb21pc2VcbiAgICAgICAgICAgIC50aGVuKHJlbW92ZUZyb21QZW5kaW5nKVxuICAgICAgICAgICAgLmNhdGNoKHJlbW92ZUZyb21QZW5kaW5nKTtcblxuICAgICAgICBwcm9taXNlLmNhbmNlbCA9ICgpID0+IHRhc2tQcm9taXNlXG4gICAgICAgICAgICAudGhlbigoeyBjYW5jZWxUYXNrIH0pID0+IGNhbmNlbFRhc2soKSlcbiAgICAgICAgICAgIC50aGVuKHJlbW92ZUZyb21QZW5kaW5nKTtcblxuICAgICAgICB0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMucHVzaChwcm9taXNlKTtcbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgfVxuXG4gICAgLy8gUnVuIHRhc2tcbiAgICBfZ2V0RmFpbGVkVGVzdENvdW50ICh0YXNrLCByZXBvcnRlcikge1xuICAgICAgICBsZXQgZmFpbGVkVGVzdENvdW50ID0gcmVwb3J0ZXIudGVzdENvdW50IC0gcmVwb3J0ZXIucGFzc2VkO1xuXG4gICAgICAgIGlmICh0YXNrLm9wdHMuc3RvcE9uRmlyc3RGYWlsICYmICEhZmFpbGVkVGVzdENvdW50KVxuICAgICAgICAgICAgZmFpbGVkVGVzdENvdW50ID0gMTtcblxuICAgICAgICByZXR1cm4gZmFpbGVkVGVzdENvdW50O1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRUYXNrUmVzdWx0ICh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCkge1xuICAgICAgICB0YXNrLm9uKCdicm93c2VyLWpvYi1kb25lJywgam9iID0+IGJyb3dzZXJTZXQucmVsZWFzZUNvbm5lY3Rpb24oam9iLmJyb3dzZXJDb25uZWN0aW9uKSk7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXG4gICAgICAgICAgICB0YXNrLm9uY2UoJ2RvbmUnKSxcbiAgICAgICAgICAgIHByb21pc2lmeUV2ZW50KGJyb3dzZXJTZXQsICdlcnJvcicpXG4gICAgICAgIF07XG5cbiAgICAgICAgaWYgKHRlc3RlZEFwcClcbiAgICAgICAgICAgIHByb21pc2VzLnB1c2godGVzdGVkQXBwLmVycm9yUHJvbWlzZSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IFByb21pc2UucmFjZShwcm9taXNlcyk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgYXdhaXQgUnVubmVyLl9kaXNwb3NlVGFza0FuZFJlbGF0ZWRBc3NldHModGFzaywgYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApO1xuXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBSdW5uZXIuX2Rpc3Bvc2VBc3NldHMoYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRGYWlsZWRUZXN0Q291bnQodGFzaywgcmVwb3J0ZXJzWzBdKTtcbiAgICB9XG5cbiAgICBfcnVuVGFzayAocmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwKSB7XG4gICAgICAgIGxldCBjb21wbGV0ZWQgICAgICAgICAgID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IHRhc2sgICAgICAgICAgICAgID0gbmV3IFRhc2sodGVzdHMsIGJyb3dzZXJTZXQuYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMsIHRoaXMucHJveHksIHRoaXMub3B0cyk7XG4gICAgICAgIGNvbnN0IHJlcG9ydGVycyAgICAgICAgID0gcmVwb3J0ZXJQbHVnaW5zLm1hcChyZXBvcnRlciA9PiBuZXcgUmVwb3J0ZXIocmVwb3J0ZXIucGx1Z2luLCB0YXNrLCByZXBvcnRlci5vdXRTdHJlYW0pKTtcbiAgICAgICAgY29uc3QgY29tcGxldGlvblByb21pc2UgPSB0aGlzLl9nZXRUYXNrUmVzdWx0KHRhc2ssIGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKTtcblxuICAgICAgICB0YXNrLm9uKCdzdGFydCcsIHN0YXJ0SGFuZGxpbmdUZXN0RXJyb3JzKTtcblxuICAgICAgICBpZiAoIXRoaXMub3B0cy5za2lwVW5jYXVnaHRFcnJvcnMpIHtcbiAgICAgICAgICAgIHRhc2sub25jZSgndGVzdC1ydW4tc3RhcnQnLCBhZGRSdW5uaW5nVGVzdCk7XG4gICAgICAgICAgICB0YXNrLm9uY2UoJ3Rlc3QtcnVuLWRvbmUnLCByZW1vdmVSdW5uaW5nVGVzdCk7XG4gICAgICAgIH1cblxuICAgICAgICB0YXNrLm9uKCdkb25lJywgc3RvcEhhbmRsaW5nVGVzdEVycm9ycyk7XG5cbiAgICAgICAgY29uc3Qgc2V0Q29tcGxldGVkID0gKCkgPT4ge1xuICAgICAgICAgICAgY29tcGxldGVkID0gdHJ1ZTtcbiAgICAgICAgfTtcblxuICAgICAgICBjb21wbGV0aW9uUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oc2V0Q29tcGxldGVkKVxuICAgICAgICAgICAgLmNhdGNoKHNldENvbXBsZXRlZCk7XG5cbiAgICAgICAgY29uc3QgY2FuY2VsVGFzayA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGlmICghY29tcGxldGVkKVxuICAgICAgICAgICAgICAgIGF3YWl0IFJ1bm5lci5fZGlzcG9zZVRhc2tBbmRSZWxhdGVkQXNzZXRzKHRhc2ssIGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKTtcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4geyBjb21wbGV0aW9uUHJvbWlzZSwgY2FuY2VsVGFzayB9O1xuICAgIH1cblxuICAgIF9yZWdpc3RlckFzc2V0cyAoYXNzZXRzKSB7XG4gICAgICAgIGFzc2V0cy5mb3JFYWNoKGFzc2V0ID0+IHRoaXMucHJveHkuR0VUKGFzc2V0LnBhdGgsIGFzc2V0LmluZm8pKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVTcGVlZE9wdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy5vcHRzLnNwZWVkO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgIT09ICdudW1iZXInIHx8IGlzTmFOKHNwZWVkKSB8fCBzcGVlZCA8IDAuMDEgfHwgc3BlZWQgPiAxKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmludmFsaWRTcGVlZFZhbHVlKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVDb25jdXJyZW5jeU9wdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IGNvbmN1cnJlbmN5ID0gdGhpcy5ib290c3RyYXBwZXIuY29uY3VycmVuY3k7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBjb25jdXJyZW5jeSAhPT0gJ251bWJlcicgfHwgaXNOYU4oY29uY3VycmVuY3kpIHx8IGNvbmN1cnJlbmN5IDwgMSlcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5pbnZhbGlkQ29uY3VycmVuY3lGYWN0b3IpO1xuICAgIH1cblxuICAgIF92YWxpZGF0ZVByb3h5QnlwYXNzT3B0aW9uICgpIHtcbiAgICAgICAgbGV0IHByb3h5QnlwYXNzID0gdGhpcy5vcHRzLnByb3h5QnlwYXNzO1xuXG4gICAgICAgIGlmICghcHJveHlCeXBhc3MpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgYXNzZXJ0VHlwZShbIGlzLnN0cmluZywgaXMuYXJyYXkgXSwgbnVsbCwgJ1wicHJveHlCeXBhc3NcIiBhcmd1bWVudCcsIHByb3h5QnlwYXNzKTtcblxuICAgICAgICBpZiAodHlwZW9mIHByb3h5QnlwYXNzID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgIHByb3h5QnlwYXNzID0gW3Byb3h5QnlwYXNzXTtcblxuICAgICAgICBwcm94eUJ5cGFzcyA9IHByb3h5QnlwYXNzLnJlZHVjZSgoYXJyLCBydWxlcykgPT4ge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5zdHJpbmcsIG51bGwsICdcInByb3h5QnlwYXNzXCIgYXJndW1lbnQnLCBydWxlcyk7XG5cbiAgICAgICAgICAgIHJldHVybiBhcnIuY29uY2F0KHJ1bGVzLnNwbGl0KCcsJykpO1xuICAgICAgICB9LCBbXSk7XG5cbiAgICAgICAgdGhpcy5vcHRzLnByb3h5QnlwYXNzID0gcHJveHlCeXBhc3M7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlU2NyZWVuc2hvdE9wdGlvbnMgKCkge1xuICAgICAgICBjb25zdCBzY3JlZW5zaG90UGF0aCAgICAgICAgPSB0aGlzLm9wdHMuc2NyZWVuc2hvdFBhdGg7XG4gICAgICAgIGNvbnN0IHNjcmVlbnNob3RQYXRoUGF0dGVybiA9IHRoaXMub3B0cy5zY3JlZW5zaG90UGF0aFBhdHRlcm47XG5cbiAgICAgICAgaWYgKHNjcmVlbnNob3RQYXRoKSB7XG4gICAgICAgICAgICB0aGlzLl92YWxpZGF0ZVNjcmVlbnNob3RQYXRoKHNjcmVlbnNob3RQYXRoLCAnc2NyZWVuc2hvdHMgYmFzZSBkaXJlY3RvcnkgcGF0aCcpO1xuXG4gICAgICAgICAgICB0aGlzLm9wdHMuc2NyZWVuc2hvdFBhdGggPSByZXNvbHZlUGF0aChzY3JlZW5zaG90UGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2NyZWVuc2hvdFBhdGhQYXR0ZXJuKVxuICAgICAgICAgICAgdGhpcy5fdmFsaWRhdGVTY3JlZW5zaG90UGF0aChzY3JlZW5zaG90UGF0aFBhdHRlcm4sICdzY3JlZW5zaG90cyBwYXRoIHBhdHRlcm4nKTtcblxuICAgICAgICBpZiAoIXNjcmVlbnNob3RQYXRoICYmIHNjcmVlbnNob3RQYXRoUGF0dGVybilcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5jYW50VXNlU2NyZWVuc2hvdFBhdGhQYXR0ZXJuV2l0aG91dEJhc2VTY3JlZW5zaG90UGF0aFNwZWNpZmllZCk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlUnVuT3B0aW9ucyAoKSB7XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRlU2NyZWVuc2hvdE9wdGlvbnMoKTtcbiAgICAgICAgdGhpcy5fdmFsaWRhdGVTcGVlZE9wdGlvbigpO1xuICAgICAgICB0aGlzLl92YWxpZGF0ZUNvbmN1cnJlbmN5T3B0aW9uKCk7XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRlUHJveHlCeXBhc3NPcHRpb24oKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVTY3JlZW5zaG90UGF0aCAoc2NyZWVuc2hvdFBhdGgsIHBhdGhUeXBlKSB7XG4gICAgICAgIGNvbnN0IGZvcmJpZGRlbkNoYXJzTGlzdCA9IGNoZWNrRmlsZVBhdGgoc2NyZWVuc2hvdFBhdGgpO1xuXG4gICAgICAgIGlmIChmb3JiaWRkZW5DaGFyc0xpc3QubGVuZ3RoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmZvcmJpZGRlbkNoYXJhdGVyc0luU2NyZWVuc2hvdFBhdGgsIHNjcmVlbnNob3RQYXRoLCBwYXRoVHlwZSwgcmVuZGVyRm9yYmlkZGVuQ2hhcnNMaXN0KGZvcmJpZGRlbkNoYXJzTGlzdCkpO1xuICAgIH1cblxuICAgIC8vIEFQSVxuICAgIGVtYmVkZGluZ09wdGlvbnMgKG9wdHMpIHtcbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJBc3NldHMob3B0cy5hc3NldHMpO1xuICAgICAgICB0aGlzLm9wdHMuVGVzdFJ1bkN0b3IgPSBvcHRzLlRlc3RSdW5DdG9yO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNyYyAoLi4uc291cmNlcykge1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5zb3VyY2VzID0gdGhpcy5ib290c3RyYXBwZXIuc291cmNlcy5jb25jYXQoZmxhdHRlbihzb3VyY2VzKSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYnJvd3NlcnMgKC4uLmJyb3dzZXJzKSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmJyb3dzZXJzID0gdGhpcy5ib290c3RyYXBwZXIuYnJvd3NlcnMuY29uY2F0KGZsYXR0ZW4oYnJvd3NlcnMpKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBjb25jdXJyZW5jeSAoY29uY3VycmVuY3kpIHtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuY29uY3VycmVuY3kgPSBjb25jdXJyZW5jeTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICByZXBvcnRlciAobmFtZSwgb3V0U3RyZWFtKSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLnJlcG9ydGVycy5wdXNoKHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICBvdXRTdHJlYW1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZmlsdGVyIChmaWx0ZXIpIHtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuZmlsdGVyID0gZmlsdGVyO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHVzZVByb3h5IChleHRlcm5hbFByb3h5SG9zdCwgcHJveHlCeXBhc3MpIHtcbiAgICAgICAgdGhpcy5vcHRzLmV4dGVybmFsUHJveHlIb3N0ID0gZXh0ZXJuYWxQcm94eUhvc3Q7XG4gICAgICAgIHRoaXMub3B0cy5wcm94eUJ5cGFzcyAgICAgICA9IHByb3h5QnlwYXNzO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNjcmVlbnNob3RzIChwYXRoLCB0YWtlT25GYWlscyA9IGZhbHNlLCBwYXR0ZXJuID0gbnVsbCkge1xuICAgICAgICB0aGlzLm9wdHMudGFrZVNjcmVlbnNob3RzT25GYWlscyA9IHRha2VPbkZhaWxzO1xuICAgICAgICB0aGlzLm9wdHMuc2NyZWVuc2hvdFBhdGggICAgICAgICA9IHBhdGg7XG4gICAgICAgIHRoaXMub3B0cy5zY3JlZW5zaG90UGF0aFBhdHRlcm4gID0gcGF0dGVybjtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBzdGFydEFwcCAoY29tbWFuZCwgaW5pdERlbGF5KSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmFwcENvbW1hbmQgICA9IGNvbW1hbmQ7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmFwcEluaXREZWxheSA9IGluaXREZWxheTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBydW4gKHsgc2tpcEpzRXJyb3JzLCBkaXNhYmxlUGFnZVJlbG9hZHMsIHF1YXJhbnRpbmVNb2RlLCBkZWJ1Z01vZGUsIHNlbGVjdG9yVGltZW91dCwgYXNzZXJ0aW9uVGltZW91dCwgcGFnZUxvYWRUaW1lb3V0LCBzcGVlZCA9IDEsIGRlYnVnT25GYWlsLCBza2lwVW5jYXVnaHRFcnJvcnMsIHN0b3BPbkZpcnN0RmFpbCwgZGlzYWJsZVRlc3RTeW50YXhWYWxpZGF0aW9uIH0gPSB7fSkge1xuICAgICAgICB0aGlzLm9wdHMuc2tpcEpzRXJyb3JzICAgICAgID0gISFza2lwSnNFcnJvcnM7XG4gICAgICAgIHRoaXMub3B0cy5kaXNhYmxlUGFnZVJlbG9hZHMgPSAhIWRpc2FibGVQYWdlUmVsb2FkcztcbiAgICAgICAgdGhpcy5vcHRzLnF1YXJhbnRpbmVNb2RlICAgICA9ICEhcXVhcmFudGluZU1vZGU7XG4gICAgICAgIHRoaXMub3B0cy5kZWJ1Z01vZGUgICAgICAgICAgPSAhIWRlYnVnTW9kZTtcbiAgICAgICAgdGhpcy5vcHRzLmRlYnVnT25GYWlsICAgICAgICA9ICEhZGVidWdPbkZhaWw7XG4gICAgICAgIHRoaXMub3B0cy5zZWxlY3RvclRpbWVvdXQgICAgPSBzZWxlY3RvclRpbWVvdXQgPT09IHZvaWQgMCA/IERFRkFVTFRfU0VMRUNUT1JfVElNRU9VVCA6IHNlbGVjdG9yVGltZW91dDtcbiAgICAgICAgdGhpcy5vcHRzLmFzc2VydGlvblRpbWVvdXQgICA9IGFzc2VydGlvblRpbWVvdXQgPT09IHZvaWQgMCA/IERFRkFVTFRfQVNTRVJUSU9OX1RJTUVPVVQgOiBhc3NlcnRpb25UaW1lb3V0O1xuICAgICAgICB0aGlzLm9wdHMucGFnZUxvYWRUaW1lb3V0ICAgID0gcGFnZUxvYWRUaW1lb3V0ID09PSB2b2lkIDAgPyBERUZBVUxUX1BBR0VfTE9BRF9USU1FT1VUIDogcGFnZUxvYWRUaW1lb3V0O1xuICAgICAgICB0aGlzLm9wdHMuc3BlZWQgICAgICAgICAgICAgID0gc3BlZWQ7XG4gICAgICAgIHRoaXMub3B0cy5za2lwVW5jYXVnaHRFcnJvcnMgPSAhIXNraXBVbmNhdWdodEVycm9ycztcbiAgICAgICAgdGhpcy5vcHRzLnN0b3BPbkZpcnN0RmFpbCAgICA9ICEhc3RvcE9uRmlyc3RGYWlsO1xuXG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmRpc2FibGVUZXN0U3ludGF4VmFsaWRhdGlvbiA9IGRpc2FibGVUZXN0U3ludGF4VmFsaWRhdGlvbjtcblxuICAgICAgICBjb25zdCBydW5UYXNrUHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdmFsaWRhdGVSdW5PcHRpb25zKCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ib290c3RyYXBwZXIuY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uKCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKHsgcmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwIH0pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2RvbmUtYm9vdHN0cmFwcGluZycpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3J1blRhc2socmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVDYW5jZWxhYmxlUHJvbWlzZShydW5UYXNrUHJvbWlzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcCAoKSB7XG4gICAgICAgIC8vIE5PVEU6IFdoZW4gdGFza1Byb21pc2UgaXMgY2FuY2VsbGVkLCBpdCBpcyByZW1vdmVkIGZyb21cbiAgICAgICAgLy8gdGhlIHBlbmRpbmdUYXNrUHJvbWlzZXMgYXJyYXksIHdoaWNoIGxlYWRzIHRvIHNoaWZ0aW5nIGluZGV4ZXNcbiAgICAgICAgLy8gdG93YXJkcyB0aGUgYmVnaW5uaW5nLiBTbywgd2UgbXVzdCBjb3B5IHRoZSBhcnJheSBpbiBvcmRlciB0byBpdGVyYXRlIGl0LFxuICAgICAgICAvLyBvciB3ZSBjYW4gcGVyZm9ybSBpdGVyYXRpb24gZnJvbSB0aGUgZW5kIHRvIHRoZSBiZWdpbm5pbmcuXG4gICAgICAgIGNvbnN0IGNhbmNlbGxhdGlvblByb21pc2VzID0gbWFwUmV2ZXJzZSh0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMsIHRhc2tQcm9taXNlID0+IHRhc2tQcm9taXNlLmNhbmNlbCgpKTtcblxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChjYW5jZWxsYXRpb25Qcm9taXNlcyk7XG4gICAgfVxufVxuIl19
