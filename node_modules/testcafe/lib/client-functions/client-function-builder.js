'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _lodash = require('lodash');

var _testRunTracker = require('../api/test-run-tracker');

var _testRunTracker2 = _interopRequireDefault(_testRunTracker);

var _builderSymbol = require('./builder-symbol');

var _builderSymbol2 = _interopRequireDefault(_builderSymbol);

var _replicator = require('./replicator');

var _observation = require('../test-run/commands/observation');

var _compileClientFunction = require('../compiler/compile-client-function');

var _compileClientFunction2 = _interopRequireDefault(_compileClientFunction);

var _runtime = require('../errors/runtime');

var _typeAssertions = require('../errors/runtime/type-assertions');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _getCallsite = require('../errors/get-callsite');

var _reExecutablePromise = require('../utils/re-executable-promise');

var _reExecutablePromise2 = _interopRequireDefault(_reExecutablePromise);

var _markerSymbol = require('../test-run/marker-symbol');

var _markerSymbol2 = _interopRequireDefault(_markerSymbol);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_EXECUTION_CALLSITE_NAME = '__$$clientFunction$$';

class ClientFunctionBuilder {
    constructor(fn, options, callsiteNames = {}) {
        this.callsiteNames = {
            instantiation: callsiteNames.instantiation,
            execution: callsiteNames.execution || DEFAULT_EXECUTION_CALLSITE_NAME
        };

        if ((0, _lodash.isNil)(options)) options = {};

        this._validateOptions(options);

        this.fn = fn;
        this.options = options;
        this.compiledFnCode = this._getCompiledFnCode();

        if (!this.compiledFnCode) throw this._createInvalidFnTypeError();

        this.replicator = (0, _replicator.createReplicator)(this._getReplicatorTransforms());
    }

    _decorateFunction(clientFn) {
        clientFn[_builderSymbol2.default] = this;

        clientFn.with = options => {
            if (typeof options === 'object') options = (0, _lodash.assign)({}, this.options, options);

            const builder = new this.constructor(this.fn, options, {
                instantiation: 'with',
                execution: this.callsiteNames.execution
            });

            return builder.getFunction();
        };
    }

    getBoundTestRun() {
        // NOTE: `boundTestRun` can be either TestController or TestRun instance.
        if (this.options.boundTestRun) return this.options.boundTestRun.testRun || this.options.boundTestRun;

        return null;
    }

    _getTestRun() {
        return this.getBoundTestRun() || _testRunTracker2.default.resolveContextTestRun();
    }

    getFunction() {
        const builder = this;

        const clientFn = function __$$clientFunction$$() {
            const testRun = builder._getTestRun();
            const callsite = (0, _getCallsite.getCallsiteForMethod)(builder.callsiteNames.execution);
            const args = [];

            // OPTIMIZATION: don't leak `arguments` object.
            for (let i = 0; i < arguments.length; i++) args.push(arguments[i]);

            return builder._executeCommand(args, testRun, callsite);
        };

        this._decorateFunction(clientFn);

        return clientFn;
    }

    getCommand(args) {
        const encodedArgs = this.replicator.encode(args);
        const encodedDependencies = this.replicator.encode(this.getFunctionDependencies());

        return this._createTestRunCommand(encodedArgs, encodedDependencies);
    }

    // Overridable methods
    getFunctionDependencies() {
        return this.options.dependencies || {};
    }

    _createTestRunCommand(encodedArgs, encodedDependencies) {
        return new _observation.ExecuteClientFunctionCommand({
            instantiationCallsiteName: this.callsiteNames.instantiation,
            fnCode: this.compiledFnCode,
            args: encodedArgs,
            dependencies: encodedDependencies
        }, this._getTestRun());
    }

    _getCompiledFnCode() {
        if (typeof this.fn === 'function') return (0, _compileClientFunction2.default)(this.fn.toString(), this.options.dependencies, this.callsiteNames.instantiation, this.callsiteNames.instantiation);

        return null;
    }

    _createInvalidFnTypeError() {
        return new _runtime.ClientFunctionAPIError(this.callsiteNames.instantiation, this.callsiteNames.instantiation, _message2.default.clientFunctionCodeIsNotAFunction, typeof this.fn);
    }

    _executeCommand(args, testRun, callsite) {
        var _this = this;

        // NOTE: should be kept outside of lazy promise to preserve
        // correct callsite in case of replicator error.
        const command = this.getCommand(args);

        return _reExecutablePromise2.default.fromFn((0, _asyncToGenerator3.default)(function* () {
            if (!testRun) {
                const err = new _runtime.ClientFunctionAPIError(_this.callsiteNames.execution, _this.callsiteNames.instantiation, _message2.default.clientFunctionCantResolveTestRun);

                // NOTE: force callsite here, because more likely it will
                // be impossible to resolve it by method name from a lazy promise.
                err.callsite = callsite;

                throw err;
            }

            const result = yield testRun.executeCommand(command, callsite);

            return _this._processResult(result, args);
        }));
    }

    _processResult(result) {
        return this.replicator.decode(result);
    }

    _validateOptions(options) {
        (0, _typeAssertions.assertType)(_typeAssertions.is.nonNullObject, this.callsiteNames.instantiation, '"options" argument', options);

        if (!(0, _lodash.isNil)(options.boundTestRun)) {
            // NOTE: `boundTestRun` can be either TestController or TestRun instance.
            const boundTestRun = options.boundTestRun.testRun || options.boundTestRun;

            if (!boundTestRun[_markerSymbol2.default]) throw new _runtime.APIError(this.callsiteNames.instantiation, _message2.default.invalidClientFunctionTestRunBinding);
        }

        if (!(0, _lodash.isNil)(options.dependencies)) (0, _typeAssertions.assertType)(_typeAssertions.is.nonNullObject, this.callsiteNames.instantiation, '"dependencies" option', options.dependencies);
    }

    _getReplicatorTransforms() {
        return [new _replicator.FunctionTransform(this.callsiteNames)];
    }
}
exports.default = ClientFunctionBuilder;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGllbnQtZnVuY3Rpb25zL2NsaWVudC1mdW5jdGlvbi1idWlsZGVyLmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfRVhFQ1VUSU9OX0NBTExTSVRFX05BTUUiLCJDbGllbnRGdW5jdGlvbkJ1aWxkZXIiLCJjb25zdHJ1Y3RvciIsImZuIiwib3B0aW9ucyIsImNhbGxzaXRlTmFtZXMiLCJpbnN0YW50aWF0aW9uIiwiZXhlY3V0aW9uIiwiX3ZhbGlkYXRlT3B0aW9ucyIsImNvbXBpbGVkRm5Db2RlIiwiX2dldENvbXBpbGVkRm5Db2RlIiwiX2NyZWF0ZUludmFsaWRGblR5cGVFcnJvciIsInJlcGxpY2F0b3IiLCJfZ2V0UmVwbGljYXRvclRyYW5zZm9ybXMiLCJfZGVjb3JhdGVGdW5jdGlvbiIsImNsaWVudEZuIiwiZnVuY3Rpb25CdWlsZGVyU3ltYm9sIiwid2l0aCIsImJ1aWxkZXIiLCJnZXRGdW5jdGlvbiIsImdldEJvdW5kVGVzdFJ1biIsImJvdW5kVGVzdFJ1biIsInRlc3RSdW4iLCJfZ2V0VGVzdFJ1biIsInRlc3RSdW5UcmFja2VyIiwicmVzb2x2ZUNvbnRleHRUZXN0UnVuIiwiX18kJGNsaWVudEZ1bmN0aW9uJCQiLCJjYWxsc2l0ZSIsImFyZ3MiLCJpIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwicHVzaCIsIl9leGVjdXRlQ29tbWFuZCIsImdldENvbW1hbmQiLCJlbmNvZGVkQXJncyIsImVuY29kZSIsImVuY29kZWREZXBlbmRlbmNpZXMiLCJnZXRGdW5jdGlvbkRlcGVuZGVuY2llcyIsIl9jcmVhdGVUZXN0UnVuQ29tbWFuZCIsImRlcGVuZGVuY2llcyIsIkV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQiLCJpbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lIiwiZm5Db2RlIiwidG9TdHJpbmciLCJDbGllbnRGdW5jdGlvbkFQSUVycm9yIiwiTUVTU0FHRSIsImNsaWVudEZ1bmN0aW9uQ29kZUlzTm90QUZ1bmN0aW9uIiwiY29tbWFuZCIsIlJlRXhlY3V0YWJsZVByb21pc2UiLCJmcm9tRm4iLCJlcnIiLCJjbGllbnRGdW5jdGlvbkNhbnRSZXNvbHZlVGVzdFJ1biIsInJlc3VsdCIsImV4ZWN1dGVDb21tYW5kIiwiX3Byb2Nlc3NSZXN1bHQiLCJkZWNvZGUiLCJpcyIsIm5vbk51bGxPYmplY3QiLCJ0ZXN0UnVuTWFya2VyIiwiQVBJRXJyb3IiLCJpbnZhbGlkQ2xpZW50RnVuY3Rpb25UZXN0UnVuQmluZGluZyIsIkZ1bmN0aW9uVHJhbnNmb3JtIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsa0NBQWtDLHNCQUF4Qzs7QUFFZSxNQUFNQyxxQkFBTixDQUE0QjtBQUN2Q0MsZ0JBQWFDLEVBQWIsRUFBaUJDLE9BQWpCLEVBQTBCQyxnQkFBZ0IsRUFBMUMsRUFBOEM7QUFDMUMsYUFBS0EsYUFBTCxHQUFxQjtBQUNqQkMsMkJBQWVELGNBQWNDLGFBRFo7QUFFakJDLHVCQUFlRixjQUFjRSxTQUFkLElBQTJCUDtBQUZ6QixTQUFyQjs7QUFLQSxZQUFJLG1CQUFrQkksT0FBbEIsQ0FBSixFQUNJQSxVQUFVLEVBQVY7O0FBRUosYUFBS0ksZ0JBQUwsQ0FBc0JKLE9BQXRCOztBQUVBLGFBQUtELEVBQUwsR0FBc0JBLEVBQXRCO0FBQ0EsYUFBS0MsT0FBTCxHQUFzQkEsT0FBdEI7QUFDQSxhQUFLSyxjQUFMLEdBQXNCLEtBQUtDLGtCQUFMLEVBQXRCOztBQUVBLFlBQUksQ0FBQyxLQUFLRCxjQUFWLEVBQ0ksTUFBTSxLQUFLRSx5QkFBTCxFQUFOOztBQUVKLGFBQUtDLFVBQUwsR0FBa0Isa0NBQWlCLEtBQUtDLHdCQUFMLEVBQWpCLENBQWxCO0FBQ0g7O0FBRURDLHNCQUFtQkMsUUFBbkIsRUFBNkI7QUFDekJBLGlCQUFTQyx1QkFBVCxJQUFrQyxJQUFsQzs7QUFFQUQsaUJBQVNF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aUJBQUosQ0FBYSxLQUFLdkQsYUFBTCxDQUFtQkMsYUFBaEMsRUFBK0N3QyxrQkFBUWUsbUNBQXZELENBQU47QUFDUDs7QUFFRCxZQUFJLENBQUMsbUJBQWtCekQsUUFBUW9DLFlBQTFCLENBQUwsRUFDSSxnQ0FBV2lCLG1CQUFHQyxhQUFkLEVBQTZCLEtBQUtyRCxhQUFMLENBQW1CQyxhQUFoRCxFQUErRCx1QkFBL0QsRUFBd0ZGLFFBQVFvQyxZQUFoRztBQUNQOztBQUVEM0IsK0JBQTRCO0FBQ3hCLGVBQU8sQ0FDSCxJQUFJaUQsNkJBQUosQ0FBc0IsS0FBS3pELGFBQTNCLENBREcsQ0FBUDtBQUdIO0FBcEpzQztrQkFBdEJKLHFCIiwiZmlsZSI6ImNsaWVudC1mdW5jdGlvbnMvY2xpZW50LWZ1bmN0aW9uLWJ1aWxkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc05pbCBhcyBpc051bGxPclVuZGVmaW5lZCwgYXNzaWduIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB0ZXN0UnVuVHJhY2tlciBmcm9tICcuLi9hcGkvdGVzdC1ydW4tdHJhY2tlcic7XG5pbXBvcnQgZnVuY3Rpb25CdWlsZGVyU3ltYm9sIGZyb20gJy4vYnVpbGRlci1zeW1ib2wnO1xuaW1wb3J0IHsgY3JlYXRlUmVwbGljYXRvciwgRnVuY3Rpb25UcmFuc2Zvcm0gfSBmcm9tICcuL3JlcGxpY2F0b3InO1xuaW1wb3J0IHsgRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZCB9IGZyb20gJy4uL3Rlc3QtcnVuL2NvbW1hbmRzL29ic2VydmF0aW9uJztcbmltcG9ydCBjb21waWxlQ2xpZW50RnVuY3Rpb24gZnJvbSAnLi4vY29tcGlsZXIvY29tcGlsZS1jbGllbnQtZnVuY3Rpb24nO1xuaW1wb3J0IHsgQVBJRXJyb3IsIENsaWVudEZ1bmN0aW9uQVBJRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBhc3NlcnRUeXBlLCBpcyB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL3R5cGUtYXNzZXJ0aW9ucyc7XG5pbXBvcnQgTUVTU0FHRSBmcm9tICcuLi9lcnJvcnMvcnVudGltZS9tZXNzYWdlJztcbmltcG9ydCB7IGdldENhbGxzaXRlRm9yTWV0aG9kIH0gZnJvbSAnLi4vZXJyb3JzL2dldC1jYWxsc2l0ZSc7XG5pbXBvcnQgUmVFeGVjdXRhYmxlUHJvbWlzZSBmcm9tICcuLi91dGlscy9yZS1leGVjdXRhYmxlLXByb21pc2UnO1xuaW1wb3J0IHRlc3RSdW5NYXJrZXIgZnJvbSAnLi4vdGVzdC1ydW4vbWFya2VyLXN5bWJvbCc7XG5cbmNvbnN0IERFRkFVTFRfRVhFQ1VUSU9OX0NBTExTSVRFX05BTUUgPSAnX18kJGNsaWVudEZ1bmN0aW9uJCQnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDbGllbnRGdW5jdGlvbkJ1aWxkZXIge1xuICAgIGNvbnN0cnVjdG9yIChmbiwgb3B0aW9ucywgY2FsbHNpdGVOYW1lcyA9IHt9KSB7XG4gICAgICAgIHRoaXMuY2FsbHNpdGVOYW1lcyA9IHtcbiAgICAgICAgICAgIGluc3RhbnRpYXRpb246IGNhbGxzaXRlTmFtZXMuaW5zdGFudGlhdGlvbixcbiAgICAgICAgICAgIGV4ZWN1dGlvbjogICAgIGNhbGxzaXRlTmFtZXMuZXhlY3V0aW9uIHx8IERFRkFVTFRfRVhFQ1VUSU9OX0NBTExTSVRFX05BTUVcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQob3B0aW9ucykpXG4gICAgICAgICAgICBvcHRpb25zID0ge307XG5cbiAgICAgICAgdGhpcy5fdmFsaWRhdGVPcHRpb25zKG9wdGlvbnMpO1xuXG4gICAgICAgIHRoaXMuZm4gICAgICAgICAgICAgPSBmbjtcbiAgICAgICAgdGhpcy5vcHRpb25zICAgICAgICA9IG9wdGlvbnM7XG4gICAgICAgIHRoaXMuY29tcGlsZWRGbkNvZGUgPSB0aGlzLl9nZXRDb21waWxlZEZuQ29kZSgpO1xuXG4gICAgICAgIGlmICghdGhpcy5jb21waWxlZEZuQ29kZSlcbiAgICAgICAgICAgIHRocm93IHRoaXMuX2NyZWF0ZUludmFsaWRGblR5cGVFcnJvcigpO1xuXG4gICAgICAgIHRoaXMucmVwbGljYXRvciA9IGNyZWF0ZVJlcGxpY2F0b3IodGhpcy5fZ2V0UmVwbGljYXRvclRyYW5zZm9ybXMoKSk7XG4gICAgfVxuXG4gICAgX2RlY29yYXRlRnVuY3Rpb24gKGNsaWVudEZuKSB7XG4gICAgICAgIGNsaWVudEZuW2Z1bmN0aW9uQnVpbGRlclN5bWJvbF0gPSB0aGlzO1xuXG4gICAgICAgIGNsaWVudEZuLndpdGggPSBvcHRpb25zID0+IHtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcpXG4gICAgICAgICAgICAgICAgb3B0aW9ucyA9IGFzc2lnbih7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTtcblxuICAgICAgICAgICAgY29uc3QgYnVpbGRlciA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuZm4sIG9wdGlvbnMsIHtcbiAgICAgICAgICAgICAgICBpbnN0YW50aWF0aW9uOiAnd2l0aCcsXG4gICAgICAgICAgICAgICAgZXhlY3V0aW9uOiAgICAgdGhpcy5jYWxsc2l0ZU5hbWVzLmV4ZWN1dGlvblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBidWlsZGVyLmdldEZ1bmN0aW9uKCk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZ2V0Qm91bmRUZXN0UnVuICgpIHtcbiAgICAgICAgLy8gTk9URTogYGJvdW5kVGVzdFJ1bmAgY2FuIGJlIGVpdGhlciBUZXN0Q29udHJvbGxlciBvciBUZXN0UnVuIGluc3RhbmNlLlxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmJvdW5kVGVzdFJ1bilcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuYm91bmRUZXN0UnVuLnRlc3RSdW4gfHwgdGhpcy5vcHRpb25zLmJvdW5kVGVzdFJ1bjtcblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBfZ2V0VGVzdFJ1biAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEJvdW5kVGVzdFJ1bigpIHx8IHRlc3RSdW5UcmFja2VyLnJlc29sdmVDb250ZXh0VGVzdFJ1bigpO1xuICAgIH1cblxuICAgIGdldEZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgYnVpbGRlciA9IHRoaXM7XG5cbiAgICAgICAgY29uc3QgY2xpZW50Rm4gPSBmdW5jdGlvbiBfXyQkY2xpZW50RnVuY3Rpb24kJCAoKSB7XG4gICAgICAgICAgICBjb25zdCB0ZXN0UnVuICA9IGJ1aWxkZXIuX2dldFRlc3RSdW4oKTtcbiAgICAgICAgICAgIGNvbnN0IGNhbGxzaXRlID0gZ2V0Q2FsbHNpdGVGb3JNZXRob2QoYnVpbGRlci5jYWxsc2l0ZU5hbWVzLmV4ZWN1dGlvbik7XG4gICAgICAgICAgICBjb25zdCBhcmdzICAgICA9IFtdO1xuXG4gICAgICAgICAgICAvLyBPUFRJTUlaQVRJT046IGRvbid0IGxlYWsgYGFyZ3VtZW50c2Agb2JqZWN0LlxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7XG5cbiAgICAgICAgICAgIHJldHVybiBidWlsZGVyLl9leGVjdXRlQ29tbWFuZChhcmdzLCB0ZXN0UnVuLCBjYWxsc2l0ZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fZGVjb3JhdGVGdW5jdGlvbihjbGllbnRGbik7XG5cbiAgICAgICAgcmV0dXJuIGNsaWVudEZuO1xuICAgIH1cblxuICAgIGdldENvbW1hbmQgKGFyZ3MpIHtcbiAgICAgICAgY29uc3QgZW5jb2RlZEFyZ3MgICAgICAgICA9IHRoaXMucmVwbGljYXRvci5lbmNvZGUoYXJncyk7XG4gICAgICAgIGNvbnN0IGVuY29kZWREZXBlbmRlbmNpZXMgPSB0aGlzLnJlcGxpY2F0b3IuZW5jb2RlKHRoaXMuZ2V0RnVuY3Rpb25EZXBlbmRlbmNpZXMoKSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZVRlc3RSdW5Db21tYW5kKGVuY29kZWRBcmdzLCBlbmNvZGVkRGVwZW5kZW5jaWVzKTtcbiAgICB9XG5cblxuICAgIC8vIE92ZXJyaWRhYmxlIG1ldGhvZHNcbiAgICBnZXRGdW5jdGlvbkRlcGVuZGVuY2llcyAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuZGVwZW5kZW5jaWVzIHx8IHt9O1xuICAgIH1cblxuICAgIF9jcmVhdGVUZXN0UnVuQ29tbWFuZCAoZW5jb2RlZEFyZ3MsIGVuY29kZWREZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kKHtcbiAgICAgICAgICAgIGluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWU6IHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLFxuICAgICAgICAgICAgZm5Db2RlOiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21waWxlZEZuQ29kZSxcbiAgICAgICAgICAgIGFyZ3M6ICAgICAgICAgICAgICAgICAgICAgIGVuY29kZWRBcmdzLFxuICAgICAgICAgICAgZGVwZW5kZW5jaWVzOiAgICAgICAgICAgICAgZW5jb2RlZERlcGVuZGVuY2llc1xuICAgICAgICB9LCB0aGlzLl9nZXRUZXN0UnVuKCkpO1xuICAgIH1cblxuICAgIF9nZXRDb21waWxlZEZuQ29kZSAoKSB7XG4gICAgICAgIGlmICh0eXBlb2YgdGhpcy5mbiA9PT0gJ2Z1bmN0aW9uJylcbiAgICAgICAgICAgIHJldHVybiBjb21waWxlQ2xpZW50RnVuY3Rpb24odGhpcy5mbi50b1N0cmluZygpLCB0aGlzLm9wdGlvbnMuZGVwZW5kZW5jaWVzLCB0aGlzLmNhbGxzaXRlTmFtZXMuaW5zdGFudGlhdGlvbiwgdGhpcy5jYWxsc2l0ZU5hbWVzLmluc3RhbnRpYXRpb24pO1xuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIF9jcmVhdGVJbnZhbGlkRm5UeXBlRXJyb3IgKCkge1xuICAgICAgICByZXR1cm4gbmV3IENsaWVudEZ1bmN0aW9uQVBJRXJyb3IodGhpcy5jYWxsc2l0ZU5hbWVzLmluc3RhbnRpYXRpb24sIHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLCBNRVNTQUdFLmNsaWVudEZ1bmN0aW9uQ29kZUlzTm90QUZ1bmN0aW9uLCB0eXBlb2YgdGhpcy5mbik7XG4gICAgfVxuXG4gICAgX2V4ZWN1dGVDb21tYW5kIChhcmdzLCB0ZXN0UnVuLCBjYWxsc2l0ZSkge1xuICAgICAgICAvLyBOT1RFOiBzaG91bGQgYmUga2VwdCBvdXRzaWRlIG9mIGxhenkgcHJvbWlzZSB0byBwcmVzZXJ2ZVxuICAgICAgICAvLyBjb3JyZWN0IGNhbGxzaXRlIGluIGNhc2Ugb2YgcmVwbGljYXRvciBlcnJvci5cbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuZ2V0Q29tbWFuZChhcmdzKTtcblxuICAgICAgICByZXR1cm4gUmVFeGVjdXRhYmxlUHJvbWlzZS5mcm9tRm4oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCF0ZXN0UnVuKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZXJyID0gbmV3IENsaWVudEZ1bmN0aW9uQVBJRXJyb3IodGhpcy5jYWxsc2l0ZU5hbWVzLmV4ZWN1dGlvbiwgdGhpcy5jYWxsc2l0ZU5hbWVzLmluc3RhbnRpYXRpb24sIE1FU1NBR0UuY2xpZW50RnVuY3Rpb25DYW50UmVzb2x2ZVRlc3RSdW4pO1xuXG4gICAgICAgICAgICAgICAgLy8gTk9URTogZm9yY2UgY2FsbHNpdGUgaGVyZSwgYmVjYXVzZSBtb3JlIGxpa2VseSBpdCB3aWxsXG4gICAgICAgICAgICAgICAgLy8gYmUgaW1wb3NzaWJsZSB0byByZXNvbHZlIGl0IGJ5IG1ldGhvZCBuYW1lIGZyb20gYSBsYXp5IHByb21pc2UuXG4gICAgICAgICAgICAgICAgZXJyLmNhbGxzaXRlID0gY2FsbHNpdGU7XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQoY29tbWFuZCwgY2FsbHNpdGUpO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc1Jlc3VsdChyZXN1bHQsIGFyZ3MpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcHJvY2Vzc1Jlc3VsdCAocmVzdWx0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcGxpY2F0b3IuZGVjb2RlKHJlc3VsdCk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlT3B0aW9ucyAob3B0aW9ucykge1xuICAgICAgICBhc3NlcnRUeXBlKGlzLm5vbk51bGxPYmplY3QsIHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLCAnXCJvcHRpb25zXCIgYXJndW1lbnQnLCBvcHRpb25zKTtcblxuICAgICAgICBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKG9wdGlvbnMuYm91bmRUZXN0UnVuKSkge1xuICAgICAgICAgICAgLy8gTk9URTogYGJvdW5kVGVzdFJ1bmAgY2FuIGJlIGVpdGhlciBUZXN0Q29udHJvbGxlciBvciBUZXN0UnVuIGluc3RhbmNlLlxuICAgICAgICAgICAgY29uc3QgYm91bmRUZXN0UnVuID0gb3B0aW9ucy5ib3VuZFRlc3RSdW4udGVzdFJ1biB8fCBvcHRpb25zLmJvdW5kVGVzdFJ1bjtcblxuICAgICAgICAgICAgaWYgKCFib3VuZFRlc3RSdW5bdGVzdFJ1bk1hcmtlcl0pXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEFQSUVycm9yKHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLCBNRVNTQUdFLmludmFsaWRDbGllbnRGdW5jdGlvblRlc3RSdW5CaW5kaW5nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaXNOdWxsT3JVbmRlZmluZWQob3B0aW9ucy5kZXBlbmRlbmNpZXMpKVxuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OdWxsT2JqZWN0LCB0aGlzLmNhbGxzaXRlTmFtZXMuaW5zdGFudGlhdGlvbiwgJ1wiZGVwZW5kZW5jaWVzXCIgb3B0aW9uJywgb3B0aW9ucy5kZXBlbmRlbmNpZXMpO1xuICAgIH1cblxuICAgIF9nZXRSZXBsaWNhdG9yVHJhbnNmb3JtcyAoKSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICBuZXcgRnVuY3Rpb25UcmFuc2Zvcm0odGhpcy5jYWxsc2l0ZU5hbWVzKVxuICAgICAgICBdO1xuICAgIH1cbn1cbiJdfQ==
