'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _pngjs = require('pngjs');

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _limitNumber = require('../utils/limit-number');

var _limitNumber2 = _interopRequireDefault(_limitNumber);

var _promisifiedFunctions = require('../utils/promisified-functions');

var _renderTemplate = require('../utils/render-template');

var _renderTemplate2 = _interopRequireDefault(_renderTemplate);

var _testRun = require('../errors/test-run/');

var _constants = require('./constants');

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function readPng(filePath) {
    const stream = _fs2.default.createReadStream(filePath);
    const png = new _pngjs.PNG();

    const parsedPromise = _pinkie2.default.race([(0, _promisifyEvent2.default)(png, 'parsed'), (0, _promisifyEvent2.default)(png, 'error'), (0, _promisifyEvent2.default)(stream, 'error')]);

    stream.pipe(png);

    return parsedPromise.then(() => png);
}

function writePng(filePath, png) {
    const outStream = _fs2.default.createWriteStream(filePath);
    const pngStream = png.pack();

    const finishPromise = _pinkie2.default.race([(0, _promisifyEvent2.default)(outStream, 'finish'), (0, _promisifyEvent2.default)(outStream, 'error'), (0, _promisifyEvent2.default)(pngStream, 'error')]);

    pngStream.pipe(outStream);

    return finishPromise;
}

function markSeedToId(markSeed) {
    let id = 0;

    for (let i = 0; i < _constants.MARK_LENGTH; i++) id = id * 2 + (markSeed[i * _constants.MARK_BYTES_PER_PIXEL] ? 1 : 0);

    return id;
}

function detectClippingArea(srcImage, { markSeed, clientAreaDimensions, cropDimensions, screenshotPath } = {}) {
    let clipLeft = 0;
    let clipTop = 0;
    let clipRight = srcImage.width;
    let clipBottom = srcImage.height;
    let clipWidth = srcImage.width;
    let clipHeight = srcImage.height;

    if (markSeed && clientAreaDimensions) {
        const mark = Buffer.from(markSeed);

        const markIndex = srcImage.data.indexOf(mark);

        if (markIndex < 0) throw new Error((0, _renderTemplate2.default)(_warningMessage2.default.screenshotMarkNotFound, screenshotPath, markSeedToId(markSeed)));

        const endPosition = markIndex / _constants.MARK_BYTES_PER_PIXEL + _constants.MARK_LENGTH + _constants.MARK_RIGHT_MARGIN;

        clipRight = endPosition % srcImage.width || srcImage.width;
        clipBottom = (endPosition - clipRight) / srcImage.width + 1;
        clipLeft = clipRight - clientAreaDimensions.width;
        clipTop = clipBottom - clientAreaDimensions.height;
    }

    const markLineNumber = clipBottom;

    if (cropDimensions) {
        clipRight = (0, _limitNumber2.default)(clipLeft + cropDimensions.right, clipLeft, clipRight);
        clipBottom = (0, _limitNumber2.default)(clipTop + cropDimensions.bottom, clipTop, clipBottom);
        clipLeft = (0, _limitNumber2.default)(clipLeft + cropDimensions.left, clipLeft, clipRight);
        clipTop = (0, _limitNumber2.default)(clipTop + cropDimensions.top, clipTop, clipBottom);
    }

    if (markSeed && clipBottom === markLineNumber) clipBottom -= 1;

    clipWidth = clipRight - clipLeft;
    clipHeight = clipBottom - clipTop;

    return {
        left: clipLeft,
        top: clipTop,
        right: clipRight,
        bottom: clipBottom,
        width: clipWidth,
        height: clipHeight
    };
}

function copyImagePart(srcImage, { left, top, width, height }) {
    const dstImage = new _pngjs.PNG({ width, height });
    const stride = dstImage.width * _constants.MARK_BYTES_PER_PIXEL;

    for (let i = 0; i < height; i++) {
        const srcStartIndex = (srcImage.width * (i + top) + left) * _constants.MARK_BYTES_PER_PIXEL;

        srcImage.data.copy(dstImage.data, stride * i, srcStartIndex, srcStartIndex + stride);
    }

    return dstImage;
}

exports.default = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (screenshotPath, markSeed, clientAreaDimensions, cropDimensions) {
        const srcImage = yield readPng(screenshotPath);

        const clippingArea = detectClippingArea(srcImage, { markSeed, clientAreaDimensions, cropDimensions, screenshotPath });

        if (clippingArea.width <= 0 || clippingArea.height <= 0) {
            yield (0, _promisifiedFunctions.deleteFile)(screenshotPath);
            throw new _testRun.InvalidElementScreenshotDimensionsError(clippingArea.width, clippingArea.height);
        }

        if (!markSeed && !cropDimensions) return true;

        const dstImage = copyImagePart(srcImage, clippingArea);

        yield writePng(screenshotPath, dstImage);

        return true;
    });

    return function (_x, _x2, _x3, _x4) {
        return _ref.apply(this, arguments);
    };
})();

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JlZW5zaG90cy9jcm9wLmpzIl0sIm5hbWVzIjpbInJlYWRQbmciLCJmaWxlUGF0aCIsInN0cmVhbSIsImZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsInBuZyIsIlBORyIsInBhcnNlZFByb21pc2UiLCJQcm9taXNlIiwicmFjZSIsInBpcGUiLCJ0aGVuIiwid3JpdGVQbmciLCJvdXRTdHJlYW0iLCJjcmVhdGVXcml0ZVN0cmVhbSIsInBuZ1N0cmVhbSIsInBhY2siLCJmaW5pc2hQcm9taXNlIiwibWFya1NlZWRUb0lkIiwibWFya1NlZWQiLCJpZCIsImkiLCJNQVJLX0xFTkdUSCIsIk1BUktfQllURVNfUEVSX1BJWEVMIiwiZGV0ZWN0Q2xpcHBpbmdBcmVhIiwic3JjSW1hZ2UiLCJjbGllbnRBcmVhRGltZW5zaW9ucyIsImNyb3BEaW1lbnNpb25zIiwic2NyZWVuc2hvdFBhdGgiLCJjbGlwTGVmdCIsImNsaXBUb3AiLCJjbGlwUmlnaHQiLCJ3aWR0aCIsImNsaXBCb3R0b20iLCJoZWlnaHQiLCJjbGlwV2lkdGgiLCJjbGlwSGVpZ2h0IiwibWFyayIsIkJ1ZmZlciIsImZyb20iLCJtYXJrSW5kZXgiLCJkYXRhIiwiaW5kZXhPZiIsIkVycm9yIiwiV0FSTklOR19NRVNTQUdFUyIsInNjcmVlbnNob3RNYXJrTm90Rm91bmQiLCJlbmRQb3NpdGlvbiIsIk1BUktfUklHSFRfTUFSR0lOIiwibWFya0xpbmVOdW1iZXIiLCJyaWdodCIsImJvdHRvbSIsImxlZnQiLCJ0b3AiLCJjb3B5SW1hZ2VQYXJ0IiwiZHN0SW1hZ2UiLCJzdHJpZGUiLCJzcmNTdGFydEluZGV4IiwiY29weSIsImNsaXBwaW5nQXJlYSIsIkludmFsaWRFbGVtZW50U2NyZWVuc2hvdERpbWVuc2lvbnNFcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7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QUE3RTtBQUNIOztBQUVELFdBQU9ELFFBQVA7QUFDSDs7OytDQUVjLFdBQWdCMUIsY0FBaEIsRUFBZ0NULFFBQWhDLEVBQTBDTyxvQkFBMUMsRUFBZ0VDLGNBQWhFLEVBQWdGO0FBQzNGLGNBQU1GLFdBQVksTUFBTXpCLFFBQVE0QixjQUFSLENBQXhCOztBQUVBLGNBQU04QixlQUFlbEMsbUJBQW1CQyxRQUFuQixFQUE2QixFQUFFTixRQUFGLEVBQVlPLG9CQUFaLEVBQWtDQyxjQUFsQyxFQUFrREMsY0FBbEQsRUFBN0IsQ0FBckI7O0FBRUEsWUFBSThCLGFBQWExQixLQUFiLElBQXNCLENBQXRCLElBQTJCMEIsYUFBYXhCLE1BQWIsSUFBdUIsQ0FBdEQsRUFBeUQ7QUFDckQsa0JBQU0sc0NBQVdOLGNBQVgsQ0FBTjtBQUNBLGtCQUFNLElBQUkrQixnREFBSixDQUE0Q0QsYUFBYTFCLEtBQXpELEVBQWdFMEIsYUFBYXhCLE1BQTdFLENBQU47QUFDSDs7QUFFRCxZQUFJLENBQUNmLFFBQUQsSUFBYSxDQUFDUSxjQUFsQixFQUNJLE9BQU8sSUFBUDs7QUFFSixjQUFNMkIsV0FBV0QsY0FBYzVCLFFBQWQsRUFBd0JpQyxZQUF4QixDQUFqQjs7QUFFQSxjQUFNOUMsU0FBU2dCLGNBQVQsRUFBeUIwQixRQUF6QixDQUFOOztBQUVBLGVBQU8sSUFBUDtBQUNILEsiLCJmaWxlIjoic2NyZWVuc2hvdHMvY3JvcC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHsgUE5HIH0gZnJvbSAncG5nanMnO1xuaW1wb3J0IHByb21pc2lmeUV2ZW50IGZyb20gJ3Byb21pc2lmeS1ldmVudCc7XG5pbXBvcnQgbGltaXROdW1iZXIgZnJvbSAnLi4vdXRpbHMvbGltaXQtbnVtYmVyJztcbmltcG9ydCB7IGRlbGV0ZUZpbGUgfSBmcm9tICcuLi91dGlscy9wcm9taXNpZmllZC1mdW5jdGlvbnMnO1xuaW1wb3J0IHJlbmRlclRlbXBsYXRlIGZyb20gJy4uL3V0aWxzL3JlbmRlci10ZW1wbGF0ZSc7XG5pbXBvcnQgeyBJbnZhbGlkRWxlbWVudFNjcmVlbnNob3REaW1lbnNpb25zRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvdGVzdC1ydW4vJztcbmltcG9ydCB7IE1BUktfTEVOR1RILCBNQVJLX1JJR0hUX01BUkdJTiwgTUFSS19CWVRFU19QRVJfUElYRUwgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgV0FSTklOR19NRVNTQUdFUyBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5cblxuZnVuY3Rpb24gcmVhZFBuZyAoZmlsZVBhdGgpIHtcbiAgICBjb25zdCBzdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGZpbGVQYXRoKTtcbiAgICBjb25zdCBwbmcgICAgPSBuZXcgUE5HKCk7XG5cbiAgICBjb25zdCBwYXJzZWRQcm9taXNlID0gUHJvbWlzZS5yYWNlKFtcbiAgICAgICAgcHJvbWlzaWZ5RXZlbnQocG5nLCAncGFyc2VkJyksXG4gICAgICAgIHByb21pc2lmeUV2ZW50KHBuZywgJ2Vycm9yJyksXG4gICAgICAgIHByb21pc2lmeUV2ZW50KHN0cmVhbSwgJ2Vycm9yJylcbiAgICBdKTtcblxuICAgIHN0cmVhbS5waXBlKHBuZyk7XG5cbiAgICByZXR1cm4gcGFyc2VkUHJvbWlzZVxuICAgICAgICAudGhlbigoKSA9PiBwbmcpO1xufVxuXG5mdW5jdGlvbiB3cml0ZVBuZyAoZmlsZVBhdGgsIHBuZykge1xuICAgIGNvbnN0IG91dFN0cmVhbSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGZpbGVQYXRoKTtcbiAgICBjb25zdCBwbmdTdHJlYW0gPSBwbmcucGFjaygpO1xuXG4gICAgY29uc3QgZmluaXNoUHJvbWlzZSA9IFByb21pc2UucmFjZShbXG4gICAgICAgIHByb21pc2lmeUV2ZW50KG91dFN0cmVhbSwgJ2ZpbmlzaCcpLFxuICAgICAgICBwcm9taXNpZnlFdmVudChvdXRTdHJlYW0sICdlcnJvcicpLFxuICAgICAgICBwcm9taXNpZnlFdmVudChwbmdTdHJlYW0sICdlcnJvcicpXG4gICAgXSk7XG5cbiAgICBwbmdTdHJlYW0ucGlwZShvdXRTdHJlYW0pO1xuXG4gICAgcmV0dXJuIGZpbmlzaFByb21pc2U7XG59XG5cbmZ1bmN0aW9uIG1hcmtTZWVkVG9JZCAobWFya1NlZWQpIHtcbiAgICBsZXQgaWQgPSAwO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNQVJLX0xFTkdUSDsgaSsrKVxuICAgICAgICBpZCA9IGlkICogMiArIChtYXJrU2VlZFtpICogTUFSS19CWVRFU19QRVJfUElYRUxdID8gMSA6IDApO1xuXG4gICAgcmV0dXJuIGlkO1xufVxuXG5mdW5jdGlvbiBkZXRlY3RDbGlwcGluZ0FyZWEgKHNyY0ltYWdlLCB7IG1hcmtTZWVkLCBjbGllbnRBcmVhRGltZW5zaW9ucywgY3JvcERpbWVuc2lvbnMsIHNjcmVlbnNob3RQYXRoIH0gPSB7fSkge1xuICAgIGxldCBjbGlwTGVmdCAgID0gMDtcbiAgICBsZXQgY2xpcFRvcCAgICA9IDA7XG4gICAgbGV0IGNsaXBSaWdodCAgPSBzcmNJbWFnZS53aWR0aDtcbiAgICBsZXQgY2xpcEJvdHRvbSA9IHNyY0ltYWdlLmhlaWdodDtcbiAgICBsZXQgY2xpcFdpZHRoICA9IHNyY0ltYWdlLndpZHRoO1xuICAgIGxldCBjbGlwSGVpZ2h0ID0gc3JjSW1hZ2UuaGVpZ2h0O1xuXG4gICAgaWYgKG1hcmtTZWVkICYmIGNsaWVudEFyZWFEaW1lbnNpb25zKSB7XG4gICAgICAgIGNvbnN0IG1hcmsgPSBCdWZmZXIuZnJvbShtYXJrU2VlZCk7XG5cbiAgICAgICAgY29uc3QgbWFya0luZGV4ID0gc3JjSW1hZ2UuZGF0YS5pbmRleE9mKG1hcmspO1xuXG4gICAgICAgIGlmIChtYXJrSW5kZXggPCAwKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlbmRlclRlbXBsYXRlKFdBUk5JTkdfTUVTU0FHRVMuc2NyZWVuc2hvdE1hcmtOb3RGb3VuZCwgc2NyZWVuc2hvdFBhdGgsIG1hcmtTZWVkVG9JZChtYXJrU2VlZCkpKTtcblxuICAgICAgICBjb25zdCBlbmRQb3NpdGlvbiA9IG1hcmtJbmRleCAvIE1BUktfQllURVNfUEVSX1BJWEVMICsgTUFSS19MRU5HVEggKyBNQVJLX1JJR0hUX01BUkdJTjtcblxuICAgICAgICBjbGlwUmlnaHQgID0gZW5kUG9zaXRpb24gJSBzcmNJbWFnZS53aWR0aCB8fCBzcmNJbWFnZS53aWR0aDtcbiAgICAgICAgY2xpcEJvdHRvbSA9IChlbmRQb3NpdGlvbiAtIGNsaXBSaWdodCkgLyBzcmNJbWFnZS53aWR0aCArIDE7XG4gICAgICAgIGNsaXBMZWZ0ICAgPSBjbGlwUmlnaHQgLSBjbGllbnRBcmVhRGltZW5zaW9ucy53aWR0aDtcbiAgICAgICAgY2xpcFRvcCAgICA9IGNsaXBCb3R0b20gLSBjbGllbnRBcmVhRGltZW5zaW9ucy5oZWlnaHQ7XG4gICAgfVxuXG4gICAgY29uc3QgbWFya0xpbmVOdW1iZXIgPSBjbGlwQm90dG9tO1xuXG4gICAgaWYgKGNyb3BEaW1lbnNpb25zKSB7XG4gICAgICAgIGNsaXBSaWdodCAgPSBsaW1pdE51bWJlcihjbGlwTGVmdCArIGNyb3BEaW1lbnNpb25zLnJpZ2h0LCBjbGlwTGVmdCwgY2xpcFJpZ2h0KTtcbiAgICAgICAgY2xpcEJvdHRvbSA9IGxpbWl0TnVtYmVyKGNsaXBUb3AgKyBjcm9wRGltZW5zaW9ucy5ib3R0b20sIGNsaXBUb3AsIGNsaXBCb3R0b20pO1xuICAgICAgICBjbGlwTGVmdCAgID0gbGltaXROdW1iZXIoY2xpcExlZnQgKyBjcm9wRGltZW5zaW9ucy5sZWZ0LCBjbGlwTGVmdCwgY2xpcFJpZ2h0KTtcbiAgICAgICAgY2xpcFRvcCAgICA9IGxpbWl0TnVtYmVyKGNsaXBUb3AgKyBjcm9wRGltZW5zaW9ucy50b3AsIGNsaXBUb3AsIGNsaXBCb3R0b20pO1xuICAgIH1cblxuICAgIGlmIChtYXJrU2VlZCAmJiBjbGlwQm90dG9tID09PSBtYXJrTGluZU51bWJlcilcbiAgICAgICAgY2xpcEJvdHRvbSAtPSAxO1xuXG4gICAgY2xpcFdpZHRoICA9IGNsaXBSaWdodCAtIGNsaXBMZWZ0O1xuICAgIGNsaXBIZWlnaHQgPSBjbGlwQm90dG9tIC0gY2xpcFRvcDtcblxuICAgIHJldHVybiB7XG4gICAgICAgIGxlZnQ6ICAgY2xpcExlZnQsXG4gICAgICAgIHRvcDogICAgY2xpcFRvcCxcbiAgICAgICAgcmlnaHQ6ICBjbGlwUmlnaHQsXG4gICAgICAgIGJvdHRvbTogY2xpcEJvdHRvbSxcbiAgICAgICAgd2lkdGg6ICBjbGlwV2lkdGgsXG4gICAgICAgIGhlaWdodDogY2xpcEhlaWdodFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIGNvcHlJbWFnZVBhcnQgKHNyY0ltYWdlLCB7IGxlZnQsIHRvcCwgd2lkdGgsIGhlaWdodCB9KSB7XG4gICAgY29uc3QgZHN0SW1hZ2UgPSBuZXcgUE5HKHsgd2lkdGgsIGhlaWdodCB9KTtcbiAgICBjb25zdCBzdHJpZGUgICA9IGRzdEltYWdlLndpZHRoICogTUFSS19CWVRFU19QRVJfUElYRUw7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHNyY1N0YXJ0SW5kZXggPSAoc3JjSW1hZ2Uud2lkdGggKiAoaSArIHRvcCkgKyBsZWZ0KSAqIE1BUktfQllURVNfUEVSX1BJWEVMO1xuXG4gICAgICAgIHNyY0ltYWdlLmRhdGEuY29weShkc3RJbWFnZS5kYXRhLCBzdHJpZGUgKiBpLCBzcmNTdGFydEluZGV4LCBzcmNTdGFydEluZGV4ICsgc3RyaWRlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZHN0SW1hZ2U7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIChzY3JlZW5zaG90UGF0aCwgbWFya1NlZWQsIGNsaWVudEFyZWFEaW1lbnNpb25zLCBjcm9wRGltZW5zaW9ucykge1xuICAgIGNvbnN0IHNyY0ltYWdlICA9IGF3YWl0IHJlYWRQbmcoc2NyZWVuc2hvdFBhdGgpO1xuXG4gICAgY29uc3QgY2xpcHBpbmdBcmVhID0gZGV0ZWN0Q2xpcHBpbmdBcmVhKHNyY0ltYWdlLCB7IG1hcmtTZWVkLCBjbGllbnRBcmVhRGltZW5zaW9ucywgY3JvcERpbWVuc2lvbnMsIHNjcmVlbnNob3RQYXRoIH0pO1xuXG4gICAgaWYgKGNsaXBwaW5nQXJlYS53aWR0aCA8PSAwIHx8IGNsaXBwaW5nQXJlYS5oZWlnaHQgPD0gMCkge1xuICAgICAgICBhd2FpdCBkZWxldGVGaWxlKHNjcmVlbnNob3RQYXRoKTtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRFbGVtZW50U2NyZWVuc2hvdERpbWVuc2lvbnNFcnJvcihjbGlwcGluZ0FyZWEud2lkdGgsIGNsaXBwaW5nQXJlYS5oZWlnaHQpO1xuICAgIH1cblxuICAgIGlmICghbWFya1NlZWQgJiYgIWNyb3BEaW1lbnNpb25zKVxuICAgICAgICByZXR1cm4gdHJ1ZTtcblxuICAgIGNvbnN0IGRzdEltYWdlID0gY29weUltYWdlUGFydChzcmNJbWFnZSwgY2xpcHBpbmdBcmVhKTtcblxuICAgIGF3YWl0IHdyaXRlUG5nKHNjcmVlbnNob3RQYXRoLCBkc3RJbWFnZSk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbn1cbiJdfQ==
