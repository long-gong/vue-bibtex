'use strict';

exports.__esModule = true;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

exports.default = createRequestLogger;

var _testcafeHammerhead = require('testcafe-hammerhead');

var _hook = require('./hook');

var _hook2 = _interopRequireDefault(_hook);

var _useragent = require('useragent');

var _testRunTracker = require('../test-run-tracker');

var _testRunTracker2 = _interopRequireDefault(_testRunTracker);

var _reExecutablePromise = require('../../utils/re-executable-promise');

var _reExecutablePromise2 = _interopRequireDefault(_reExecutablePromise);

var _runtime = require('../../errors/runtime');

var _message = require('../../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_OPTIONS = {
    logRequestHeaders: false,
    logRequestBody: false,
    stringifyRequestBody: false,
    logResponseHeaders: false,
    logResponseBody: false,
    stringifyResponseBody: false
};

class RequestLoggerImplementation extends _hook2.default {
    constructor(requestFilterRuleInit, options) {
        options = (0, _assign2.default)({}, DEFAULT_OPTIONS, options);
        RequestLoggerImplementation._assertLogOptions(options);

        const configureResponseEventOptions = new _testcafeHammerhead.ConfigureResponseEventOptions(options.logResponseHeaders, options.logResponseBody);

        super(requestFilterRuleInit, configureResponseEventOptions);

        this.options = options;

        this._internalRequests = {};
    }

    static _assertLogOptions(logOptions) {
        if (!logOptions.logRequestBody && logOptions.stringifyRequestBody) throw new _runtime.APIError('RequestLogger', _message2.default.requestHookConfigureAPIError, 'RequestLogger', 'Cannot stringify the request body because it is not logged. Specify { logRequestBody: true } in log options.');

        if (!logOptions.logResponseBody && logOptions.stringifyResponseBody) throw new _runtime.APIError('RequestLogger', _message2.default.requestHookConfigureAPIError, 'RequestLogger', 'Cannot stringify the response body because it is not logged. Specify { logResponseBody: true } in log options.');
    }

    onRequest(event) {
        const userAgent = (0, _useragent.parse)(event._requestInfo.userAgent).toString();

        const loggedReq = {
            id: event._requestInfo.requestId,
            testRunId: event._requestInfo.sessionId,
            userAgent,
            request: {
                url: event._requestInfo.url,
                method: event._requestInfo.method
            }
        };

        if (this.options.logRequestHeaders) loggedReq.request.headers = (0, _assign2.default)({}, event._requestInfo.headers);

        if (this.options.logRequestBody) loggedReq.request.body = this.options.stringifyRequestBody ? event._requestInfo.body.toString() : event._requestInfo.body;

        this._internalRequests[loggedReq.id] = loggedReq;
    }

    onResponse(event) {
        const loggerReq = this._internalRequests[event.requestId];

        // NOTE: If the 'clear' method is called during a long running request,
        // we should not save a response part - request part has been already removed.
        if (!loggerReq) return;

        loggerReq.response = {};
        loggerReq.response.statusCode = event.statusCode;

        if (this.options.logResponseHeaders) loggerReq.response.headers = (0, _assign2.default)({}, event.headers);

        if (this.options.logResponseBody) {
            loggerReq.response.body = this.options.stringifyResponseBody && event.body ? event.body.toString() : event.body;
        }
    }

    _prepareInternalRequestInfo() {
        const testRun = _testRunTracker2.default.resolveContextTestRun();
        let preparedRequests = (0, _values2.default)(this._internalRequests);

        if (testRun) preparedRequests = preparedRequests.filter(r => r.testRunId === testRun.id);

        return preparedRequests;
    }

    _getCompletedRequests() {
        return this._prepareInternalRequestInfo().filter(r => r.response);
    }

    // API
    contains(predicate) {
        var _this = this;

        return _reExecutablePromise2.default.fromFn((0, _asyncToGenerator3.default)(function* () {
            return !!_this._getCompletedRequests().find(predicate);
        }));
    }

    count(predicate) {
        var _this2 = this;

        return _reExecutablePromise2.default.fromFn((0, _asyncToGenerator3.default)(function* () {
            return _this2._getCompletedRequests().filter(predicate).length;
        }));
    }

    clear() {
        const testRun = _testRunTracker2.default.resolveContextTestRun();

        if (testRun) {
            (0, _keys2.default)(this._internalRequests).forEach(id => {
                if (this._internalRequests[id].testRunId === testRun.id) delete this._internalRequests[id];
            });
        } else this._internalRequests = {};
    }

    get requests() {
        return this._prepareInternalRequestInfo();
    }
}

function createRequestLogger(requestFilterRuleInit, logOptions) {
    return new RequestLoggerImplementation(requestFilterRuleInit, logOptions);
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvcmVxdWVzdC1ob29rcy9yZXF1ZXN0LWxvZ2dlci5qcyJdLCJuYW1lcyI6WyJjcmVhdGVSZXF1ZXN0TG9nZ2VyIiwiREVGQVVMVF9PUFRJT05TIiwibG9nUmVxdWVzdEhlYWRlcnMiLCJsb2dSZXF1ZXN0Qm9keSIsInN0cmluZ2lmeVJlcXVlc3RCb2R5IiwibG9nUmVzcG9uc2VIZWFkZXJzIiwibG9nUmVzcG9uc2VCb2R5Iiwic3RyaW5naWZ5UmVzcG9uc2VCb2R5IiwiUmVxdWVzdExvZ2dlckltcGxlbWVudGF0aW9uIiwiUmVxdWVzdEhvb2siLCJjb25zdHJ1Y3RvciIsInJlcXVlc3RGaWx0ZXJSdWxlSW5pdCIsIm9wdGlvbnMiLCJfYXNzZXJ0TG9nT3B0aW9ucyIsImNvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zIiwiQ29uZmlndXJlUmVzcG9uc2VFdmVudE9wdGlvbnMiLCJfaW50ZXJuYWxSZXF1ZXN0cyIsImxvZ09wdGlvbnMiLCJBUElFcnJvciIsIk1FU1NBR0UiLCJyZXF1ZXN0SG9va0NvbmZpZ3VyZUFQSUVycm9yIiwib25SZXF1ZXN0IiwiZXZlbnQiLCJ1c2VyQWdlbnQiLCJfcmVxdWVzdEluZm8iLCJ0b1N0cmluZyIsImxvZ2dlZFJlcSIsImlkIiwicmVxdWVzdElkIiwidGVzdFJ1bklkIiwic2Vzc2lvbklkIiwicmVxdWVzdCIsInVybCIsIm1ldGhvZCIsImhlYWRlcnMiLCJib2R5Iiwib25SZXNwb25zZSIsImxvZ2dlclJlcSIsInJlc3BvbnNlIiwic3RhdHVzQ29kZSIsIl9wcmVwYXJlSW50ZXJuYWxSZXF1ZXN0SW5mbyIsInRlc3RSdW4iLCJ0ZXN0UnVuVHJhY2tlciIsInJlc29sdmVDb250ZXh0VGVzdFJ1biIsInByZXBhcmVkUmVxdWVzdHMiLCJmaWx0ZXIiLCJyIiwiX2dldENvbXBsZXRlZFJlcXVlc3RzIiwiY29udGFpbnMiLCJwcmVkaWNhdGUiLCJSZUV4ZWN1dGFibGVQcm9taXNlIiwiZnJvbUZu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TWQsVUFBVUMseUJBQWVDLHFCQUFmLEVBQWhCOztBQUVBLFlBQUlGLE9BQUosRUFBYTtBQUNULGdDQUFZLEtBQUt6QixpQkFBakIsRUFBb0N3QyxPQUFwQyxDQUE0QzdCLE1BQU07QUFDOUMsb0JBQUksS0FBS1gsaUJBQUwsQ0FBdUJXLEVBQXZCLEVBQTJCRSxTQUEzQixLQUF5Q1ksUUFBUWQsRUFBckQsRUFDSSxPQUFPLEtBQUtYLGlCQUFMLENBQXVCVyxFQUF2QixDQUFQO0FBQ1AsYUFIRDtBQUlILFNBTEQsTUFPSSxLQUFLWCxpQkFBTCxHQUF5QixFQUF6QjtBQUNQOztBQUVELFFBQUl5QyxRQUFKLEdBQWdCO0FBQ1osZUFBTyxLQUFLakIsMkJBQUwsRUFBUDtBQUNIO0FBM0dpRDs7QUE4R3ZDLFNBQVN4QyxtQkFBVCxDQUE4QlcscUJBQTlCLEVBQXFETSxVQUFyRCxFQUFpRTtBQUM1RSxXQUFPLElBQUlULDJCQUFKLENBQWdDRyxxQkFBaEMsRUFBdURNLFVBQXZELENBQVA7QUFDSCIsImZpbGUiOiJhcGkvcmVxdWVzdC1ob29rcy9yZXF1ZXN0LWxvZ2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zIH0gZnJvbSAndGVzdGNhZmUtaGFtbWVyaGVhZCc7XG5pbXBvcnQgUmVxdWVzdEhvb2sgZnJvbSAnLi9ob29rJztcbmltcG9ydCB7IHBhcnNlIGFzIHBhcnNlVXNlckFnZW50IH0gZnJvbSAndXNlcmFnZW50JztcbmltcG9ydCB0ZXN0UnVuVHJhY2tlciBmcm9tICcuLi90ZXN0LXJ1bi10cmFja2VyJztcbmltcG9ydCBSZUV4ZWN1dGFibGVQcm9taXNlIGZyb20gJy4uLy4uL3V0aWxzL3JlLWV4ZWN1dGFibGUtcHJvbWlzZSc7XG5pbXBvcnQgeyBBUElFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCBNRVNTQUdFIGZyb20gJy4uLy4uL2Vycm9ycy9ydW50aW1lL21lc3NhZ2UnO1xuXG5jb25zdCBERUZBVUxUX09QVElPTlMgPSB7XG4gICAgbG9nUmVxdWVzdEhlYWRlcnM6ICAgICBmYWxzZSxcbiAgICBsb2dSZXF1ZXN0Qm9keTogICAgICAgIGZhbHNlLFxuICAgIHN0cmluZ2lmeVJlcXVlc3RCb2R5OiAgZmFsc2UsXG4gICAgbG9nUmVzcG9uc2VIZWFkZXJzOiAgICBmYWxzZSxcbiAgICBsb2dSZXNwb25zZUJvZHk6ICAgICAgIGZhbHNlLFxuICAgIHN0cmluZ2lmeVJlc3BvbnNlQm9keTogZmFsc2Vcbn07XG5cbmNsYXNzIFJlcXVlc3RMb2dnZXJJbXBsZW1lbnRhdGlvbiBleHRlbmRzIFJlcXVlc3RIb29rIHtcbiAgICBjb25zdHJ1Y3RvciAocmVxdWVzdEZpbHRlclJ1bGVJbml0LCBvcHRpb25zKSB7XG4gICAgICAgIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBERUZBVUxUX09QVElPTlMsIG9wdGlvbnMpO1xuICAgICAgICBSZXF1ZXN0TG9nZ2VySW1wbGVtZW50YXRpb24uX2Fzc2VydExvZ09wdGlvbnMob3B0aW9ucyk7XG5cbiAgICAgICAgY29uc3QgY29uZmlndXJlUmVzcG9uc2VFdmVudE9wdGlvbnMgPSBuZXcgQ29uZmlndXJlUmVzcG9uc2VFdmVudE9wdGlvbnMob3B0aW9ucy5sb2dSZXNwb25zZUhlYWRlcnMsIG9wdGlvbnMubG9nUmVzcG9uc2VCb2R5KTtcblxuICAgICAgICBzdXBlcihyZXF1ZXN0RmlsdGVyUnVsZUluaXQsIGNvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zKTtcblxuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgICAgIHRoaXMuX2ludGVybmFsUmVxdWVzdHMgPSB7fTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2Fzc2VydExvZ09wdGlvbnMgKGxvZ09wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFsb2dPcHRpb25zLmxvZ1JlcXVlc3RCb2R5ICYmIGxvZ09wdGlvbnMuc3RyaW5naWZ5UmVxdWVzdEJvZHkpXG4gICAgICAgICAgICB0aHJvdyBuZXcgQVBJRXJyb3IoJ1JlcXVlc3RMb2dnZXInLCBNRVNTQUdFLnJlcXVlc3RIb29rQ29uZmlndXJlQVBJRXJyb3IsICdSZXF1ZXN0TG9nZ2VyJywgJ0Nhbm5vdCBzdHJpbmdpZnkgdGhlIHJlcXVlc3QgYm9keSBiZWNhdXNlIGl0IGlzIG5vdCBsb2dnZWQuIFNwZWNpZnkgeyBsb2dSZXF1ZXN0Qm9keTogdHJ1ZSB9IGluIGxvZyBvcHRpb25zLicpO1xuXG4gICAgICAgIGlmICghbG9nT3B0aW9ucy5sb2dSZXNwb25zZUJvZHkgJiYgbG9nT3B0aW9ucy5zdHJpbmdpZnlSZXNwb25zZUJvZHkpXG4gICAgICAgICAgICB0aHJvdyBuZXcgQVBJRXJyb3IoJ1JlcXVlc3RMb2dnZXInLCBNRVNTQUdFLnJlcXVlc3RIb29rQ29uZmlndXJlQVBJRXJyb3IsICdSZXF1ZXN0TG9nZ2VyJywgJ0Nhbm5vdCBzdHJpbmdpZnkgdGhlIHJlc3BvbnNlIGJvZHkgYmVjYXVzZSBpdCBpcyBub3QgbG9nZ2VkLiBTcGVjaWZ5IHsgbG9nUmVzcG9uc2VCb2R5OiB0cnVlIH0gaW4gbG9nIG9wdGlvbnMuJyk7XG4gICAgfVxuXG4gICAgb25SZXF1ZXN0IChldmVudCkge1xuICAgICAgICBjb25zdCB1c2VyQWdlbnQgPSBwYXJzZVVzZXJBZ2VudChldmVudC5fcmVxdWVzdEluZm8udXNlckFnZW50KS50b1N0cmluZygpO1xuXG4gICAgICAgIGNvbnN0IGxvZ2dlZFJlcSA9IHtcbiAgICAgICAgICAgIGlkOiAgICAgICAgZXZlbnQuX3JlcXVlc3RJbmZvLnJlcXVlc3RJZCxcbiAgICAgICAgICAgIHRlc3RSdW5JZDogZXZlbnQuX3JlcXVlc3RJbmZvLnNlc3Npb25JZCxcbiAgICAgICAgICAgIHVzZXJBZ2VudCxcbiAgICAgICAgICAgIHJlcXVlc3Q6ICAge1xuICAgICAgICAgICAgICAgIHVybDogICAgZXZlbnQuX3JlcXVlc3RJbmZvLnVybCxcbiAgICAgICAgICAgICAgICBtZXRob2Q6IGV2ZW50Ll9yZXF1ZXN0SW5mby5tZXRob2QsXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dSZXF1ZXN0SGVhZGVycylcbiAgICAgICAgICAgIGxvZ2dlZFJlcS5yZXF1ZXN0LmhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCBldmVudC5fcmVxdWVzdEluZm8uaGVhZGVycyk7XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dSZXF1ZXN0Qm9keSlcbiAgICAgICAgICAgIGxvZ2dlZFJlcS5yZXF1ZXN0LmJvZHkgPSB0aGlzLm9wdGlvbnMuc3RyaW5naWZ5UmVxdWVzdEJvZHkgPyBldmVudC5fcmVxdWVzdEluZm8uYm9keS50b1N0cmluZygpIDogZXZlbnQuX3JlcXVlc3RJbmZvLmJvZHk7XG5cbiAgICAgICAgdGhpcy5faW50ZXJuYWxSZXF1ZXN0c1tsb2dnZWRSZXEuaWRdID0gbG9nZ2VkUmVxO1xuICAgIH1cblxuICAgIG9uUmVzcG9uc2UgKGV2ZW50KSB7XG4gICAgICAgIGNvbnN0IGxvZ2dlclJlcSA9IHRoaXMuX2ludGVybmFsUmVxdWVzdHNbZXZlbnQucmVxdWVzdElkXTtcblxuICAgICAgICAvLyBOT1RFOiBJZiB0aGUgJ2NsZWFyJyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyBhIGxvbmcgcnVubmluZyByZXF1ZXN0LFxuICAgICAgICAvLyB3ZSBzaG91bGQgbm90IHNhdmUgYSByZXNwb25zZSBwYXJ0IC0gcmVxdWVzdCBwYXJ0IGhhcyBiZWVuIGFscmVhZHkgcmVtb3ZlZC5cbiAgICAgICAgaWYgKCFsb2dnZXJSZXEpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgbG9nZ2VyUmVxLnJlc3BvbnNlICAgICAgICAgICAgPSB7fTtcbiAgICAgICAgbG9nZ2VyUmVxLnJlc3BvbnNlLnN0YXR1c0NvZGUgPSBldmVudC5zdGF0dXNDb2RlO1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nUmVzcG9uc2VIZWFkZXJzKVxuICAgICAgICAgICAgbG9nZ2VyUmVxLnJlc3BvbnNlLmhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCBldmVudC5oZWFkZXJzKTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1Jlc3BvbnNlQm9keSkge1xuICAgICAgICAgICAgbG9nZ2VyUmVxLnJlc3BvbnNlLmJvZHkgPSB0aGlzLm9wdGlvbnMuc3RyaW5naWZ5UmVzcG9uc2VCb2R5ICYmIGV2ZW50LmJvZHlcbiAgICAgICAgICAgICAgICA/IGV2ZW50LmJvZHkudG9TdHJpbmcoKVxuICAgICAgICAgICAgICAgIDogZXZlbnQuYm9keTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9wcmVwYXJlSW50ZXJuYWxSZXF1ZXN0SW5mbyAoKSB7XG4gICAgICAgIGNvbnN0IHRlc3RSdW4gICAgICAgID0gdGVzdFJ1blRyYWNrZXIucmVzb2x2ZUNvbnRleHRUZXN0UnVuKCk7XG4gICAgICAgIGxldCBwcmVwYXJlZFJlcXVlc3RzID0gT2JqZWN0LnZhbHVlcyh0aGlzLl9pbnRlcm5hbFJlcXVlc3RzKTtcblxuICAgICAgICBpZiAodGVzdFJ1bilcbiAgICAgICAgICAgIHByZXBhcmVkUmVxdWVzdHMgPSBwcmVwYXJlZFJlcXVlc3RzLmZpbHRlcihyID0+IHIudGVzdFJ1bklkID09PSB0ZXN0UnVuLmlkKTtcblxuICAgICAgICByZXR1cm4gcHJlcGFyZWRSZXF1ZXN0cztcbiAgICB9XG5cbiAgICBfZ2V0Q29tcGxldGVkUmVxdWVzdHMgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcHJlcGFyZUludGVybmFsUmVxdWVzdEluZm8oKS5maWx0ZXIociA9PiByLnJlc3BvbnNlKTtcbiAgICB9XG5cbiAgICAvLyBBUElcbiAgICBjb250YWlucyAocHJlZGljYXRlKSB7XG4gICAgICAgIHJldHVybiBSZUV4ZWN1dGFibGVQcm9taXNlLmZyb21Gbihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gISF0aGlzLl9nZXRDb21wbGV0ZWRSZXF1ZXN0cygpLmZpbmQocHJlZGljYXRlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY291bnQgKHByZWRpY2F0ZSkge1xuICAgICAgICByZXR1cm4gUmVFeGVjdXRhYmxlUHJvbWlzZS5mcm9tRm4oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldENvbXBsZXRlZFJlcXVlc3RzKCkuZmlsdGVyKHByZWRpY2F0ZSkubGVuZ3RoO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjbGVhciAoKSB7XG4gICAgICAgIGNvbnN0IHRlc3RSdW4gPSB0ZXN0UnVuVHJhY2tlci5yZXNvbHZlQ29udGV4dFRlc3RSdW4oKTtcblxuICAgICAgICBpZiAodGVzdFJ1bikge1xuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy5faW50ZXJuYWxSZXF1ZXN0cykuZm9yRWFjaChpZCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2ludGVybmFsUmVxdWVzdHNbaWRdLnRlc3RSdW5JZCA9PT0gdGVzdFJ1bi5pZClcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2ludGVybmFsUmVxdWVzdHNbaWRdO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxSZXF1ZXN0cyA9IHt9O1xuICAgIH1cblxuICAgIGdldCByZXF1ZXN0cyAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9wcmVwYXJlSW50ZXJuYWxSZXF1ZXN0SW5mbygpO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlUmVxdWVzdExvZ2dlciAocmVxdWVzdEZpbHRlclJ1bGVJbml0LCBsb2dPcHRpb25zKSB7XG4gICAgcmV0dXJuIG5ldyBSZXF1ZXN0TG9nZ2VySW1wbGVtZW50YXRpb24ocmVxdWVzdEZpbHRlclJ1bGVJbml0LCBsb2dPcHRpb25zKTtcbn1cblxuIl19
