'use strict';

exports.__esModule = true;

var _set = require('babel-runtime/core-js/set');

var _set2 = _interopRequireDefault(_set);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _lodash = require('lodash');

var _getCallsite = require('../../errors/get-callsite');

var _clientFunctionBuilder = require('../../client-functions/client-function-builder');

var _clientFunctionBuilder2 = _interopRequireDefault(_clientFunctionBuilder);

var _assertion = require('./assertion');

var _assertion2 = _interopRequireDefault(_assertion);

var _delegatedApi = require('../../utils/delegated-api');

var _actions = require('../../test-run/commands/actions');

var _browserManipulation = require('../../test-run/commands/browser-manipulation');

var _observation = require('../../test-run/commands/observation');

var _assertType = require('../request-hooks/assert-type');

var _assertType2 = _interopRequireDefault(_assertType);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const originalThen = _pinkie2.default.resolve().then;

class TestController {
    constructor(testRun) {
        this.testRun = testRun;
        this.executionChain = _pinkie2.default.resolve();
        this.callsitesWithoutAwait = new _set2.default();
    }

    // NOTE: we track missing `awaits` by exposing a special custom Promise to user code.
    // Action or assertion is awaited if:
    // a)someone used `await` so Promise's `then` function executed
    // b)Promise chained by using one of the mixed-in controller methods
    //
    // In both scenarios, we check that callsite that produced Promise is equal to the one
    // that is currently missing await. This is required to workaround scenarios like this:
    //
    // var t2 = t.click('#btn1'); // <-- stores new callsiteWithoutAwait
    // await t2;                  // <-- callsiteWithoutAwait = null
    // t.click('#btn2');          // <-- stores new callsiteWithoutAwait
    // await t2.click('#btn3');   // <-- without check it will set callsiteWithoutAwait = null, so we will lost tracking
    _createExtendedPromise(promise, callsite) {
        const extendedPromise = promise.then(_lodash.identity);
        const markCallsiteAwaited = () => this.callsitesWithoutAwait.delete(callsite);

        extendedPromise.then = function () {
            markCallsiteAwaited();

            return originalThen.apply(this, arguments);
        };

        (0, _delegatedApi.delegateAPI)(extendedPromise, TestController.API_LIST, {
            handler: this,
            proxyMethod: markCallsiteAwaited
        });

        return extendedPromise;
    }

    _enqueueTask(apiMethodName, createTaskExecutor) {
        const callsite = (0, _getCallsite.getCallsiteForMethod)(apiMethodName);
        const executor = createTaskExecutor(callsite);

        this.executionChain.then = originalThen;
        this.executionChain = this.executionChain.then(executor);

        this.callsitesWithoutAwait.add(callsite);

        this.executionChain = this._createExtendedPromise(this.executionChain, callsite);

        return this.executionChain;
    }

    _enqueueCommand(apiMethodName, CmdCtor, cmdArgs) {
        return this._enqueueTask(apiMethodName, callsite => {
            let command = null;

            try {
                command = new CmdCtor(cmdArgs, this.testRun);
            } catch (err) {
                err.callsite = callsite;
                throw err;
            }

            return () => this.testRun.executeCommand(command, callsite);
        });
    }

    // API implementation
    // We need implementation methods to obtain correct callsites. If we use plain API
    // methods in chained wrappers then we will have callsite for the wrapped method
    // in this file instead of chained method callsite in user code.
    _ctx$getter() {
        return this.testRun.ctx;
    }

    _ctx$setter(val) {
        this.testRun.ctx = val;

        return this.testRun.ctx;
    }

    _fixtureCtx$getter() {
        return this.testRun.fixtureCtx;
    }

    _click$(selector, options) {
        return this._enqueueCommand('click', _actions.ClickCommand, { selector, options });
    }

    _rightClick$(selector, options) {
        return this._enqueueCommand('rightClick', _actions.RightClickCommand, { selector, options });
    }

    _doubleClick$(selector, options) {
        return this._enqueueCommand('doubleClick', _actions.DoubleClickCommand, { selector, options });
    }

    _hover$(selector, options) {
        return this._enqueueCommand('hover', _actions.HoverCommand, { selector, options });
    }

    _drag$(selector, dragOffsetX, dragOffsetY, options) {
        return this._enqueueCommand('drag', _actions.DragCommand, { selector, dragOffsetX, dragOffsetY, options });
    }

    _dragToElement$(selector, destinationSelector, options) {
        return this._enqueueCommand('dragToElement', _actions.DragToElementCommand, { selector, destinationSelector, options });
    }

    _typeText$(selector, text, options) {
        return this._enqueueCommand('typeText', _actions.TypeTextCommand, { selector, text, options });
    }

    _selectText$(selector, startPos, endPos, options) {
        return this._enqueueCommand('selectText', _actions.SelectTextCommand, { selector, startPos, endPos, options });
    }

    _selectTextAreaContent$(selector, startLine, startPos, endLine, endPos, options) {
        return this._enqueueCommand('selectTextAreaContent', _actions.SelectTextAreaContentCommand, {
            selector,
            startLine,
            startPos,
            endLine,
            endPos,
            options
        });
    }

    _selectEditableContent$(startSelector, endSelector, options) {
        return this._enqueueCommand('selectEditableContent', _actions.SelectEditableContentCommand, {
            startSelector,
            endSelector,
            options
        });
    }

    _pressKey$(keys, options) {
        return this._enqueueCommand('pressKey', _actions.PressKeyCommand, { keys, options });
    }

    _wait$(timeout) {
        return this._enqueueCommand('wait', _observation.WaitCommand, { timeout });
    }

    _navigateTo$(url) {
        return this._enqueueCommand('navigateTo', _actions.NavigateToCommand, { url });
    }

    _setFilesToUpload$(selector, filePath) {
        return this._enqueueCommand('setFilesToUpload', _actions.SetFilesToUploadCommand, { selector, filePath });
    }

    _clearUpload$(selector) {
        return this._enqueueCommand('clearUpload', _actions.ClearUploadCommand, { selector });
    }

    _takeScreenshot$(path) {
        return this._enqueueCommand('takeScreenshot', _browserManipulation.TakeScreenshotCommand, { path });
    }

    _takeElementScreenshot$(selector, ...args) {
        const commandArgs = { selector };

        if (args[1]) {
            commandArgs.path = args[0];
            commandArgs.options = args[1];
        } else if (typeof args[0] === 'object') commandArgs.options = args[0];else commandArgs.path = args[0];

        return this._enqueueCommand('takeElementScreenshot', _browserManipulation.TakeElementScreenshotCommand, commandArgs);
    }

    _resizeWindow$(width, height) {
        return this._enqueueCommand('resizeWindow', _browserManipulation.ResizeWindowCommand, { width, height });
    }

    _resizeWindowToFitDevice$(device, options) {
        return this._enqueueCommand('resizeWindowToFitDevice', _browserManipulation.ResizeWindowToFitDeviceCommand, { device, options });
    }

    _maximizeWindow$() {
        return this._enqueueCommand('maximizeWindow', _browserManipulation.MaximizeWindowCommand);
    }

    _switchToIframe$(selector) {
        return this._enqueueCommand('switchToIframe', _actions.SwitchToIframeCommand, { selector });
    }

    _switchToMainWindow$() {
        return this._enqueueCommand('switchToMainWindow', _actions.SwitchToMainWindowCommand);
    }

    _eval$(fn, options) {
        if (!(0, _lodash.isNil)(options)) options = (0, _lodash.assign)({}, options, { boundTestRun: this });

        const builder = new _clientFunctionBuilder2.default(fn, options, { instantiation: 'eval', execution: 'eval' });
        const clientFn = builder.getFunction();

        return clientFn();
    }

    _setNativeDialogHandler$(fn, options) {
        return this._enqueueCommand('setNativeDialogHandler', _actions.SetNativeDialogHandlerCommand, {
            dialogHandler: { fn, options }
        });
    }

    _getNativeDialogHistory$() {
        const callsite = (0, _getCallsite.getCallsiteForMethod)('getNativeDialogHistory');

        return this.testRun.executeCommand(new _actions.GetNativeDialogHistoryCommand(), callsite);
    }

    _getBrowserConsoleMessages$() {
        const callsite = (0, _getCallsite.getCallsiteForMethod)('getBrowserConsoleMessages');

        return this.testRun.executeCommand(new _actions.GetBrowserConsoleMessagesCommand(), callsite);
    }

    _expect$(actual) {
        const callsite = (0, _getCallsite.getCallsiteForMethod)('expect');

        return new _assertion2.default(actual, this, callsite);
    }

    _debug$() {
        return this._enqueueCommand('debug', _observation.DebugCommand);
    }

    _setTestSpeed$(speed) {
        return this._enqueueCommand('setTestSpeed', _actions.SetTestSpeedCommand, { speed });
    }

    _setPageLoadTimeout$(duration) {
        return this._enqueueCommand('setPageLoadTimeout', _actions.SetPageLoadTimeoutCommand, { duration });
    }

    _useRole$(role) {
        return this._enqueueCommand('useRole', _actions.UseRoleCommand, { role });
    }

    _addRequestHooks$(...hooks) {
        return this._enqueueTask('addRequestHooks', () => {
            hooks = (0, _lodash.flattenDeep)(hooks);

            (0, _assertType2.default)(hooks);

            hooks.forEach(hook => this.testRun.addRequestHook(hook));
        });
    }

    _removeRequestHooks$(...hooks) {
        return this._enqueueTask('removeRequestHooks', () => {
            hooks = (0, _lodash.flattenDeep)(hooks);

            (0, _assertType2.default)(hooks);

            hooks.forEach(hook => this.testRun.removeRequestHook(hook));
        });
    }
}

exports.default = TestController;
TestController.API_LIST = (0, _delegatedApi.getDelegatedAPIList)(TestController.prototype);

(0, _delegatedApi.delegateAPI)(TestController.prototype, TestController.API_LIST, { useCurrentCtxAsHandler: true });
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvdGVzdC1jb250cm9sbGVyL2luZGV4LmpzIl0sIm5hbWVzIjpbIm9yaWdpbmFsVGhlbiIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsIlRlc3RDb250cm9sbGVyIiwiY29uc3RydWN0b3IiLCJ0ZXN0UnVuIiwiZXhlY3V0aW9uQ2hhaW4iLCJjYWxsc2l0ZXNXaXRob3V0QXdhaXQiLCJfY3JlYXRlRXh0ZW5kZWRQcm9taXNlIiwicHJvbWlzZSIsImNhbGxzaXRlIiwiZXh0ZW5kZWRQcm9taXNlIiwiaWRlbnRpdHkiLCJtYXJrQ2FsbHNpdGVBd2FpdGVkIiwiZGVsZXRlIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJBUElfTElTVCIsImhhbmRsZXIiLCJwcm94eU1ldGhvZCIsIl9lbnF1ZXVlVGFzayIsImFwaU1ldGhvZE5hbWUiLCJjcmVhdGVUYXNrRXhlY3V0b3IiLCJleGVjdXRvciIsImFkZCIsIl9lbnF1ZXVlQ29tbWFuZCIsIkNtZEN0b3IiLCJjbWRBcmdzIiwiY29tbWFuZCIsImVyciIsImV4ZWN1dGVDb21tYW5kIiwiX2N0eCRnZXR0ZXIiLCJjdHgiLCJfY3R4JHNldHRlciIsInZhbCIsIl9maXh0dXJlQ3R4JGdldHRlciIsImZpeHR1cmVDdHgiLCJfY2xpY2skIiwic2VsZWN0b3IiLCJvcHRpb25zIiwiQ2xpY2tDb21tYW5kIiwiX3JpZ2h0Q2xpY2skIiwiUmlnaHRDbGlja0NvbW1hbmQiLCJfZG91YmxlQ2xpY2skIiwiRG91YmxlQ2xpY2tDb21tYW5kIiwiX2hvdmVyJCIsIkhvdmVyQ29tbWFuZCIsIl9kcmFnJCIsImRyYWdPZmZzZXRYIiwiZHJhZ09mZnNldFkiLCJEcmFnQ29tbWFuZCIsIl9kcmFnVG9FbGVtZW50JCIsImRlc3RpbmF0aW9uU2VsZWN0b3IiLCJEcmFnVG9FbGVtZW50Q29tbWFuZCIsIl90eXBlVGV4dCQiLCJ0ZXh0IiwiVHlwZVRleHRDb21tYW5kIiwiX3NlbGVjdFRleHQkIiwic3RhcnRQb3MiLCJlbmRQb3MiLCJTZWxlY3RUZXh0Q29tbWFuZCIsIl9zZWxlY3RUZXh0QXJlYUNvbnRlbnQkIiwic3RhcnRMaW5lIiwiZW5kTGluZSIsIlNlbGVjdFRleHRBcmVhQ29udGVudENvbW1hbmQiLCJfc2VsZWN0RWRpdGFibGVDb250ZW50JCIsInN0YXJ0U2VsZWN0b3IiLCJlbmRTZWxlY3RvciIsIlNlbGVjdEVkaXRhYmxlQ29udGVudENvbW1hbmQiLCJfcHJlc3NLZXkkIiwia2V5cyIsIlByZXNzS2V5Q29tbWFuZCIsIl93YWl0JCIsInRpbWVvdXQiLCJXYWl0Q29tbWFuZCIsIl9uYXZpZ2F0ZVRvJCIsInVybCIsIk5hdmlnYXRlVG9Db21tYW5kIiwiX3NldEZpbGVzVG9VcGxvYWQkIiwiZmlsZVBhdGgiLCJTZXRGaWxlc1RvVXBsb2FkQ29tbWFuZCIsIl9jbGVhclVwbG9hZCQiLCJDbGVhclVwbG9hZENvbW1hbmQiLCJfdGFrZVNjcmVlbnNob3QkIiwicGF0aCIsIlRha2VTY3JlZW5zaG90Q29tbWFuZCIsIl90YWtlRWxlbWVudFNjcmVlbnNob3QkIiwiYXJncyIsImNvbW1hbmRBcmdzIiwiVGFrZUVsZW1lbnRTY3JlZW5zaG90Q29tbWFuZCIsIl9yZXNpemVXaW5kb3ckIiwid2lkdGgiLCJoZWlnaHQiLCJSZXNpemVXaW5kb3dDb21tYW5kIiwiX3Jlc2l6ZVdpbmRvd1RvRml0RGV2aWNlJCIsImRldmljZSIsIlJlc2l6ZVdpbmRvd1RvRml0RGV2aWNlQ29tbWFuZCIsIl9tYXhpbWl6ZVdpbmRvdyQiLCJNYXhpbWl6ZVdpbmRvd0NvbW1hbmQiLCJfc3dpdGNoVG9JZnJhbWUkIiwiU3dpdGNoVG9JZnJhbWVDb21tYW5kIiwiX3N3aXRjaFRvTWFpbldpbmRvdyQiLCJTd2l0Y2hUb01haW5XaW5kb3dDb21tYW5kIiwiX2V2YWwkIiwiZm4iLCJib3VuZFRlc3RSdW4iLCJidWlsZGVyIiwiQ2xpZW50RnVuY3Rpb25CdWlsZGVyIiwiaW5zdGFudGlhdGlvbiIsImV4ZWN1dGlvbiIsImNsaWVudEZuIiwiZ2V0RnVuY3Rpb24iLCJfc2V0TmF0aXZlRGlhbG9nSGFuZGxlciQiLCJTZXROYXRpdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCIsImRpYWxvZ0hhbmRsZXIiLCJfZ2V0TmF0aXZlRGlhbG9nSGlzdG9yeSQiLCJHZXROYXRpdmVEaWFsb2dIaXN0b3J5Q29tbWFuZCIsIl9nZXRCcm93c2VyQ29uc29sZU1lc3NhZ2VzJCIsIkdldEJyb3dzZXJDb25zb2xlTWVzc2FnZXNDb21tYW5kIiwiX2V4cGVjdCQiLCJhY3R1YWwiLCJBc3NlcnRpb24iLCJfZGVidWckIiwiRGVidWdDb21tYW5kIiwiX3NldFRlc3RTcGVlZCQiLCJzcGVlZCIsIlNldFRlc3RTcGVlZENvbW1hbmQiLCJfc2V0UGFnZUxvYWRUaW1lb3V0JCIsImR1cmF0aW9uIiwiU2V0UGFnZUxvYWRUaW1lb3V0Q29tbWFuZCIsIl91c2VSb2xlJCIsInJvbGUiLCJVc2VSb2xlQ29tbWFuZCIsIl9hZGRSZXF1ZXN0SG9va3MkIiwiaG9va3MiLCJmb3JFYWNoIiwiaG9vayIsImFkZFJlcXVlc3RIb29rIiwiX3JlbW92ZVJlcXVlc3RIb29rcyQiLCJyZW1vdmVSZXF1ZXN0SG9vayIsInByb3RvdHlwZSIsInVzZUN1cnJlbnRDdHhBc0hhbmRsZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBRUE7O0FBeUJBOztBQVFBOztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxlQUFlQyxpQkFBUUMsT0FBUixHQUFrQkMsSUFBdkM7O0FBRWUsTUFBTUMsY0FBTixDQUFxQjtBQUNoQ0MsZ0JBQWFDLE9BQWIsRUFBc0I7QUFDbEIsYUFBS0EsT0FBTCxHQUE2QkEsT0FBN0I7QUFDQSxhQUFLQyxjQUFMLEdBQTZCTixpQkFBUUMsT0FBUixFQUE3QjtBQUNBLGFBQUtNLHFCQUFMLEdBQTZCLG1CQUE3QjtBQUNIOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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c0ksaUJBQWIsQ0FBK0JILElBQS9CLENBQXRCO0FBQ0gsU0FOTSxDQUFQO0FBT0g7QUF2UStCOztrQkFBZnJJLGM7QUEwUXJCQSxlQUFlYyxRQUFmLEdBQTBCLHVDQUFvQmQsZUFBZXlJLFNBQW5DLENBQTFCOztBQUVBLCtCQUFZekksZUFBZXlJLFNBQTNCLEVBQXNDekksZUFBZWMsUUFBckQsRUFBK0QsRUFBRTRILHdCQUF3QixJQUExQixFQUEvRCIsImZpbGUiOiJhcGkvdGVzdC1jb250cm9sbGVyL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCB7IGlkZW50aXR5LCBhc3NpZ24sIGlzTmlsIGFzIGlzTnVsbE9yVW5kZWZpbmVkLCBmbGF0dGVuRGVlcCBhcyBmbGF0dGVuIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGdldENhbGxzaXRlRm9yTWV0aG9kIH0gZnJvbSAnLi4vLi4vZXJyb3JzL2dldC1jYWxsc2l0ZSc7XG5pbXBvcnQgQ2xpZW50RnVuY3Rpb25CdWlsZGVyIGZyb20gJy4uLy4uL2NsaWVudC1mdW5jdGlvbnMvY2xpZW50LWZ1bmN0aW9uLWJ1aWxkZXInO1xuaW1wb3J0IEFzc2VydGlvbiBmcm9tICcuL2Fzc2VydGlvbic7XG5pbXBvcnQgeyBnZXREZWxlZ2F0ZWRBUElMaXN0LCBkZWxlZ2F0ZUFQSSB9IGZyb20gJy4uLy4uL3V0aWxzL2RlbGVnYXRlZC1hcGknO1xuXG5pbXBvcnQge1xuICAgIENsaWNrQ29tbWFuZCxcbiAgICBSaWdodENsaWNrQ29tbWFuZCxcbiAgICBEb3VibGVDbGlja0NvbW1hbmQsXG4gICAgSG92ZXJDb21tYW5kLFxuICAgIERyYWdDb21tYW5kLFxuICAgIERyYWdUb0VsZW1lbnRDb21tYW5kLFxuICAgIFR5cGVUZXh0Q29tbWFuZCxcbiAgICBTZWxlY3RUZXh0Q29tbWFuZCxcbiAgICBTZWxlY3RUZXh0QXJlYUNvbnRlbnRDb21tYW5kLFxuICAgIFNlbGVjdEVkaXRhYmxlQ29udGVudENvbW1hbmQsXG4gICAgUHJlc3NLZXlDb21tYW5kLFxuICAgIE5hdmlnYXRlVG9Db21tYW5kLFxuICAgIFNldEZpbGVzVG9VcGxvYWRDb21tYW5kLFxuICAgIENsZWFyVXBsb2FkQ29tbWFuZCxcbiAgICBTd2l0Y2hUb0lmcmFtZUNvbW1hbmQsXG4gICAgU3dpdGNoVG9NYWluV2luZG93Q29tbWFuZCxcbiAgICBTZXROYXRpdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCxcbiAgICBHZXROYXRpdmVEaWFsb2dIaXN0b3J5Q29tbWFuZCxcbiAgICBHZXRCcm93c2VyQ29uc29sZU1lc3NhZ2VzQ29tbWFuZCxcbiAgICBTZXRUZXN0U3BlZWRDb21tYW5kLFxuICAgIFNldFBhZ2VMb2FkVGltZW91dENvbW1hbmQsXG4gICAgVXNlUm9sZUNvbW1hbmRcbn0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvYWN0aW9ucyc7XG5cbmltcG9ydCB7XG4gICAgVGFrZVNjcmVlbnNob3RDb21tYW5kLFxuICAgIFRha2VFbGVtZW50U2NyZWVuc2hvdENvbW1hbmQsXG4gICAgUmVzaXplV2luZG93Q29tbWFuZCxcbiAgICBSZXNpemVXaW5kb3dUb0ZpdERldmljZUNvbW1hbmQsXG4gICAgTWF4aW1pemVXaW5kb3dDb21tYW5kXG59IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL2Jyb3dzZXItbWFuaXB1bGF0aW9uJztcblxuaW1wb3J0IHsgV2FpdENvbW1hbmQsIERlYnVnQ29tbWFuZCB9IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL29ic2VydmF0aW9uJztcbmltcG9ydCBhc3NlcnRSZXF1ZXN0SG9va1R5cGUgZnJvbSAnLi4vcmVxdWVzdC1ob29rcy9hc3NlcnQtdHlwZSc7XG5cbmNvbnN0IG9yaWdpbmFsVGhlbiA9IFByb21pc2UucmVzb2x2ZSgpLnRoZW47XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRlc3RDb250cm9sbGVyIHtcbiAgICBjb25zdHJ1Y3RvciAodGVzdFJ1bikge1xuICAgICAgICB0aGlzLnRlc3RSdW4gICAgICAgICAgICAgICA9IHRlc3RSdW47XG4gICAgICAgIHRoaXMuZXhlY3V0aW9uQ2hhaW4gICAgICAgID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIHRoaXMuY2FsbHNpdGVzV2l0aG91dEF3YWl0ID0gbmV3IFNldCgpO1xuICAgIH1cblxuICAgIC8vIE5PVEU6IHdlIHRyYWNrIG1pc3NpbmcgYGF3YWl0c2AgYnkgZXhwb3NpbmcgYSBzcGVjaWFsIGN1c3RvbSBQcm9taXNlIHRvIHVzZXIgY29kZS5cbiAgICAvLyBBY3Rpb24gb3IgYXNzZXJ0aW9uIGlzIGF3YWl0ZWQgaWY6XG4gICAgLy8gYSlzb21lb25lIHVzZWQgYGF3YWl0YCBzbyBQcm9taXNlJ3MgYHRoZW5gIGZ1bmN0aW9uIGV4ZWN1dGVkXG4gICAgLy8gYilQcm9taXNlIGNoYWluZWQgYnkgdXNpbmcgb25lIG9mIHRoZSBtaXhlZC1pbiBjb250cm9sbGVyIG1ldGhvZHNcbiAgICAvL1xuICAgIC8vIEluIGJvdGggc2NlbmFyaW9zLCB3ZSBjaGVjayB0aGF0IGNhbGxzaXRlIHRoYXQgcHJvZHVjZWQgUHJvbWlzZSBpcyBlcXVhbCB0byB0aGUgb25lXG4gICAgLy8gdGhhdCBpcyBjdXJyZW50bHkgbWlzc2luZyBhd2FpdC4gVGhpcyBpcyByZXF1aXJlZCB0byB3b3JrYXJvdW5kIHNjZW5hcmlvcyBsaWtlIHRoaXM6XG4gICAgLy9cbiAgICAvLyB2YXIgdDIgPSB0LmNsaWNrKCcjYnRuMScpOyAvLyA8LS0gc3RvcmVzIG5ldyBjYWxsc2l0ZVdpdGhvdXRBd2FpdFxuICAgIC8vIGF3YWl0IHQyOyAgICAgICAgICAgICAgICAgIC8vIDwtLSBjYWxsc2l0ZVdpdGhvdXRBd2FpdCA9IG51bGxcbiAgICAvLyB0LmNsaWNrKCcjYnRuMicpOyAgICAgICAgICAvLyA8LS0gc3RvcmVzIG5ldyBjYWxsc2l0ZVdpdGhvdXRBd2FpdFxuICAgIC8vIGF3YWl0IHQyLmNsaWNrKCcjYnRuMycpOyAgIC8vIDwtLSB3aXRob3V0IGNoZWNrIGl0IHdpbGwgc2V0IGNhbGxzaXRlV2l0aG91dEF3YWl0ID0gbnVsbCwgc28gd2Ugd2lsbCBsb3N0IHRyYWNraW5nXG4gICAgX2NyZWF0ZUV4dGVuZGVkUHJvbWlzZSAocHJvbWlzZSwgY2FsbHNpdGUpIHtcbiAgICAgICAgY29uc3QgZXh0ZW5kZWRQcm9taXNlICAgICA9IHByb21pc2UudGhlbihpZGVudGl0eSk7XG4gICAgICAgIGNvbnN0IG1hcmtDYWxsc2l0ZUF3YWl0ZWQgPSAoKSA9PiB0aGlzLmNhbGxzaXRlc1dpdGhvdXRBd2FpdC5kZWxldGUoY2FsbHNpdGUpO1xuXG4gICAgICAgIGV4dGVuZGVkUHJvbWlzZS50aGVuID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgbWFya0NhbGxzaXRlQXdhaXRlZCgpO1xuXG4gICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxUaGVuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZGVsZWdhdGVBUEkoZXh0ZW5kZWRQcm9taXNlLCBUZXN0Q29udHJvbGxlci5BUElfTElTVCwge1xuICAgICAgICAgICAgaGFuZGxlcjogICAgIHRoaXMsXG4gICAgICAgICAgICBwcm94eU1ldGhvZDogbWFya0NhbGxzaXRlQXdhaXRlZFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gZXh0ZW5kZWRQcm9taXNlO1xuICAgIH1cblxuICAgIF9lbnF1ZXVlVGFzayAoYXBpTWV0aG9kTmFtZSwgY3JlYXRlVGFza0V4ZWN1dG9yKSB7XG4gICAgICAgIGNvbnN0IGNhbGxzaXRlID0gZ2V0Q2FsbHNpdGVGb3JNZXRob2QoYXBpTWV0aG9kTmFtZSk7XG4gICAgICAgIGNvbnN0IGV4ZWN1dG9yID0gY3JlYXRlVGFza0V4ZWN1dG9yKGNhbGxzaXRlKTtcblxuICAgICAgICB0aGlzLmV4ZWN1dGlvbkNoYWluLnRoZW4gPSBvcmlnaW5hbFRoZW47XG4gICAgICAgIHRoaXMuZXhlY3V0aW9uQ2hhaW4gICAgICA9IHRoaXMuZXhlY3V0aW9uQ2hhaW4udGhlbihleGVjdXRvcik7XG5cbiAgICAgICAgdGhpcy5jYWxsc2l0ZXNXaXRob3V0QXdhaXQuYWRkKGNhbGxzaXRlKTtcblxuICAgICAgICB0aGlzLmV4ZWN1dGlvbkNoYWluID0gdGhpcy5fY3JlYXRlRXh0ZW5kZWRQcm9taXNlKHRoaXMuZXhlY3V0aW9uQ2hhaW4sIGNhbGxzaXRlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRpb25DaGFpbjtcbiAgICB9XG5cbiAgICBfZW5xdWV1ZUNvbW1hbmQgKGFwaU1ldGhvZE5hbWUsIENtZEN0b3IsIGNtZEFyZ3MpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVUYXNrKGFwaU1ldGhvZE5hbWUsIGNhbGxzaXRlID0+IHtcbiAgICAgICAgICAgIGxldCBjb21tYW5kID0gbnVsbDtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb21tYW5kID0gbmV3IENtZEN0b3IoY21kQXJncywgdGhpcy50ZXN0UnVuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICBlcnIuY2FsbHNpdGUgPSBjYWxsc2l0ZTtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiAoKSA9PiB0aGlzLnRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQoY29tbWFuZCwgY2FsbHNpdGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBBUEkgaW1wbGVtZW50YXRpb25cbiAgICAvLyBXZSBuZWVkIGltcGxlbWVudGF0aW9uIG1ldGhvZHMgdG8gb2J0YWluIGNvcnJlY3QgY2FsbHNpdGVzLiBJZiB3ZSB1c2UgcGxhaW4gQVBJXG4gICAgLy8gbWV0aG9kcyBpbiBjaGFpbmVkIHdyYXBwZXJzIHRoZW4gd2Ugd2lsbCBoYXZlIGNhbGxzaXRlIGZvciB0aGUgd3JhcHBlZCBtZXRob2RcbiAgICAvLyBpbiB0aGlzIGZpbGUgaW5zdGVhZCBvZiBjaGFpbmVkIG1ldGhvZCBjYWxsc2l0ZSBpbiB1c2VyIGNvZGUuXG4gICAgX2N0eCRnZXR0ZXIgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50ZXN0UnVuLmN0eDtcbiAgICB9XG5cbiAgICBfY3R4JHNldHRlciAodmFsKSB7XG4gICAgICAgIHRoaXMudGVzdFJ1bi5jdHggPSB2YWw7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFJ1bi5jdHg7XG4gICAgfVxuXG4gICAgX2ZpeHR1cmVDdHgkZ2V0dGVyICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFJ1bi5maXh0dXJlQ3R4O1xuICAgIH1cblxuICAgIF9jbGljayQgKHNlbGVjdG9yLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnY2xpY2snLCBDbGlja0NvbW1hbmQsIHsgc2VsZWN0b3IsIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX3JpZ2h0Q2xpY2skIChzZWxlY3Rvciwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3JpZ2h0Q2xpY2snLCBSaWdodENsaWNrQ29tbWFuZCwgeyBzZWxlY3Rvciwgb3B0aW9ucyB9KTtcbiAgICB9XG5cbiAgICBfZG91YmxlQ2xpY2skIChzZWxlY3Rvciwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ2RvdWJsZUNsaWNrJywgRG91YmxlQ2xpY2tDb21tYW5kLCB7IHNlbGVjdG9yLCBvcHRpb25zIH0pO1xuICAgIH1cblxuICAgIF9ob3ZlciQgKHNlbGVjdG9yLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnaG92ZXInLCBIb3ZlckNvbW1hbmQsIHsgc2VsZWN0b3IsIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX2RyYWckIChzZWxlY3RvciwgZHJhZ09mZnNldFgsIGRyYWdPZmZzZXRZLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnZHJhZycsIERyYWdDb21tYW5kLCB7IHNlbGVjdG9yLCBkcmFnT2Zmc2V0WCwgZHJhZ09mZnNldFksIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX2RyYWdUb0VsZW1lbnQkIChzZWxlY3RvciwgZGVzdGluYXRpb25TZWxlY3Rvciwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ2RyYWdUb0VsZW1lbnQnLCBEcmFnVG9FbGVtZW50Q29tbWFuZCwgeyBzZWxlY3RvciwgZGVzdGluYXRpb25TZWxlY3Rvciwgb3B0aW9ucyB9KTtcbiAgICB9XG5cbiAgICBfdHlwZVRleHQkIChzZWxlY3RvciwgdGV4dCwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3R5cGVUZXh0JywgVHlwZVRleHRDb21tYW5kLCB7IHNlbGVjdG9yLCB0ZXh0LCBvcHRpb25zIH0pO1xuICAgIH1cblxuICAgIF9zZWxlY3RUZXh0JCAoc2VsZWN0b3IsIHN0YXJ0UG9zLCBlbmRQb3MsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdzZWxlY3RUZXh0JywgU2VsZWN0VGV4dENvbW1hbmQsIHsgc2VsZWN0b3IsIHN0YXJ0UG9zLCBlbmRQb3MsIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX3NlbGVjdFRleHRBcmVhQ29udGVudCQgKHNlbGVjdG9yLCBzdGFydExpbmUsIHN0YXJ0UG9zLCBlbmRMaW5lLCBlbmRQb3MsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdzZWxlY3RUZXh0QXJlYUNvbnRlbnQnLCBTZWxlY3RUZXh0QXJlYUNvbnRlbnRDb21tYW5kLCB7XG4gICAgICAgICAgICBzZWxlY3RvcixcbiAgICAgICAgICAgIHN0YXJ0TGluZSxcbiAgICAgICAgICAgIHN0YXJ0UG9zLFxuICAgICAgICAgICAgZW5kTGluZSxcbiAgICAgICAgICAgIGVuZFBvcyxcbiAgICAgICAgICAgIG9wdGlvbnNcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3NlbGVjdEVkaXRhYmxlQ29udGVudCQgKHN0YXJ0U2VsZWN0b3IsIGVuZFNlbGVjdG9yLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnc2VsZWN0RWRpdGFibGVDb250ZW50JywgU2VsZWN0RWRpdGFibGVDb250ZW50Q29tbWFuZCwge1xuICAgICAgICAgICAgc3RhcnRTZWxlY3RvcixcbiAgICAgICAgICAgIGVuZFNlbGVjdG9yLFxuICAgICAgICAgICAgb3B0aW9uc1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcHJlc3NLZXkkIChrZXlzLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgncHJlc3NLZXknLCBQcmVzc0tleUNvbW1hbmQsIHsga2V5cywgb3B0aW9ucyB9KTtcbiAgICB9XG5cbiAgICBfd2FpdCQgKHRpbWVvdXQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCd3YWl0JywgV2FpdENvbW1hbmQsIHsgdGltZW91dCB9KTtcbiAgICB9XG5cbiAgICBfbmF2aWdhdGVUbyQgKHVybCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ25hdmlnYXRlVG8nLCBOYXZpZ2F0ZVRvQ29tbWFuZCwgeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgX3NldEZpbGVzVG9VcGxvYWQkIChzZWxlY3RvciwgZmlsZVBhdGgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdzZXRGaWxlc1RvVXBsb2FkJywgU2V0RmlsZXNUb1VwbG9hZENvbW1hbmQsIHsgc2VsZWN0b3IsIGZpbGVQYXRoIH0pO1xuICAgIH1cblxuICAgIF9jbGVhclVwbG9hZCQgKHNlbGVjdG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnY2xlYXJVcGxvYWQnLCBDbGVhclVwbG9hZENvbW1hbmQsIHsgc2VsZWN0b3IgfSk7XG4gICAgfVxuXG4gICAgX3Rha2VTY3JlZW5zaG90JCAocGF0aCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3Rha2VTY3JlZW5zaG90JywgVGFrZVNjcmVlbnNob3RDb21tYW5kLCB7IHBhdGggfSk7XG4gICAgfVxuXG4gICAgX3Rha2VFbGVtZW50U2NyZWVuc2hvdCQgKHNlbGVjdG9yLCAuLi5hcmdzKSB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmRBcmdzID0geyBzZWxlY3RvciB9O1xuXG4gICAgICAgIGlmIChhcmdzWzFdKSB7XG4gICAgICAgICAgICBjb21tYW5kQXJncy5wYXRoICAgID0gYXJnc1swXTtcbiAgICAgICAgICAgIGNvbW1hbmRBcmdzLm9wdGlvbnMgPSBhcmdzWzFdO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnb2JqZWN0JylcbiAgICAgICAgICAgIGNvbW1hbmRBcmdzLm9wdGlvbnMgPSBhcmdzWzBdO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBjb21tYW5kQXJncy5wYXRoID0gYXJnc1swXTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3Rha2VFbGVtZW50U2NyZWVuc2hvdCcsIFRha2VFbGVtZW50U2NyZWVuc2hvdENvbW1hbmQsIGNvbW1hbmRBcmdzKTtcbiAgICB9XG5cbiAgICBfcmVzaXplV2luZG93JCAod2lkdGgsIGhlaWdodCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3Jlc2l6ZVdpbmRvdycsIFJlc2l6ZVdpbmRvd0NvbW1hbmQsIHsgd2lkdGgsIGhlaWdodCB9KTtcbiAgICB9XG5cbiAgICBfcmVzaXplV2luZG93VG9GaXREZXZpY2UkIChkZXZpY2UsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdyZXNpemVXaW5kb3dUb0ZpdERldmljZScsIFJlc2l6ZVdpbmRvd1RvRml0RGV2aWNlQ29tbWFuZCwgeyBkZXZpY2UsIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX21heGltaXplV2luZG93JCAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnbWF4aW1pemVXaW5kb3cnLCBNYXhpbWl6ZVdpbmRvd0NvbW1hbmQpO1xuICAgIH1cblxuICAgIF9zd2l0Y2hUb0lmcmFtZSQgKHNlbGVjdG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnc3dpdGNoVG9JZnJhbWUnLCBTd2l0Y2hUb0lmcmFtZUNvbW1hbmQsIHsgc2VsZWN0b3IgfSk7XG4gICAgfVxuXG4gICAgX3N3aXRjaFRvTWFpbldpbmRvdyQgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3N3aXRjaFRvTWFpbldpbmRvdycsIFN3aXRjaFRvTWFpbldpbmRvd0NvbW1hbmQpO1xuICAgIH1cblxuICAgIF9ldmFsJCAoZm4sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFpc051bGxPclVuZGVmaW5lZChvcHRpb25zKSlcbiAgICAgICAgICAgIG9wdGlvbnMgPSBhc3NpZ24oe30sIG9wdGlvbnMsIHsgYm91bmRUZXN0UnVuOiB0aGlzIH0pO1xuXG4gICAgICAgIGNvbnN0IGJ1aWxkZXIgID0gbmV3IENsaWVudEZ1bmN0aW9uQnVpbGRlcihmbiwgb3B0aW9ucywgeyBpbnN0YW50aWF0aW9uOiAnZXZhbCcsIGV4ZWN1dGlvbjogJ2V2YWwnIH0pO1xuICAgICAgICBjb25zdCBjbGllbnRGbiA9IGJ1aWxkZXIuZ2V0RnVuY3Rpb24oKTtcblxuICAgICAgICByZXR1cm4gY2xpZW50Rm4oKTtcbiAgICB9XG5cbiAgICBfc2V0TmF0aXZlRGlhbG9nSGFuZGxlciQgKGZuLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnc2V0TmF0aXZlRGlhbG9nSGFuZGxlcicsIFNldE5hdGl2ZURpYWxvZ0hhbmRsZXJDb21tYW5kLCB7XG4gICAgICAgICAgICBkaWFsb2dIYW5kbGVyOiB7IGZuLCBvcHRpb25zIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX2dldE5hdGl2ZURpYWxvZ0hpc3RvcnkkICgpIHtcbiAgICAgICAgY29uc3QgY2FsbHNpdGUgPSBnZXRDYWxsc2l0ZUZvck1ldGhvZCgnZ2V0TmF0aXZlRGlhbG9nSGlzdG9yeScpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQobmV3IEdldE5hdGl2ZURpYWxvZ0hpc3RvcnlDb21tYW5kKCksIGNhbGxzaXRlKTtcbiAgICB9XG5cbiAgICBfZ2V0QnJvd3NlckNvbnNvbGVNZXNzYWdlcyQgKCkge1xuICAgICAgICBjb25zdCBjYWxsc2l0ZSA9IGdldENhbGxzaXRlRm9yTWV0aG9kKCdnZXRCcm93c2VyQ29uc29sZU1lc3NhZ2VzJyk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFJ1bi5leGVjdXRlQ29tbWFuZChuZXcgR2V0QnJvd3NlckNvbnNvbGVNZXNzYWdlc0NvbW1hbmQoKSwgY2FsbHNpdGUpO1xuICAgIH1cblxuICAgIF9leHBlY3QkIChhY3R1YWwpIHtcbiAgICAgICAgY29uc3QgY2FsbHNpdGUgPSBnZXRDYWxsc2l0ZUZvck1ldGhvZCgnZXhwZWN0Jyk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBBc3NlcnRpb24oYWN0dWFsLCB0aGlzLCBjYWxsc2l0ZSk7XG4gICAgfVxuXG4gICAgX2RlYnVnJCAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnZGVidWcnLCBEZWJ1Z0NvbW1hbmQpO1xuICAgIH1cblxuICAgIF9zZXRUZXN0U3BlZWQkIChzcGVlZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3NldFRlc3RTcGVlZCcsIFNldFRlc3RTcGVlZENvbW1hbmQsIHsgc3BlZWQgfSk7XG4gICAgfVxuXG4gICAgX3NldFBhZ2VMb2FkVGltZW91dCQgKGR1cmF0aW9uKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnc2V0UGFnZUxvYWRUaW1lb3V0JywgU2V0UGFnZUxvYWRUaW1lb3V0Q29tbWFuZCwgeyBkdXJhdGlvbiB9KTtcbiAgICB9XG5cbiAgICBfdXNlUm9sZSQgKHJvbGUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCd1c2VSb2xlJywgVXNlUm9sZUNvbW1hbmQsIHsgcm9sZSB9KTtcbiAgICB9XG5cbiAgICBfYWRkUmVxdWVzdEhvb2tzJCAoLi4uaG9va3MpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVUYXNrKCdhZGRSZXF1ZXN0SG9va3MnLCAoKSA9PiB7XG4gICAgICAgICAgICBob29rcyA9IGZsYXR0ZW4oaG9va3MpO1xuXG4gICAgICAgICAgICBhc3NlcnRSZXF1ZXN0SG9va1R5cGUoaG9va3MpO1xuXG4gICAgICAgICAgICBob29rcy5mb3JFYWNoKGhvb2sgPT4gdGhpcy50ZXN0UnVuLmFkZFJlcXVlc3RIb29rKGhvb2spKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3JlbW92ZVJlcXVlc3RIb29rcyQgKC4uLmhvb2tzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlVGFzaygncmVtb3ZlUmVxdWVzdEhvb2tzJywgKCkgPT4ge1xuICAgICAgICAgICAgaG9va3MgPSBmbGF0dGVuKGhvb2tzKTtcblxuICAgICAgICAgICAgYXNzZXJ0UmVxdWVzdEhvb2tUeXBlKGhvb2tzKTtcblxuICAgICAgICAgICAgaG9va3MuZm9yRWFjaChob29rID0+IHRoaXMudGVzdFJ1bi5yZW1vdmVSZXF1ZXN0SG9vayhob29rKSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuVGVzdENvbnRyb2xsZXIuQVBJX0xJU1QgPSBnZXREZWxlZ2F0ZWRBUElMaXN0KFRlc3RDb250cm9sbGVyLnByb3RvdHlwZSk7XG5cbmRlbGVnYXRlQVBJKFRlc3RDb250cm9sbGVyLnByb3RvdHlwZSwgVGVzdENvbnRyb2xsZXIuQVBJX0xJU1QsIHsgdXNlQ3VycmVudEN0eEFzSGFuZGxlcjogdHJ1ZSB9KTtcbiJdfQ==
