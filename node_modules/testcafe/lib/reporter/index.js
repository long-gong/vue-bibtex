'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _lodash = require('lodash');

var _isStream = require('is-stream');

var _pluginHost = require('./plugin-host');

var _pluginHost2 = _interopRequireDefault(_pluginHost);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Reporter {
    constructor(plugin, task, outStream) {
        this.plugin = new _pluginHost2.default(plugin, outStream);
        this.task = task;

        this.disposed = false;
        this.passed = 0;
        this.skipped = task.tests.filter(test => test.skip).length;
        this.testCount = task.tests.length - this.skipped;
        this.reportQueue = Reporter._createReportQueue(task);
        this.stopOnFirstFail = task.opts.stopOnFirstFail;
        this.outStream = outStream;

        this._assignTaskEventHandlers();
    }

    static _isSpecialStream(stream) {
        return stream.isTTY || stream === process.stdout || stream === process.stderr;
    }

    static _createPendingPromise() {
        let resolver = null;

        const promise = new _pinkie2.default(resolve => {
            resolver = resolve;
        });

        promise.resolve = resolver;

        return promise;
    }

    static _createReportItem(test, runsPerTest) {
        return {
            fixture: test.fixture,
            test: test,
            screenshotPath: null,
            screenshots: [],
            quarantine: null,
            errs: [],
            unstable: false,
            startTime: null,
            testRunInfo: null,

            pendingRuns: runsPerTest,
            pendingPromise: Reporter._createPendingPromise()
        };
    }

    static _createReportQueue(task) {
        const runsPerTest = task.browserConnectionGroups.length;

        return task.tests.map(test => Reporter._createReportItem(test, runsPerTest));
    }

    static _createTestRunInfo(reportItem) {
        return {
            errs: (0, _lodash.sortBy)(reportItem.errs, ['userAgent', 'type']),
            durationMs: new Date() - reportItem.startTime,
            unstable: reportItem.unstable,
            screenshotPath: reportItem.screenshotPath,
            screenshots: reportItem.screenshots,
            quarantine: reportItem.quarantine,
            skipped: reportItem.test.skip
        };
    }

    _getReportItemForTestRun(testRun) {
        return (0, _lodash.find)(this.reportQueue, i => i.test === testRun.test);
    }

    _shiftReportQueue(reportItem) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            let currentFixture = null;
            let nextReportItem = null;

            while (_this.reportQueue.length && _this.reportQueue[0].testRunInfo) {
                reportItem = _this.reportQueue.shift();
                currentFixture = reportItem.fixture;

                yield _this.plugin.reportTestDone(reportItem.test.name, reportItem.testRunInfo, reportItem.test.meta);

                // NOTE: here we assume that tests are sorted by fixture.
                // Therefore, if the next report item has a different
                // fixture, we can report this fixture start.
                nextReportItem = _this.reportQueue[0];

                if (nextReportItem && nextReportItem.fixture !== currentFixture) yield _this.plugin.reportFixtureStart(nextReportItem.fixture.name, nextReportItem.fixture.path, nextReportItem.fixture.meta);
            }
        })();
    }

    _resolveReportItem(reportItem, testRun) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this2.task.screenshots.hasCapturedFor(testRun.test)) {
                reportItem.screenshotPath = _this2.task.screenshots.getPathFor(testRun.test);
                reportItem.screenshots = _this2.task.screenshots.getScreenshotsInfo(testRun.test);
            }

            if (testRun.quarantine) {
                reportItem.quarantine = testRun.quarantine.attempts.reduce(function (result, errors, index) {
                    const passed = !errors.length;
                    const quarantineAttempt = index + 1;

                    result[quarantineAttempt] = { passed };

                    return result;
                }, {});
            }

            if (!reportItem.testRunInfo) {
                reportItem.testRunInfo = Reporter._createTestRunInfo(reportItem);

                if (!reportItem.errs.length && !reportItem.test.skip) _this2.passed++;
            }

            yield _this2._shiftReportQueue(reportItem);

            reportItem.pendingPromise.resolve();
        })();
    }

    _assignTaskEventHandlers() {
        var _this3 = this;

        const task = this.task;

        task.once('start', (0, _asyncToGenerator3.default)(function* () {
            const startTime = new Date();
            const userAgents = task.browserConnectionGroups.map(function (group) {
                return group[0].userAgent;
            });
            const first = _this3.reportQueue[0];

            yield _this3.plugin.reportTaskStart(startTime, userAgents, _this3.testCount);
            yield _this3.plugin.reportFixtureStart(first.fixture.name, first.fixture.path, first.fixture.meta);
        }));

        task.on('test-run-start', testRun => {
            const reportItem = this._getReportItemForTestRun(testRun);

            if (!reportItem.startTime) reportItem.startTime = new Date();
        });

        task.on('test-run-done', (() => {
            var _ref2 = (0, _asyncToGenerator3.default)(function* (testRun) {
                const reportItem = _this3._getReportItemForTestRun(testRun);
                const isTestRunStoppedTaskExecution = !!testRun.errs.length && _this3.stopOnFirstFail;

                reportItem.pendingRuns = isTestRunStoppedTaskExecution ? 0 : reportItem.pendingRuns - 1;
                reportItem.unstable = reportItem.unstable || testRun.unstable;
                reportItem.errs = reportItem.errs.concat(testRun.errs);

                if (!reportItem.pendingRuns) yield _this3._resolveReportItem(reportItem, testRun);

                yield reportItem.pendingPromise;
            });

            return function (_x) {
                return _ref2.apply(this, arguments);
            };
        })());

        task.once('done', (0, _asyncToGenerator3.default)(function* () {
            const endTime = new Date();

            yield _this3.plugin.reportTaskDone(endTime, _this3.passed, task.warningLog.messages);
        }));
    }

    dispose() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this4.disposed) return;

            _this4.disposed = true;

            if (!_this4.outStream || Reporter._isSpecialStream(_this4.outStream) || !(0, _isStream.writable)(_this4.outStream)) return;

            _this4.outStream.end();

            yield new _pinkie2.default(function (resolve) {
                _this4.outStream.once('finish', resolve);
                _this4.outStream.once('error', resolve);
            });
        })();
    }
}
exports.default = Reporter;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXBvcnRlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJSZXBvcnRlciIsImNvbnN0cnVjdG9yIiwicGx1Z2luIiwidGFzayIsIm91dFN0cmVhbSIsIlJlcG9ydGVyUGx1Z2luSG9zdCIsImRpc3Bvc2VkIiwicGFzc2VkIiwic2tpcHBlZCIsInRlc3RzIiwiZmlsdGVyIiwidGVzdCIsInNraXAiLCJsZW5ndGgiLCJ0ZXN0Q291bnQiLCJyZXBvcnRRdWV1ZSIsIl9jcmVhdGVSZXBvcnRRdWV1ZSIsInN0b3BPbkZpcnN0RmFpbCIsIm9wdHMiLCJfYXNzaWduVGFza0V2ZW50SGFuZGxlcnMiLCJfaXNTcGVjaWFsU3RyZWFtIiwic3RyZWFtIiwiaXNUVFkiLCJwcm9jZXNzIiwic3Rkb3V0Iiwic3RkZXJyIiwiX2NyZWF0ZVBlbmRpbmdQcm9taXNlIiwicmVzb2x2ZXIiLCJwcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJfY3JlYXRlUmVwb3J0SXRlbSIsInJ1bnNQZXJUZXN0IiwiZml4dHVyZSIsInNjcmVlbnNob3RQYXRoIiwic2NyZWVuc2hvdHMiLCJxdWFyYW50aW5lIiwiZXJycyIsInVuc3RhYmxlIiwic3RhcnRUaW1lIiwidGVzdFJ1bkluZm8iLCJwZW5kaW5nUnVucyIsInBlbmRpbmdQcm9taXNlIiwiYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMiLCJtYXAiLCJfY3JlYXRlVGVzdFJ1bkluZm8iLCJyZXBvcnRJdGVtIiwiZHVyYXRpb25NcyIsIkRhdGUiLCJfZ2V0UmVwb3J0SXRlbUZvclRlc3RSdW4iLCJ0ZXN0UnVuIiwiaSIsIl9zaGlmdFJlcG9ydFF1ZXVlIiwiY3VycmVudEZpeHR1cmUiLCJuZXh0UmVwb3J0SXRlbSIsInNoaWZ0IiwicmVwb3J0VGVzdERvbmUiLCJuYW1lIiwibWV0YSIsInJlcG9ydEZpeHR1cmVTdGFydCIsInBhdGgiLCJfcmVzb2x2ZVJlcG9ydEl0ZW0iLCJoYXNDYXB0dXJlZEZvciIsImdldFBhdGhGb3IiLCJnZXRTY3JlZW5zaG90c0luZm8iLCJhdHRlbXB0cyIsInJlZHVjZSIsInJlc3VsdCIsImVycm9ycyIsImluZGV4IiwicXVhcmFudGluZUF0dGVtcHQiLCJvbmNlIiwidXNlckFnZW50cyIsImdyb3VwIiwidXNlckFnZW50IiwiZmlyc3QiLCJyZXBvcnRUYXNrU3RhcnQiLCJvbiIsImlzVGVzdFJ1blN0b3BwZWRUYXNrRXhlY3V0aW9uIiwiY29uY2F0IiwiZW5kVGltZSIsInJlcG9ydFRhc2tEb25lIiwid2FybmluZ0xvZyIsIm1lc3NhZ2VzIiwiZGlzcG9zZSIsImVuZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFFZSxNQUFNQSxRQUFOLENBQWU7QUFDMUJDLGdCQUFhQyxNQUFiLEVBQXFCQyxJQUFyQixFQUEyQkMsU0FBM0IsRUFBc0M7QUFDbEMsYUFBS0YsTUFBTCxHQUFjLElBQUlHLG9CQUFKLENBQXVCSCxNQUF2QixFQUErQkUsU0FBL0IsQ0FBZDtBQUNBLGFBQUtELElBQUwsR0FBY0EsSUFBZDs7QUFFQSxhQUFLRyxRQUFMLEdBQXVCLEtBQXZCO0FBQ0EsYUFBS0MsTUFBTCxHQUF1QixDQUF2QjtBQUNBLGFBQUtDLE9BQUwsR0FBdUJMLEtBQUtNLEtBQUwsQ0FBV0MsTUFBWCxDQUFrQkMsUUFBUUEsS0FBS0MsSUFBL0IsRUFBcUNDLE1BQTVEO0FBQ0EsYUFBS0MsU0FBTCxHQUF1QlgsS0FBS00sS0FBTCxDQUFXSSxNQUFYLEdBQW9CLEtBQUtMLE9BQWhEO0FBQ0EsYUFBS08sV0FBTCxHQUF1QmYsU0FBU2dCLGtCQUFULENBQTRCYixJQUE1QixDQUF2QjtBQUNBLGFBQUtjLGVBQUwsR0FBdUJkLEtBQUtlLElBQUwsQ0FBVUQsZUFBakM7QUFDQSxhQUFLYixTQUFMLEdBQXVCQSxTQUF2Qjs7QUFFQSxhQUFLZSx3QkFBTDtBQUNIOztBQUVELFdBQU9DLGdCQUFQLENBQXlCQyxNQUF6QixFQUFpQztBQUM3QixlQUFPQSxPQUFPQyxLQUFQLElBQWdCRCxXQUFXRSxRQUFRQyxNQUFuQyxJQUE2Q0gsV0FBV0UsUUFBUUUsTUFBdkU7QUFDSDs7QUFFRCxXQUFPQyxxQkFBUCxHQUFnQztBQUM1QixZQUFJQyxXQUFXLElBQWY7O0FBRUEsY0FBTUMsVUFBVSxJQUFJQyxnQkFBSixDQUFZQyxXQUFXO0FBQ25DSCx1QkFBV0csT0FBWDtBQUNILFNBRmUsQ0FBaEI7O0FBSUFGLGdCQUFRRSxPQUFSLEdBQWtCSCxRQUFsQjs7QUFFQSxlQUFPQyxPQUFQO0FBQ0g7O0FBRUQsV0FBT0csaUJBQVAsQ0FBMEJwQixJQUExQixFQUFnQ3FCLFdBQWhDLEVBQTZDO0FBQ3pDLGVBQU87QUFDSEMscUJBQWdCdEIsS0FBS3NCLE9BRGxCO0FBRUh0QixrQkFBZ0JBLElBRmI7QUFHSHVCLDRCQUFnQixJQUhiO0FBSUhDLHlCQUFnQixFQUpiO0FBS0hDLHdCQUFnQixJQUxiO0FBTUhDLGtCQUFnQixFQU5iO0FBT0hDLHNCQUFnQixLQVBiO0FBUUhDLHVCQUFnQixJQVJiO0FBU0hDLHlCQUFnQixJQVRiOztBQVdIQyx5QkFBZ0JULFdBWGI7QUFZSFUsNEJBQWdCMUMsU0FBUzBCLHFCQUFUO0FBWmIsU0FBUDtBQWNIOztBQUVELFdBQU9WLGtCQUFQLENBQTJCYixJQUEzQixFQUFpQztBQUM3QixjQUFNNkIsY0FBYzdCLEtBQUt3Qyx1QkFBTCxDQUE2QjlCLE1BQWpEOztBQUVBLGVBQU9WLEtBQUtNLEtBQUwsQ0FBV21DLEdBQVgsQ0FBZWpDLFFBQVFYLFNBQVMrQixpQkFBVCxDQUEyQnBCLElBQTNCLEVBQWlDcUIsV0FBakMsQ0FBdkIsQ0FBUDtBQUNIOztBQUVELFdBQU9hLGtCQUFQLENBQTJCQyxVQUEzQixFQUF1QztBQUNuQyxlQUFPO0FBQ0hULGtCQUFnQixvQkFBT1MsV0FBV1QsSUFBbEIsRUFBd0IsQ0FBQyxXQUFELEVBQWMsTUFBZCxDQUF4QixDQURiO0FBRUhVLHdCQUFnQixJQUFJQyxJQUFKLEtBQWFGLFdBQVdQLFNBRnJDO0FBR0hELHNCQUFnQlEsV0FBV1IsUUFIeEI7QUFJSEosNEJBQWdCWSxXQUFXWixjQUp4QjtBQUtIQyx5QkFBZ0JXLFdBQVdYLFdBTHhCO0FBTUhDLHdCQUFnQlUsV0FBV1YsVUFOeEI7QUFPSDVCLHFCQUFnQnNDLFdBQVduQyxJQUFYLENBQWdCQztBQVA3QixTQUFQO0FBU0g7O0FBRURxQyw2QkFBMEJDLE9BQTFCLEVBQW1DO0FBQy9CLGVBQU8sa0JBQUssS0FBS25DLFdBQVYsRUFBdUJvQyxLQUFLQSxFQUFFeEMsSUFBRixLQUFXdUMsUUFBUXZDLElBQS9DLENBQVA7QUFDSDs7QUFFS3lDLHFCQUFOLENBQXlCTixVQUF6QixFQUFxQztBQUFBOztBQUFBO0FBQ2pDLGdCQUFJTyxpQkFBaUIsSUFBckI7QUFDQSxnQkFBSUMsaUJBQWlCLElBQXJCOztBQUVBLG1CQUFPLE1BQUt2QyxXQUFMLENBQWlCRixNQUFqQixJQUEyQixNQUFLRSxXQUFMLENBQWlCLENBQWpCLEVBQW9CeUIsV0FBdEQsRUFBbUU7QUFDL0RNLDZCQUFpQixNQUFLL0IsV0FBTCxDQUFpQndDLEtBQWpCLEVBQWpCO0FBQ0FGLGlDQUFpQlAsV0FBV2IsT0FBNUI7O0FBRUEsc0JBQU0sTUFBSy9CLE1BQUwsQ0FBWXNELGNBQVosQ0FBMkJWLFdBQVduQyxJQUFYLENBQWdCOEMsSUFBM0MsRUFBaURYLFdBQVdOLFdBQTVELEVBQXlFTSxXQUFXbkMsSUFBWCxDQUFnQitDLElBQXpGLENBQU47O0FBRUE7QUFDQTtBQUNBO0FBQ0FKLGlDQUFpQixNQUFLdkMsV0FBTCxDQUFpQixDQUFqQixDQUFqQjs7QUFFQSxvQkFBSXVDLGtCQUFrQkEsZUFBZXJCLE9BQWYsS0FBMkJvQixjQUFqRCxFQUNJLE1BQU0sTUFBS25ELE1BQUwsQ0FBWXlELGtCQUFaLENBQStCTCxlQUFlckIsT0FBZixDQUF1QndCLElBQXRELEVBQTRESCxlQUFlckIsT0FBZixDQUF1QjJCLElBQW5GLEVBQXlGTixlQUFlckIsT0FBZixDQUF1QnlCLElBQWhILENBQU47QUFDUDtBQWpCZ0M7QUFrQnBDOztBQUVLRyxzQkFBTixDQUEwQmYsVUFBMUIsRUFBc0NJLE9BQXRDLEVBQStDO0FBQUE7O0FBQUE7QUFDM0MsZ0JBQUksT0FBSy9DLElBQUwsQ0FBVWdDLFdBQVYsQ0FBc0IyQixjQUF0QixDQUFxQ1osUUFBUXZDLElBQTdDLENBQUosRUFBd0Q7QUFDcERtQywyQkFBV1osY0FBWCxHQUE0QixPQUFLL0IsSUFBTCxDQUFVZ0MsV0FBVixDQUFzQjRCLFVBQXRCLENBQWlDYixRQUFRdkMsSUFBekMsQ0FBNUI7QUFDQW1DLDJCQUFXWCxXQUFYLEdBQTRCLE9BQUtoQyxJQUFMLENBQVVnQyxXQUFWLENBQXNCNkIsa0JBQXRCLENBQXlDZCxRQUFRdkMsSUFBakQsQ0FBNUI7QUFDSDs7QUFFRCxnQkFBSXVDLFFBQVFkLFVBQVosRUFBd0I7QUFDcEJVLDJCQUFXVixVQUFYLEdBQXdCYyxRQUFRZCxVQUFSLENBQW1CNkIsUUFBbkIsQ0FBNEJDLE1BQTVCLENBQW1DLFVBQUNDLE1BQUQsRUFBU0MsTUFBVCxFQUFpQkMsS0FBakIsRUFBMkI7QUFDbEYsMEJBQU05RCxTQUFvQixDQUFDNkQsT0FBT3ZELE1BQWxDO0FBQ0EsMEJBQU15RCxvQkFBb0JELFFBQVEsQ0FBbEM7O0FBRUFGLDJCQUFPRyxpQkFBUCxJQUE0QixFQUFFL0QsTUFBRixFQUE1Qjs7QUFFQSwyQkFBTzRELE1BQVA7QUFDSCxpQkFQdUIsRUFPckIsRUFQcUIsQ0FBeEI7QUFRSDs7QUFFRCxnQkFBSSxDQUFDckIsV0FBV04sV0FBaEIsRUFBNkI7QUFDekJNLDJCQUFXTixXQUFYLEdBQXlCeEMsU0FBUzZDLGtCQUFULENBQTRCQyxVQUE1QixDQUF6Qjs7QUFFQSxvQkFBSSxDQUFDQSxXQUFXVCxJQUFYLENBQWdCeEIsTUFBakIsSUFBMkIsQ0FBQ2lDLFdBQVduQyxJQUFYLENBQWdCQyxJQUFoRCxFQUNJLE9BQUtMLE1BQUw7QUFDUDs7QUFFRCxrQkFBTSxPQUFLNkMsaUJBQUwsQ0FBdUJOLFVBQXZCLENBQU47O0FBRUFBLHVCQUFXSixjQUFYLENBQTBCWixPQUExQjtBQTFCMkM7QUEyQjlDOztBQUVEWCwrQkFBNEI7QUFBQTs7QUFDeEIsY0FBTWhCLE9BQU8sS0FBS0EsSUFBbEI7O0FBRUFBLGFBQUtvRSxJQUFMLENBQVUsT0FBVixrQ0FBbUIsYUFBWTtBQUMzQixrQkFBTWhDLFlBQWEsSUFBSVMsSUFBSixFQUFuQjtBQUNBLGtCQUFNd0IsYUFBYXJFLEtBQUt3Qyx1QkFBTCxDQUE2QkMsR0FBN0IsQ0FBaUM7QUFBQSx1QkFBUzZCLE1BQU0sQ0FBTixFQUFTQyxTQUFsQjtBQUFBLGFBQWpDLENBQW5CO0FBQ0Esa0JBQU1DLFFBQWEsT0FBSzVELFdBQUwsQ0FBaUIsQ0FBakIsQ0FBbkI7O0FBRUEsa0JBQU0sT0FBS2IsTUFBTCxDQUFZMEUsZUFBWixDQUE0QnJDLFNBQTVCLEVBQXVDaUMsVUFBdkMsRUFBbUQsT0FBSzFELFNBQXhELENBQU47QUFDQSxrQkFBTSxPQUFLWixNQUFMLENBQVl5RCxrQkFBWixDQUErQmdCLE1BQU0xQyxPQUFOLENBQWN3QixJQUE3QyxFQUFtRGtCLE1BQU0xQyxPQUFOLENBQWMyQixJQUFqRSxFQUF1RWUsTUFBTTFDLE9BQU4sQ0FBY3lCLElBQXJGLENBQU47QUFDSCxTQVBEOztBQVNBdkQsYUFBSzBFLEVBQUwsQ0FBUSxnQkFBUixFQUEwQjNCLFdBQVc7QUFDakMsa0JBQU1KLGFBQWEsS0FBS0csd0JBQUwsQ0FBOEJDLE9BQTlCLENBQW5COztBQUVBLGdCQUFJLENBQUNKLFdBQVdQLFNBQWhCLEVBQ0lPLFdBQVdQLFNBQVgsR0FBdUIsSUFBSVMsSUFBSixFQUF2QjtBQUNQLFNBTEQ7O0FBT0E3QyxhQUFLMEUsRUFBTCxDQUFRLGVBQVI7QUFBQSx3REFBeUIsV0FBTTNCLE9BQU4sRUFBaUI7QUFDdEMsc0JBQU1KLGFBQWdDLE9BQUtHLHdCQUFMLENBQThCQyxPQUE5QixDQUF0QztBQUNBLHNCQUFNNEIsZ0NBQWdDLENBQUMsQ0FBQzVCLFFBQVFiLElBQVIsQ0FBYXhCLE1BQWYsSUFBeUIsT0FBS0ksZUFBcEU7O0FBRUE2QiwyQkFBV0wsV0FBWCxHQUF5QnFDLGdDQUFnQyxDQUFoQyxHQUFvQ2hDLFdBQVdMLFdBQVgsR0FBeUIsQ0FBdEY7QUFDQUssMkJBQVdSLFFBQVgsR0FBeUJRLFdBQVdSLFFBQVgsSUFBdUJZLFFBQVFaLFFBQXhEO0FBQ0FRLDJCQUFXVCxJQUFYLEdBQXlCUyxXQUFXVCxJQUFYLENBQWdCMEMsTUFBaEIsQ0FBdUI3QixRQUFRYixJQUEvQixDQUF6Qjs7QUFFQSxvQkFBSSxDQUFDUyxXQUFXTCxXQUFoQixFQUNJLE1BQU0sT0FBS29CLGtCQUFMLENBQXdCZixVQUF4QixFQUFvQ0ksT0FBcEMsQ0FBTjs7QUFFSixzQkFBTUosV0FBV0osY0FBakI7QUFDSCxhQVpEOztBQUFBO0FBQUE7QUFBQTtBQUFBOztBQWNBdkMsYUFBS29FLElBQUwsQ0FBVSxNQUFWLGtDQUFrQixhQUFZO0FBQzFCLGtCQUFNUyxVQUFVLElBQUloQyxJQUFKLEVBQWhCOztBQUVBLGtCQUFNLE9BQUs5QyxNQUFMLENBQVkrRSxjQUFaLENBQTJCRCxPQUEzQixFQUFvQyxPQUFLekUsTUFBekMsRUFBaURKLEtBQUsrRSxVQUFMLENBQWdCQyxRQUFqRSxDQUFOO0FBQ0gsU0FKRDtBQUtIOztBQUVLQyxXQUFOLEdBQWlCO0FBQUE7O0FBQUE7QUFDYixnQkFBSSxPQUFLOUUsUUFBVCxFQUNJOztBQUVKLG1CQUFLQSxRQUFMLEdBQWdCLElBQWhCOztBQUVBLGdCQUFJLENBQUMsT0FBS0YsU0FBTixJQUFtQkosU0FBU29CLGdCQUFULENBQTBCLE9BQUtoQixTQUEvQixDQUFuQixJQUFnRSxDQUFDLHdCQUFpQixPQUFLQSxTQUF0QixDQUFyRSxFQUNJOztBQUVKLG1CQUFLQSxTQUFMLENBQWVpRixHQUFmOztBQUVBLGtCQUFNLElBQUl4RCxnQkFBSixDQUFZLG1CQUFXO0FBQ3pCLHVCQUFLekIsU0FBTCxDQUFlbUUsSUFBZixDQUFvQixRQUFwQixFQUE4QnpDLE9BQTlCO0FBQ0EsdUJBQUsxQixTQUFMLENBQWVtRSxJQUFmLENBQW9CLE9BQXBCLEVBQTZCekMsT0FBN0I7QUFDSCxhQUhLLENBQU47QUFYYTtBQWVoQjtBQS9LeUI7a0JBQVQ5QixRIiwiZmlsZSI6InJlcG9ydGVyL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCB7IGZpbmQsIHNvcnRCeSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB3cml0YWJsZSBhcyBpc1dyaXRhYmxlU3RyZWFtIH0gZnJvbSAnaXMtc3RyZWFtJztcbmltcG9ydCBSZXBvcnRlclBsdWdpbkhvc3QgZnJvbSAnLi9wbHVnaW4taG9zdCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlcG9ydGVyIHtcbiAgICBjb25zdHJ1Y3RvciAocGx1Z2luLCB0YXNrLCBvdXRTdHJlYW0pIHtcbiAgICAgICAgdGhpcy5wbHVnaW4gPSBuZXcgUmVwb3J0ZXJQbHVnaW5Ib3N0KHBsdWdpbiwgb3V0U3RyZWFtKTtcbiAgICAgICAgdGhpcy50YXNrICAgPSB0YXNrO1xuXG4gICAgICAgIHRoaXMuZGlzcG9zZWQgICAgICAgID0gZmFsc2U7XG4gICAgICAgIHRoaXMucGFzc2VkICAgICAgICAgID0gMDtcbiAgICAgICAgdGhpcy5za2lwcGVkICAgICAgICAgPSB0YXNrLnRlc3RzLmZpbHRlcih0ZXN0ID0+IHRlc3Quc2tpcCkubGVuZ3RoO1xuICAgICAgICB0aGlzLnRlc3RDb3VudCAgICAgICA9IHRhc2sudGVzdHMubGVuZ3RoIC0gdGhpcy5za2lwcGVkO1xuICAgICAgICB0aGlzLnJlcG9ydFF1ZXVlICAgICA9IFJlcG9ydGVyLl9jcmVhdGVSZXBvcnRRdWV1ZSh0YXNrKTtcbiAgICAgICAgdGhpcy5zdG9wT25GaXJzdEZhaWwgPSB0YXNrLm9wdHMuc3RvcE9uRmlyc3RGYWlsO1xuICAgICAgICB0aGlzLm91dFN0cmVhbSAgICAgICA9IG91dFN0cmVhbTtcblxuICAgICAgICB0aGlzLl9hc3NpZ25UYXNrRXZlbnRIYW5kbGVycygpO1xuICAgIH1cblxuICAgIHN0YXRpYyBfaXNTcGVjaWFsU3RyZWFtIChzdHJlYW0pIHtcbiAgICAgICAgcmV0dXJuIHN0cmVhbS5pc1RUWSB8fCBzdHJlYW0gPT09IHByb2Nlc3Muc3Rkb3V0IHx8IHN0cmVhbSA9PT0gcHJvY2Vzcy5zdGRlcnI7XG4gICAgfVxuXG4gICAgc3RhdGljIF9jcmVhdGVQZW5kaW5nUHJvbWlzZSAoKSB7XG4gICAgICAgIGxldCByZXNvbHZlciA9IG51bGw7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgcmVzb2x2ZXIgPSByZXNvbHZlO1xuICAgICAgICB9KTtcblxuICAgICAgICBwcm9taXNlLnJlc29sdmUgPSByZXNvbHZlcjtcblxuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2NyZWF0ZVJlcG9ydEl0ZW0gKHRlc3QsIHJ1bnNQZXJUZXN0KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBmaXh0dXJlOiAgICAgICAgdGVzdC5maXh0dXJlLFxuICAgICAgICAgICAgdGVzdDogICAgICAgICAgIHRlc3QsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aDogbnVsbCxcbiAgICAgICAgICAgIHNjcmVlbnNob3RzOiAgICBbXSxcbiAgICAgICAgICAgIHF1YXJhbnRpbmU6ICAgICBudWxsLFxuICAgICAgICAgICAgZXJyczogICAgICAgICAgIFtdLFxuICAgICAgICAgICAgdW5zdGFibGU6ICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgc3RhcnRUaW1lOiAgICAgIG51bGwsXG4gICAgICAgICAgICB0ZXN0UnVuSW5mbzogICAgbnVsbCxcblxuICAgICAgICAgICAgcGVuZGluZ1J1bnM6ICAgIHJ1bnNQZXJUZXN0LFxuICAgICAgICAgICAgcGVuZGluZ1Byb21pc2U6IFJlcG9ydGVyLl9jcmVhdGVQZW5kaW5nUHJvbWlzZSgpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgc3RhdGljIF9jcmVhdGVSZXBvcnRRdWV1ZSAodGFzaykge1xuICAgICAgICBjb25zdCBydW5zUGVyVGVzdCA9IHRhc2suYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMubGVuZ3RoO1xuXG4gICAgICAgIHJldHVybiB0YXNrLnRlc3RzLm1hcCh0ZXN0ID0+IFJlcG9ydGVyLl9jcmVhdGVSZXBvcnRJdGVtKHRlc3QsIHJ1bnNQZXJUZXN0KSk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9jcmVhdGVUZXN0UnVuSW5mbyAocmVwb3J0SXRlbSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZXJyczogICAgICAgICAgIHNvcnRCeShyZXBvcnRJdGVtLmVycnMsIFsndXNlckFnZW50JywgJ3R5cGUnXSksXG4gICAgICAgICAgICBkdXJhdGlvbk1zOiAgICAgbmV3IERhdGUoKSAtIHJlcG9ydEl0ZW0uc3RhcnRUaW1lLFxuICAgICAgICAgICAgdW5zdGFibGU6ICAgICAgIHJlcG9ydEl0ZW0udW5zdGFibGUsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aDogcmVwb3J0SXRlbS5zY3JlZW5zaG90UGF0aCxcbiAgICAgICAgICAgIHNjcmVlbnNob3RzOiAgICByZXBvcnRJdGVtLnNjcmVlbnNob3RzLFxuICAgICAgICAgICAgcXVhcmFudGluZTogICAgIHJlcG9ydEl0ZW0ucXVhcmFudGluZSxcbiAgICAgICAgICAgIHNraXBwZWQ6ICAgICAgICByZXBvcnRJdGVtLnRlc3Quc2tpcFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIF9nZXRSZXBvcnRJdGVtRm9yVGVzdFJ1biAodGVzdFJ1bikge1xuICAgICAgICByZXR1cm4gZmluZCh0aGlzLnJlcG9ydFF1ZXVlLCBpID0+IGkudGVzdCA9PT0gdGVzdFJ1bi50ZXN0KTtcbiAgICB9XG5cbiAgICBhc3luYyBfc2hpZnRSZXBvcnRRdWV1ZSAocmVwb3J0SXRlbSkge1xuICAgICAgICBsZXQgY3VycmVudEZpeHR1cmUgPSBudWxsO1xuICAgICAgICBsZXQgbmV4dFJlcG9ydEl0ZW0gPSBudWxsO1xuXG4gICAgICAgIHdoaWxlICh0aGlzLnJlcG9ydFF1ZXVlLmxlbmd0aCAmJiB0aGlzLnJlcG9ydFF1ZXVlWzBdLnRlc3RSdW5JbmZvKSB7XG4gICAgICAgICAgICByZXBvcnRJdGVtICAgICA9IHRoaXMucmVwb3J0UXVldWUuc2hpZnQoKTtcbiAgICAgICAgICAgIGN1cnJlbnRGaXh0dXJlID0gcmVwb3J0SXRlbS5maXh0dXJlO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi5yZXBvcnRUZXN0RG9uZShyZXBvcnRJdGVtLnRlc3QubmFtZSwgcmVwb3J0SXRlbS50ZXN0UnVuSW5mbywgcmVwb3J0SXRlbS50ZXN0Lm1ldGEpO1xuXG4gICAgICAgICAgICAvLyBOT1RFOiBoZXJlIHdlIGFzc3VtZSB0aGF0IHRlc3RzIGFyZSBzb3J0ZWQgYnkgZml4dHVyZS5cbiAgICAgICAgICAgIC8vIFRoZXJlZm9yZSwgaWYgdGhlIG5leHQgcmVwb3J0IGl0ZW0gaGFzIGEgZGlmZmVyZW50XG4gICAgICAgICAgICAvLyBmaXh0dXJlLCB3ZSBjYW4gcmVwb3J0IHRoaXMgZml4dHVyZSBzdGFydC5cbiAgICAgICAgICAgIG5leHRSZXBvcnRJdGVtID0gdGhpcy5yZXBvcnRRdWV1ZVswXTtcblxuICAgICAgICAgICAgaWYgKG5leHRSZXBvcnRJdGVtICYmIG5leHRSZXBvcnRJdGVtLmZpeHR1cmUgIT09IGN1cnJlbnRGaXh0dXJlKVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnJlcG9ydEZpeHR1cmVTdGFydChuZXh0UmVwb3J0SXRlbS5maXh0dXJlLm5hbWUsIG5leHRSZXBvcnRJdGVtLmZpeHR1cmUucGF0aCwgbmV4dFJlcG9ydEl0ZW0uZml4dHVyZS5tZXRhKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9yZXNvbHZlUmVwb3J0SXRlbSAocmVwb3J0SXRlbSwgdGVzdFJ1bikge1xuICAgICAgICBpZiAodGhpcy50YXNrLnNjcmVlbnNob3RzLmhhc0NhcHR1cmVkRm9yKHRlc3RSdW4udGVzdCkpIHtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0uc2NyZWVuc2hvdFBhdGggPSB0aGlzLnRhc2suc2NyZWVuc2hvdHMuZ2V0UGF0aEZvcih0ZXN0UnVuLnRlc3QpO1xuICAgICAgICAgICAgcmVwb3J0SXRlbS5zY3JlZW5zaG90cyAgICA9IHRoaXMudGFzay5zY3JlZW5zaG90cy5nZXRTY3JlZW5zaG90c0luZm8odGVzdFJ1bi50ZXN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0ZXN0UnVuLnF1YXJhbnRpbmUpIHtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0ucXVhcmFudGluZSA9IHRlc3RSdW4ucXVhcmFudGluZS5hdHRlbXB0cy5yZWR1Y2UoKHJlc3VsdCwgZXJyb3JzLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBhc3NlZCAgICAgICAgICAgID0gIWVycm9ycy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgY29uc3QgcXVhcmFudGluZUF0dGVtcHQgPSBpbmRleCArIDE7XG5cbiAgICAgICAgICAgICAgICByZXN1bHRbcXVhcmFudGluZUF0dGVtcHRdID0geyBwYXNzZWQgfTtcblxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9LCB7fSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXJlcG9ydEl0ZW0udGVzdFJ1bkluZm8pIHtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0udGVzdFJ1bkluZm8gPSBSZXBvcnRlci5fY3JlYXRlVGVzdFJ1bkluZm8ocmVwb3J0SXRlbSk7XG5cbiAgICAgICAgICAgIGlmICghcmVwb3J0SXRlbS5lcnJzLmxlbmd0aCAmJiAhcmVwb3J0SXRlbS50ZXN0LnNraXApXG4gICAgICAgICAgICAgICAgdGhpcy5wYXNzZWQrKztcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX3NoaWZ0UmVwb3J0UXVldWUocmVwb3J0SXRlbSk7XG5cbiAgICAgICAgcmVwb3J0SXRlbS5wZW5kaW5nUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgX2Fzc2lnblRhc2tFdmVudEhhbmRsZXJzICgpIHtcbiAgICAgICAgY29uc3QgdGFzayA9IHRoaXMudGFzaztcblxuICAgICAgICB0YXNrLm9uY2UoJ3N0YXJ0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3RhcnRUaW1lICA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBjb25zdCB1c2VyQWdlbnRzID0gdGFzay5icm93c2VyQ29ubmVjdGlvbkdyb3Vwcy5tYXAoZ3JvdXAgPT4gZ3JvdXBbMF0udXNlckFnZW50KTtcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0ICAgICAgPSB0aGlzLnJlcG9ydFF1ZXVlWzBdO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi5yZXBvcnRUYXNrU3RhcnQoc3RhcnRUaW1lLCB1c2VyQWdlbnRzLCB0aGlzLnRlc3RDb3VudCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi5yZXBvcnRGaXh0dXJlU3RhcnQoZmlyc3QuZml4dHVyZS5uYW1lLCBmaXJzdC5maXh0dXJlLnBhdGgsIGZpcnN0LmZpeHR1cmUubWV0YSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2sub24oJ3Rlc3QtcnVuLXN0YXJ0JywgdGVzdFJ1biA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXBvcnRJdGVtID0gdGhpcy5fZ2V0UmVwb3J0SXRlbUZvclRlc3RSdW4odGVzdFJ1bik7XG5cbiAgICAgICAgICAgIGlmICghcmVwb3J0SXRlbS5zdGFydFRpbWUpXG4gICAgICAgICAgICAgICAgcmVwb3J0SXRlbS5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0YXNrLm9uKCd0ZXN0LXJ1bi1kb25lJywgYXN5bmMgdGVzdFJ1biA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXBvcnRJdGVtICAgICAgICAgICAgICAgICAgICA9IHRoaXMuX2dldFJlcG9ydEl0ZW1Gb3JUZXN0UnVuKHRlc3RSdW4pO1xuICAgICAgICAgICAgY29uc3QgaXNUZXN0UnVuU3RvcHBlZFRhc2tFeGVjdXRpb24gPSAhIXRlc3RSdW4uZXJycy5sZW5ndGggJiYgdGhpcy5zdG9wT25GaXJzdEZhaWw7XG5cbiAgICAgICAgICAgIHJlcG9ydEl0ZW0ucGVuZGluZ1J1bnMgPSBpc1Rlc3RSdW5TdG9wcGVkVGFza0V4ZWN1dGlvbiA/IDAgOiByZXBvcnRJdGVtLnBlbmRpbmdSdW5zIC0gMTtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0udW5zdGFibGUgICAgPSByZXBvcnRJdGVtLnVuc3RhYmxlIHx8IHRlc3RSdW4udW5zdGFibGU7XG4gICAgICAgICAgICByZXBvcnRJdGVtLmVycnMgICAgICAgID0gcmVwb3J0SXRlbS5lcnJzLmNvbmNhdCh0ZXN0UnVuLmVycnMpO1xuXG4gICAgICAgICAgICBpZiAoIXJlcG9ydEl0ZW0ucGVuZGluZ1J1bnMpXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fcmVzb2x2ZVJlcG9ydEl0ZW0ocmVwb3J0SXRlbSwgdGVzdFJ1bik7XG5cbiAgICAgICAgICAgIGF3YWl0IHJlcG9ydEl0ZW0ucGVuZGluZ1Byb21pc2U7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2sub25jZSgnZG9uZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZSgpO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi5yZXBvcnRUYXNrRG9uZShlbmRUaW1lLCB0aGlzLnBhc3NlZCwgdGFzay53YXJuaW5nTG9nLm1lc3NhZ2VzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZGlzcG9zZSAoKSB7XG4gICAgICAgIGlmICh0aGlzLmRpc3Bvc2VkKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuZGlzcG9zZWQgPSB0cnVlO1xuXG4gICAgICAgIGlmICghdGhpcy5vdXRTdHJlYW0gfHwgUmVwb3J0ZXIuX2lzU3BlY2lhbFN0cmVhbSh0aGlzLm91dFN0cmVhbSkgfHwgIWlzV3JpdGFibGVTdHJlYW0odGhpcy5vdXRTdHJlYW0pKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMub3V0U3RyZWFtLmVuZCgpO1xuXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgdGhpcy5vdXRTdHJlYW0ub25jZSgnZmluaXNoJywgcmVzb2x2ZSk7XG4gICAgICAgICAgICB0aGlzLm91dFN0cmVhbS5vbmNlKCdlcnJvcicsIHJlc29sdmUpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=
