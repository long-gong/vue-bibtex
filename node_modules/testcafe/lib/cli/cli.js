'use strict';

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let runTests = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (argParser) {
        const opts = argParser.opts;
        const port1 = opts.ports && opts.ports[0];
        const port2 = opts.ports && opts.ports[1];
        const externalProxyHost = opts.proxy;
        const proxyBypass = opts.proxyBypass;

        _log2.default.showSpinner();

        const testCafe = yield (0, _2.default)(opts.hostname, port1, port2, opts.ssl, opts.dev);
        const concurrency = argParser.concurrency || 1;
        const remoteBrowsers = yield (0, _remotesWizard2.default)(testCafe, argParser.remoteCount, opts.qrCode);
        const browsers = argParser.browsers.concat(remoteBrowsers);
        const runner = testCafe.createRunner();
        let failed = 0;
        const reporters = argParser.opts.reporters.map(function (r) {
            return {
                name: r.name,
                outStream: r.outFile ? _fs2.default.createWriteStream(r.outFile) : void 0
            };
        });

        reporters.forEach(function (r) {
            return runner.reporter(r.name, r.outStream);
        });

        runner.useProxy(externalProxyHost, proxyBypass).src(argParser.src).browsers(browsers).concurrency(concurrency).filter(argParser.filter).screenshots(opts.screenshots, opts.screenshotsOnFails, opts.screenshotPathPattern).startApp(opts.app, opts.appInitDelay);

        runner.once('done-bootstrapping', function () {
            return _log2.default.hideSpinner();
        });

        try {
            failed = yield runner.run(opts);
        } finally {
            showMessageOnExit = false;
            yield testCafe.close();
        }

        exit(failed);
    });

    return function runTests(_x) {
        return _ref.apply(this, arguments);
    };
})();

let listBrowsers = (() => {
    var _ref2 = (0, _asyncToGenerator3.default)(function* (providerName = 'locally-installed') {
        // NOTE: Load the provider pool lazily to reduce startup time
        const browserProviderPool = require('../browser/provider/pool');

        const provider = yield browserProviderPool.getProvider(providerName);

        if (!provider) throw new _runtime.GeneralError(_message2.default.browserProviderNotFound, providerName);

        if (provider.isMultiBrowser) {
            const browserNames = yield provider.getBrowserList();

            yield browserProviderPool.dispose();

            if (providerName === 'locally-installed') console.log(browserNames.join('\n'));else console.log(browserNames.map(function (browserName) {
                return `"${providerName}:${browserName}"`;
            }).join('\n'));
        } else console.log(`"${providerName}"`);

        exit(0);
    });

    return function listBrowsers() {
        return _ref2.apply(this, arguments);
    };
})();

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _argumentParser = require('./argument-parser');

var _argumentParser2 = _interopRequireDefault(_argumentParser);

var _terminationHandler = require('./termination-handler');

var _terminationHandler2 = _interopRequireDefault(_terminationHandler);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

var _remotesWizard = require('./remotes-wizard');

var _remotesWizard2 = _interopRequireDefault(_remotesWizard);

var _ = require('../');

var _2 = _interopRequireDefault(_);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let showMessageOnExit = true;
let exitMessageShown = false;
let exiting = false;

function exitHandler(terminationLevel) {
    if (showMessageOnExit && !exitMessageShown) {
        exitMessageShown = true;

        _log2.default.hideSpinner();
        _log2.default.write('Stopping TestCafe...');
        _log2.default.showSpinner();

        process.on('exit', () => _log2.default.hideSpinner(true));
    }

    if (exiting || terminationLevel < 2) return;

    exiting = true;

    exit(0);
}

function exit(code) {
    _log2.default.hideSpinner(true);

    // NOTE: give a process time to flush the output.
    // It's necessary in some environments.
    setTimeout(() => process.exit(code), 0);
}

function error(err) {
    _log2.default.hideSpinner();

    let message = null;

    // HACK: workaround for the `instanceof` problem
    // (see: http://stackoverflow.com/questions/33870684/why-doesnt-instanceof-work-on-instances-of-error-subclasses-under-babel-node)
    if (err.constructor === _runtime.GeneralError) message = err.message;else if (err.constructor === _runtime.APIError) message = err.coloredStack;else message = err.stack;

    _log2.default.write(_chalk2.default.red('ERROR ') + message + '\n');
    _log2.default.write(_chalk2.default.gray('Type "testcafe -h" for help.'));

    exit(1);
}

(() => {
    var _ref3 = (0, _asyncToGenerator3.default)(function* () {
        const terminationHandler = new _terminationHandler2.default();

        terminationHandler.on(_terminationHandler2.default.TERMINATION_LEVEL_INCREASED_EVENT, exitHandler);

        try {
            const argParser = new _argumentParser2.default();

            yield argParser.parse(process.argv);

            if (argParser.opts.listBrowsers) yield listBrowsers(argParser.opts.providerName);else yield runTests(argParser);
        } catch (err) {
            showMessageOnExit = false;
            error(err);
        }
    });

    function cli() {
        return _ref3.apply(this, arguments);
    }

    return cli;
})()();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY2xpLmpzIl0sIm5hbWVzIjpbImFyZ1BhcnNlciIsIm9wdHMiLCJwb3J0MSIsInBvcnRzIiwicG9ydDIiLCJleHRlcm5hbFByb3h5SG9zdCIsInByb3h5IiwicHJveHlCeXBhc3MiLCJsb2ciLCJzaG93U3Bpbm5lciIsInRlc3RDYWZlIiwiaG9zdG5hbWUiLCJzc2wiLCJkZXYiLCJjb25jdXJyZW5jeSIsInJlbW90ZUJyb3dzZXJzIiwicmVtb3RlQ291bnQiLCJxckNvZGUiLCJicm93c2VycyIsImNvbmNhdCIsInJ1bm5lciIsImNyZWF0ZVJ1bm5lciIsImZhaWxlZCIsInJlcG9ydGVycyIsIm1hcCIsIm5hbWUiLCJyIiwib3V0U3RyZWFtIiwib3V0RmlsZSIsImZzIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJmb3JFYWNoIiwicmVwb3J0ZXIiLCJ1c2VQcm94eSIsInNyYyIsImZpbHRlciIsInNjcmVlbnNob3RzIiwic2NyZWVuc2hvdHNPbkZhaWxzIiwic2NyZWVuc2hvdFBhdGhQYXR0ZXJuIiwic3RhcnRBcHAiLCJhcHAiLCJhcHBJbml0RGVsYXkiLCJvbmNlIiwiaGlkZVNwaW5uZXIiLCJydW4iLCJzaG93TWVzc2FnZU9uRXhpdCIsImNsb3NlIiwiZXhpdCIsInJ1blRlc3RzIiwicHJvdmlkZXJOYW1lIiwiYnJvd3NlclByb3ZpZGVyUG9vbCIsInJlcXVpcmUiLCJwcm92aWRlciIsImdldFByb3ZpZGVyIiwiR2VuZXJhbEVycm9yIiwiTUVTU0FHRSIsImJyb3dzZXJQcm92aWRlck5vdEZvdW5kIiwiaXNNdWx0aUJyb3dzZXIiLCJicm93c2VyTmFtZXMiLCJnZXRCcm93c2VyTGlzdCIsImRpc3Bvc2UiLCJjb25zb2xlIiwiam9pbiIsImJyb3dzZXJOYW1lIiwibGlzdEJyb3dzZXJzIiwiZXhpdE1lc3NhZ2VTaG93biIsImV4aXRpbmciLCJleGl0SGFuZGxlciIsInRlcm1pbmF0aW9uTGV2ZWwiLCJ3cml0ZSIsInByb2Nlc3MiLCJvbiIsImNvZGUiLCJzZXRUaW1lb3V0IiwiZXJyb3IiLCJlcnIiLCJtZXNzYWdlIiwiY29uc3RydWN0b3IiLCJBUElFcnJvciIsImNvbG9yZWRTdGFjayIsInN0YWNrIiwiY2hhbGsiLCJyZWQiLCJncmF5IiwidGVybWluYXRpb25IYW5kbGVyIiwiVGVybWluYXRpb25IYW5kbGVyIiwiVEVSTUlOQVRJT05fTEVWRUxfSU5DUkVBU0VEX0VWRU5UIiwiQ2xpQXJndW1lbnRQYXJzZXIiLCJwYXJzZSIsImFyZ3YiLCJjbGkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7K0NBZ0VBLFdBQXlCQSxTQUF6QixFQUFvQztBQUNoQyxjQUFNQyxPQUFvQkQsVUFBVUMsSUFBcEM7QUFDQSxjQUFNQyxRQUFvQkQsS0FBS0UsS0FBTCxJQUFjRixLQUFLRSxLQUFMLENBQVcsQ0FBWCxDQUF4QztBQUNBLGNBQU1DLFFBQW9CSCxLQUFLRSxLQUFMLElBQWNGLEtBQUtFLEtBQUwsQ0FBVyxDQUFYLENBQXhDO0FBQ0EsY0FBTUUsb0JBQW9CSixLQUFLSyxLQUEvQjtBQUNBLGNBQU1DLGNBQW9CTixLQUFLTSxXQUEvQjs7QUFFQUMsc0JBQUlDLFdBQUo7O0FBRUEsY0FBTUMsV0FBZSxNQUFNLGdCQUFlVCxLQUFLVSxRQUFwQixFQUE4QlQsS0FBOUIsRUFBcUNFLEtBQXJDLEVBQTRDSCxLQUFLVyxHQUFqRCxFQUFzRFgsS0FBS1ksR0FBM0QsQ0FBM0I7QUFDQSxjQUFNQyxjQUFpQmQsVUFBVWMsV0FBVixJQUF5QixDQUFoRDtBQUNBLGNBQU1DLGlCQUFpQixNQUFNLDZCQUFjTCxRQUFkLEVBQXdCVixVQUFVZ0IsV0FBbEMsRUFBK0NmLEtBQUtnQixNQUFwRCxDQUE3QjtBQUNBLGNBQU1DLFdBQWlCbEIsVUFBVWtCLFFBQVYsQ0FBbUJDLE1BQW5CLENBQTBCSixjQUExQixDQUF2QjtBQUNBLGNBQU1LLFNBQWlCVixTQUFTVyxZQUFULEVBQXZCO0FBQ0EsWUFBSUMsU0FBaUIsQ0FBckI7QUFDQSxjQUFNQyxZQUFpQnZCLFVBQVVDLElBQVYs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QU1BLGFBQWFoRSxVQUFVQyxJQUFWLENBQWVnRCxZQUE1QixDQUFOLENBREosS0FHSSxNQUFNRCxTQUFTaEQsU0FBVCxDQUFOO0FBQ1AsU0FURCxDQVVBLE9BQU8yRSxHQUFQLEVBQVk7QUFDUjlCLGdDQUFvQixLQUFwQjtBQUNBNkIsa0JBQU1DLEdBQU47QUFDSDtBQUNKLEtBbkJEOztBQUFBLGFBQWdCZSxHQUFoQjtBQUFBO0FBQUE7O0FBQUEsV0FBZ0JBLEdBQWhCO0FBQUEiLCJmaWxlIjoiY2xpL2NsaS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yLCBBUElFcnJvciB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCBNRVNTQUdFIGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL21lc3NhZ2UnO1xuaW1wb3J0IENsaUFyZ3VtZW50UGFyc2VyIGZyb20gJy4vYXJndW1lbnQtcGFyc2VyJztcbmltcG9ydCBUZXJtaW5hdGlvbkhhbmRsZXIgZnJvbSAnLi90ZXJtaW5hdGlvbi1oYW5kbGVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2cnO1xuaW1wb3J0IHJlbW90ZXNXaXphcmQgZnJvbSAnLi9yZW1vdGVzLXdpemFyZCc7XG5pbXBvcnQgY3JlYXRlVGVzdENhZmUgZnJvbSAnLi4vJztcblxuXG5sZXQgc2hvd01lc3NhZ2VPbkV4aXQgPSB0cnVlO1xubGV0IGV4aXRNZXNzYWdlU2hvd24gID0gZmFsc2U7XG5sZXQgZXhpdGluZyAgICAgICAgICAgPSBmYWxzZTtcblxuZnVuY3Rpb24gZXhpdEhhbmRsZXIgKHRlcm1pbmF0aW9uTGV2ZWwpIHtcbiAgICBpZiAoc2hvd01lc3NhZ2VPbkV4aXQgJiYgIWV4aXRNZXNzYWdlU2hvd24pIHtcbiAgICAgICAgZXhpdE1lc3NhZ2VTaG93biA9IHRydWU7XG5cbiAgICAgICAgbG9nLmhpZGVTcGlubmVyKCk7XG4gICAgICAgIGxvZy53cml0ZSgnU3RvcHBpbmcgVGVzdENhZmUuLi4nKTtcbiAgICAgICAgbG9nLnNob3dTcGlubmVyKCk7XG5cbiAgICAgICAgcHJvY2Vzcy5vbignZXhpdCcsICgpID0+IGxvZy5oaWRlU3Bpbm5lcih0cnVlKSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXRpbmcgfHwgdGVybWluYXRpb25MZXZlbCA8IDIpXG4gICAgICAgIHJldHVybjtcblxuICAgIGV4aXRpbmcgPSB0cnVlO1xuXG4gICAgZXhpdCgwKTtcbn1cblxuZnVuY3Rpb24gZXhpdCAoY29kZSkge1xuICAgIGxvZy5oaWRlU3Bpbm5lcih0cnVlKTtcblxuICAgIC8vIE5PVEU6IGdpdmUgYSBwcm9jZXNzIHRpbWUgdG8gZmx1c2ggdGhlIG91dHB1dC5cbiAgICAvLyBJdCdzIG5lY2Vzc2FyeSBpbiBzb21lIGVudmlyb25tZW50cy5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHByb2Nlc3MuZXhpdChjb2RlKSwgMCk7XG59XG5cbmZ1bmN0aW9uIGVycm9yIChlcnIpIHtcbiAgICBsb2cuaGlkZVNwaW5uZXIoKTtcblxuICAgIGxldCBtZXNzYWdlID0gbnVsbDtcblxuICAgIC8vIEhBQ0s6IHdvcmthcm91bmQgZm9yIHRoZSBgaW5zdGFuY2VvZmAgcHJvYmxlbVxuICAgIC8vIChzZWU6IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzM4NzA2ODQvd2h5LWRvZXNudC1pbnN0YW5jZW9mLXdvcmstb24taW5zdGFuY2VzLW9mLWVycm9yLXN1YmNsYXNzZXMtdW5kZXItYmFiZWwtbm9kZSlcbiAgICBpZiAoZXJyLmNvbnN0cnVjdG9yID09PSBHZW5lcmFsRXJyb3IpXG4gICAgICAgIG1lc3NhZ2UgPSBlcnIubWVzc2FnZTtcblxuICAgIGVsc2UgaWYgKGVyci5jb25zdHJ1Y3RvciA9PT0gQVBJRXJyb3IpXG4gICAgICAgIG1lc3NhZ2UgPSBlcnIuY29sb3JlZFN0YWNrO1xuXG4gICAgZWxzZVxuICAgICAgICBtZXNzYWdlID0gZXJyLnN0YWNrO1xuXG4gICAgbG9nLndyaXRlKGNoYWxrLnJlZCgnRVJST1IgJykgKyBtZXNzYWdlICsgJ1xcbicpO1xuICAgIGxvZy53cml0ZShjaGFsay5ncmF5KCdUeXBlIFwidGVzdGNhZmUgLWhcIiBmb3IgaGVscC4nKSk7XG5cbiAgICBleGl0KDEpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5UZXN0cyAoYXJnUGFyc2VyKSB7XG4gICAgY29uc3Qgb3B0cyAgICAgICAgICAgICAgPSBhcmdQYXJzZXIub3B0cztcbiAgICBjb25zdCBwb3J0MSAgICAgICAgICAgICA9IG9wdHMucG9ydHMgJiYgb3B0cy5wb3J0c1swXTtcbiAgICBjb25zdCBwb3J0MiAgICAgICAgICAgICA9IG9wdHMucG9ydHMgJiYgb3B0cy5wb3J0c1sxXTtcbiAgICBjb25zdCBleHRlcm5hbFByb3h5SG9zdCA9IG9wdHMucHJveHk7XG4gICAgY29uc3QgcHJveHlCeXBhc3MgICAgICAgPSBvcHRzLnByb3h5QnlwYXNzO1xuXG4gICAgbG9nLnNob3dTcGlubmVyKCk7XG5cbiAgICBjb25zdCB0ZXN0Q2FmZSAgICAgPSBhd2FpdCBjcmVhdGVUZXN0Q2FmZShvcHRzLmhvc3RuYW1lLCBwb3J0MSwgcG9ydDIsIG9wdHMuc3NsLCBvcHRzLmRldik7XG4gICAgY29uc3QgY29uY3VycmVuY3kgICAgPSBhcmdQYXJzZXIuY29uY3VycmVuY3kgfHwgMTtcbiAgICBjb25zdCByZW1vdGVCcm93c2VycyA9IGF3YWl0IHJlbW90ZXNXaXphcmQodGVzdENhZmUsIGFyZ1BhcnNlci5yZW1vdGVDb3VudCwgb3B0cy5xckNvZGUpO1xuICAgIGNvbnN0IGJyb3dzZXJzICAgICAgID0gYXJnUGFyc2VyLmJyb3dzZXJzLmNvbmNhdChyZW1vdGVCcm93c2Vycyk7XG4gICAgY29uc3QgcnVubmVyICAgICAgICAgPSB0ZXN0Q2FmZS5jcmVhdGVSdW5uZXIoKTtcbiAgICBsZXQgZmFpbGVkICAgICAgICAgPSAwO1xuICAgIGNvbnN0IHJlcG9ydGVycyAgICAgID0gYXJnUGFyc2VyLm9wdHMucmVwb3J0ZXJzLm1hcChyID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG5hbWU6ICAgICAgci5uYW1lLFxuICAgICAgICAgICAgb3V0U3RyZWFtOiByLm91dEZpbGUgPyBmcy5jcmVhdGVXcml0ZVN0cmVhbShyLm91dEZpbGUpIDogdm9pZCAwXG4gICAgICAgIH07XG4gICAgfSk7XG5cbiAgICByZXBvcnRlcnMuZm9yRWFjaChyID0+IHJ1bm5lci5yZXBvcnRlcihyLm5hbWUsIHIub3V0U3RyZWFtKSk7XG5cbiAgICBydW5uZXJcbiAgICAgICAgLnVzZVByb3h5KGV4dGVybmFsUHJveHlIb3N0LCBwcm94eUJ5cGFzcylcbiAgICAgICAgLnNyYyhhcmdQYXJzZXIuc3JjKVxuICAgICAgICAuYnJvd3NlcnMoYnJvd3NlcnMpXG4gICAgICAgIC5jb25jdXJyZW5jeShjb25jdXJyZW5jeSlcbiAgICAgICAgLmZpbHRlcihhcmdQYXJzZXIuZmlsdGVyKVxuICAgICAgICAuc2NyZWVuc2hvdHMob3B0cy5zY3JlZW5zaG90cywgb3B0cy5zY3JlZW5zaG90c09uRmFpbHMsIG9wdHMuc2NyZWVuc2hvdFBhdGhQYXR0ZXJuKVxuICAgICAgICAuc3RhcnRBcHAob3B0cy5hcHAsIG9wdHMuYXBwSW5pdERlbGF5KTtcblxuICAgIHJ1bm5lci5vbmNlKCdkb25lLWJvb3RzdHJhcHBpbmcnLCAoKSA9PiBsb2cuaGlkZVNwaW5uZXIoKSk7XG5cbiAgICB0cnkge1xuICAgICAgICBmYWlsZWQgPSBhd2FpdCBydW5uZXIucnVuKG9wdHMpO1xuICAgIH1cblxuICAgIGZpbmFsbHkge1xuICAgICAgICBzaG93TWVzc2FnZU9uRXhpdCA9IGZhbHNlO1xuICAgICAgICBhd2FpdCB0ZXN0Q2FmZS5jbG9zZSgpO1xuICAgIH1cblxuICAgIGV4aXQoZmFpbGVkKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbGlzdEJyb3dzZXJzIChwcm92aWRlck5hbWUgPSAnbG9jYWxseS1pbnN0YWxsZWQnKSB7XG4gICAgLy8gTk9URTogTG9hZCB0aGUgcHJvdmlkZXIgcG9vbCBsYXppbHkgdG8gcmVkdWNlIHN0YXJ0dXAgdGltZVxuICAgIGNvbnN0IGJyb3dzZXJQcm92aWRlclBvb2wgPSByZXF1aXJlKCcuLi9icm93c2VyL3Byb3ZpZGVyL3Bvb2wnKTtcblxuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgYnJvd3NlclByb3ZpZGVyUG9vbC5nZXRQcm92aWRlcihwcm92aWRlck5hbWUpO1xuXG4gICAgaWYgKCFwcm92aWRlcilcbiAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmJyb3dzZXJQcm92aWRlck5vdEZvdW5kLCBwcm92aWRlck5hbWUpO1xuXG4gICAgaWYgKHByb3ZpZGVyLmlzTXVsdGlCcm93c2VyKSB7XG4gICAgICAgIGNvbnN0IGJyb3dzZXJOYW1lcyA9IGF3YWl0IHByb3ZpZGVyLmdldEJyb3dzZXJMaXN0KCk7XG5cbiAgICAgICAgYXdhaXQgYnJvd3NlclByb3ZpZGVyUG9vbC5kaXNwb3NlKCk7XG5cbiAgICAgICAgaWYgKHByb3ZpZGVyTmFtZSA9PT0gJ2xvY2FsbHktaW5zdGFsbGVkJylcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGJyb3dzZXJOYW1lcy5qb2luKCdcXG4nKSk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGJyb3dzZXJOYW1lcy5tYXAoYnJvd3Nlck5hbWUgPT4gYFwiJHtwcm92aWRlck5hbWV9OiR7YnJvd3Nlck5hbWV9XCJgKS5qb2luKCdcXG4nKSk7XG4gICAgfVxuICAgIGVsc2VcbiAgICAgICAgY29uc29sZS5sb2coYFwiJHtwcm92aWRlck5hbWV9XCJgKTtcblxuICAgIGV4aXQoMCk7XG59XG5cbihhc3luYyBmdW5jdGlvbiBjbGkgKCkge1xuICAgIGNvbnN0IHRlcm1pbmF0aW9uSGFuZGxlciA9IG5ldyBUZXJtaW5hdGlvbkhhbmRsZXIoKTtcblxuICAgIHRlcm1pbmF0aW9uSGFuZGxlci5vbihUZXJtaW5hdGlvbkhhbmRsZXIuVEVSTUlOQVRJT05fTEVWRUxfSU5DUkVBU0VEX0VWRU5ULCBleGl0SGFuZGxlcik7XG5cbiAgICB0cnkge1xuICAgICAgICBjb25zdCBhcmdQYXJzZXIgPSBuZXcgQ2xpQXJndW1lbnRQYXJzZXIoKTtcblxuICAgICAgICBhd2FpdCBhcmdQYXJzZXIucGFyc2UocHJvY2Vzcy5hcmd2KTtcblxuICAgICAgICBpZiAoYXJnUGFyc2VyLm9wdHMubGlzdEJyb3dzZXJzKVxuICAgICAgICAgICAgYXdhaXQgbGlzdEJyb3dzZXJzKGFyZ1BhcnNlci5vcHRzLnByb3ZpZGVyTmFtZSk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGF3YWl0IHJ1blRlc3RzKGFyZ1BhcnNlcik7XG4gICAgfVxuICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgc2hvd01lc3NhZ2VPbkV4aXQgPSBmYWxzZTtcbiAgICAgICAgZXJyb3IoZXJyKTtcbiAgICB9XG59KSgpO1xuXG4iXX0=
