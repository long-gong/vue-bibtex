'use strict';

exports.__esModule = true;

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _path = require('path');

var _commander = require('commander');

var _dedent = require('dedent');

var _dedent2 = _interopRequireDefault(_dedent);

var _readFileRelative = require('read-file-relative');

var _makeDir = require('make-dir');

var _makeDir2 = _interopRequireDefault(_makeDir);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _typeAssertions = require('../errors/runtime/type-assertions');

var _getViewportWidth = require('../utils/get-viewport-width');

var _getViewportWidth2 = _interopRequireDefault(_getViewportWidth);

var _string = require('../utils/string');

var _lodash = require('lodash');

var _parseSslOptions = require('./parse-ssl-options');

var _parseSslOptions2 = _interopRequireDefault(_parseSslOptions);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const REMOTE_ALIAS_RE = /^remote(?::(\d*))?$/;

const DESCRIPTION = (0, _dedent2.default)(`
    In the browser list, you can use browser names (e.g. "ie", "chrome", etc.) as well as paths to executables.

    To run tests against all installed browsers, use the "all" alias.

    To use a remote browser connection (e.g., to connect a mobile device), specify "remote" as the browser alias.
    If you need to connect multiple devices, add a colon and the number of browsers you want to connect (e.g., "remote:3").

    To run tests in a browser accessed through a browser provider plugin, specify a browser alias that consists of two parts - the browser provider name prefix and the name of the browser itself; for example, "saucelabs:chrome@51".

    You can use one or more file paths or glob patterns to specify which tests to run.

    More info: https://devexpress.github.io/testcafe/documentation
`);

class CLIArgumentParser {
    constructor(cwd) {
        this.program = new _commander.Command('testcafe');

        this.cwd = cwd || process.cwd();

        this.src = null;
        this.browsers = null;
        this.filter = null;
        this.remoteCount = 0;
        this.opts = null;

        this._describeProgram();
    }

    static _parsePortNumber(value) {
        (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Port number', value);

        return parseInt(value, 10);
    }

    static _optionValueToRegExp(name, value) {
        if (value === void 0) return value;

        try {
            return new RegExp(value);
        } catch (err) {
            throw new _runtime.GeneralError(_message2.default.optionValueIsNotValidRegExp, name);
        }
    }

    static _optionValueToKeyValue(name, value) {
        if (value === void 0) return value;

        const keyValue = value.split(',').reduce((obj, pair) => {
            var _pair$split = pair.split('=');

            const key = _pair$split[0],
                  val = _pair$split[1];


            if (!key || !val) throw new _runtime.GeneralError(_message2.default.optionValueIsNotValidKeyValue, name);

            obj[key] = val;
            return obj;
        }, {});

        if ((0, _keys2.default)(keyValue).length === 0) throw new _runtime.GeneralError(_message2.default.optionValueIsNotValidKeyValue, name);

        return keyValue;
    }

    static _getDescription() {
        // NOTE: add empty line to workaround commander-forced indentation on the first line.
        return '\n' + (0, _string.wordWrap)(DESCRIPTION, 2, (0, _getViewportWidth2.default)(process.stdout));
    }

    _describeProgram() {
        const version = JSON.parse((0, _readFileRelative.readSync)('../../package.json')).version;

        this.program.version(version, '-v, --version').usage('[options] <comma-separated-browser-list> <file-or-glob ...>').description(CLIArgumentParser._getDescription()).option('-b, --list-browsers [provider]', 'output the aliases for local browsers or browsers available through the specified browser provider').option('-r, --reporter <name[:outputFile][,...]>', 'specify the reporters and optionally files where reports are saved').option('-s, --screenshots <path>', 'enable screenshot capturing and specify the path to save the screenshots to').option('-S, --screenshots-on-fails', 'take a screenshot whenever a test fails').option('-p, --screenshot-path-pattern <pattern>', 'use patterns to compose screenshot file names and paths: ${BROWSER}, ${BROWSER_VERSION}, ${OS}, etc.').option('-q, --quarantine-mode', 'enable the quarantine mode').option('-d, --debug-mode', 'execute test steps one by one pausing the test after each step').option('-e, --skip-js-errors', 'make tests not fail when a JS error happens on a page').option('-u, --skip-uncaught-errors', 'ignore uncaught errors and unhandled promise rejections, which occur during test execution').option('-t, --test <name>', 'run only tests with the specified name').option('-T, --test-grep <pattern>', 'run only tests matching the specified pattern').option('-f, --fixture <name>', 'run only fixtures with the specified name').option('-F, --fixture-grep <pattern>', 'run only fixtures matching the specified pattern').option('-a, --app <command>', 'launch the tested app using the specified command before running tests').option('-c, --concurrency <number>', 'run tests concurrently').option('--test-meta <key=value[,key2=value2,...]>', 'run only tests with matching metadata').option('--fixture-meta <key=value[,key2=value2,...]>', 'run only fixtures with matching metadata').option('--debug-on-fail', 'pause the test if it fails').option('--app-init-delay <ms>', 'specify how much time it takes for the tested app to initialize').option('--selector-timeout <ms>', 'set the amount of time within which selectors make attempts to obtain a node to be returned').option('--assertion-timeout <ms>', 'set the amount of time within which assertion should pass').option('--page-load-timeout <ms>', 'set the amount of time within which TestCafe waits for the `window.load` event to fire on page load before proceeding to the next test action').option('--speed <factor>', 'set the speed of test execution (0.01 ... 1)').option('--ports <port1,port2>', 'specify custom port numbers').option('--hostname <name>', 'specify the hostname').option('--proxy <host>', 'specify the host of the proxy server').option('--proxy-bypass <rules>', 'specify a comma-separated list of rules that define URLs accessed bypassing the proxy server').option('--ssl <options>', 'specify SSL options to run TestCafe proxy server over the HTTPS protocol').option('--disable-page-reloads', 'disable page reloads between tests').option('--dev', 'enables mechanisms to log and diagnose errors').option('--qr-code', 'outputs QR-code that repeats URLs used to connect the remote browsers').option('--sf, --stop-on-first-fail', 'stop an entire test run if any test fails').option('--disable-test-syntax-validation', 'disables checks for \'test\' and \'fixture\' directives to run dynamically loaded tests')

        // NOTE: these options will be handled by chalk internally
        .option('--color', 'force colors in command line').option('--no-color', 'disable colors in command line');
    }

    _filterAndCountRemotes(browser) {
        const remoteMatch = browser.match(REMOTE_ALIAS_RE);

        if (remoteMatch) {
            this.remoteCount += parseInt(remoteMatch[1], 10) || 1;
            return false;
        }

        return true;
    }

    _parseFilteringOptions() {
        this.opts.testGrep = CLIArgumentParser._optionValueToRegExp('--test-grep', this.opts.testGrep);
        this.opts.fixtureGrep = CLIArgumentParser._optionValueToRegExp('--fixture-grep', this.opts.fixtureGrep);
        this.opts.testMeta = CLIArgumentParser._optionValueToKeyValue('--test-meta', this.opts.testMeta);
        this.opts.fixtureMeta = CLIArgumentParser._optionValueToKeyValue('--fixture-meta', this.opts.fixtureMeta);

        this.filter = (testName, fixtureName, fixturePath, testMeta, fixtureMeta) => {

            if (this.opts.test && testName !== this.opts.test) return false;

            if (this.opts.testGrep && !this.opts.testGrep.test(testName)) return false;

            if (this.opts.fixture && fixtureName !== this.opts.fixture) return false;

            if (this.opts.fixtureGrep && !this.opts.fixtureGrep.test(fixtureName)) return false;

            if (this.opts.testMeta && !(0, _lodash.isMatch)(testMeta, this.opts.testMeta)) return false;

            if (this.opts.fixtureMeta && !(0, _lodash.isMatch)(fixtureMeta, this.opts.fixtureMeta)) return false;

            return true;
        };
    }

    _parseAppInitDelay() {
        if (this.opts.appInitDelay) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Tested app initialization delay', this.opts.appInitDelay);

            this.opts.appInitDelay = parseInt(this.opts.appInitDelay, 10);
        }
    }

    _parseSelectorTimeout() {
        if (this.opts.selectorTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Selector timeout', this.opts.selectorTimeout);

            this.opts.selectorTimeout = parseInt(this.opts.selectorTimeout, 10);
        }
    }

    _parseAssertionTimeout() {
        if (this.opts.assertionTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Assertion timeout', this.opts.assertionTimeout);

            this.opts.assertionTimeout = parseInt(this.opts.assertionTimeout, 10);
        }
    }

    _parsePageLoadTimeout() {
        if (this.opts.pageLoadTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Page load timeout', this.opts.pageLoadTimeout);

            this.opts.pageLoadTimeout = parseInt(this.opts.pageLoadTimeout, 10);
        }
    }

    _parseSpeed() {
        if (this.opts.speed) this.opts.speed = parseFloat(this.opts.speed);
    }

    _parseConcurrency() {
        if (this.opts.concurrency) this.concurrency = parseInt(this.opts.concurrency, 10);
    }

    _parsePorts() {
        if (this.opts.ports) {
            this.opts.ports = this.opts.ports.split(',').map(CLIArgumentParser._parsePortNumber);

            if (this.opts.ports.length < 2) throw new _runtime.GeneralError(_message2.default.portsOptionRequiresTwoNumbers);
        }
    }

    _parseBrowserList() {
        const browsersArg = this.program.args[0] || '';

        this.browsers = (0, _string.splitQuotedText)(browsersArg, ',').filter(browser => browser && this._filterAndCountRemotes(browser));
    }

    _parseSslOptions() {
        if (this.opts.ssl) this.opts.ssl = (0, _parseSslOptions2.default)(this.opts.ssl);
    }

    _parseReporters() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this.opts.reporter) {
                _this.opts.reporters = [];
                return;
            }

            const reporters = _this.opts.reporter.split(',');

            _this.opts.reporters = reporters.map(function (reporter) {
                const separatorIndex = reporter.indexOf(':');

                if (separatorIndex < 0) return { name: reporter };

                const name = reporter.substring(0, separatorIndex);
                const outFile = reporter.substring(separatorIndex + 1);

                return { name, outFile };
            });

            for (var _iterator = _this.opts.reporters, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : (0, _getIterator3.default)(_iterator);;) {
                var _ref;

                if (_isArray) {
                    if (_i >= _iterator.length) break;
                    _ref = _iterator[_i++];
                } else {
                    _i = _iterator.next();
                    if (_i.done) break;
                    _ref = _i.value;
                }

                const reporter = _ref;

                if (reporter.outFile) {
                    reporter.outFile = (0, _path.resolve)(_this.cwd, reporter.outFile);

                    yield (0, _makeDir2.default)((0, _path.dirname)(reporter.outFile));
                }
            }
        })();
    }

    _parseFileList() {
        this.src = this.program.args.slice(1);
    }

    _getProviderName() {
        this.opts.providerName = this.opts.listBrowsers === true ? void 0 : this.opts.listBrowsers;
    }

    parse(argv) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this2.program.parse(argv);

            _this2.opts = _this2.program.opts();

            // NOTE: the '-list-browsers' option only lists browsers and immediately exits the app.
            // Therefore, we don't need to process other arguments.
            if (_this2.opts.listBrowsers) {
                _this2._getProviderName();
                return;
            }

            _this2._parseFilteringOptions();
            _this2._parseSelectorTimeout();
            _this2._parseAssertionTimeout();
            _this2._parsePageLoadTimeout();
            _this2._parseAppInitDelay();
            _this2._parseSpeed();
            _this2._parsePorts();
            _this2._parseBrowserList();
            _this2._parseConcurrency();
            _this2._parseSslOptions();
            _this2._parseFileList();

            yield _this2._parseReporters();
        })();
    }
}
exports.default = CLIArgumentParser;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvYXJndW1lbnQtcGFyc2VyLmpzIl0sIm5hbWVzIjpbIlJFTU9URV9BTElBU19SRSIsIkRFU0NSSVBUSU9OIiwiQ0xJQXJndW1lbnRQYXJzZXIiLCJjb25zdHJ1Y3RvciIsImN3ZCIsInByb2dyYW0iLCJDb21tYW5kIiwicHJvY2VzcyIsInNyYyIsImJyb3dzZXJzIiwiZmlsdGVyIiwicmVtb3RlQ291bnQiLCJvcHRzIiwiX2Rlc2NyaWJlUHJvZ3JhbSIsIl9wYXJzZVBvcnROdW1iZXIiLCJ2YWx1ZSIsImlzIiwibm9uTmVnYXRpdmVOdW1iZXJTdHJpbmciLCJwYXJzZUludCIsIl9vcHRpb25WYWx1ZVRvUmVnRXhwIiwibmFtZSIsIlJlZ0V4cCIsImVyciIsIkdlbmVyYWxFcnJvciIsIk1FU1NBR0UiLCJvcHRpb25WYWx1ZUlzTm90VmFsaWRSZWdFeHAiLCJfb3B0aW9uVmFsdWVUb0tleVZhbHVlIiwia2V5VmFsdWUiLCJzcGxpdCIsInJlZHVjZSIsIm9iaiIsInBhaXIiLCJrZXkiLCJ2YWwiLCJvcHRpb25WYWx1ZUlzTm90VmFsaWRLZXlWYWx1ZSIsImxlbmd0aCIsIl9nZXREZXNjcmlwdGlvbiIsInN0ZG91dCIsInZlcnNpb24iLCJKU09OIiwicGFyc2UiLCJ1c2FnZSIsImRlc2NyaXB0aW9uIiwib3B0aW9uIiwiX2ZpbHRlckFuZENvdW50UmVtb3RlcyIsImJyb3dzZXIiLCJyZW1vdGVNYXRjaCIsIm1hdGNoIiwiX3BhcnNlRmlsdGVyaW5nT3B0aW9ucyIsInRlc3RHcmVwIiwiZml4dHVyZUdyZXAiLCJ0ZXN0TWV0YSIsImZpeHR1cmVNZXRhIiwidGVzdE5hbWUiLCJmaXh0dXJlTmFtZSIsImZpeHR1cmVQYXRoIiwidGVzdCIsImZpeHR1cmUiLCJfcGFyc2VBcHBJbml0RGVsYXkiLCJhcHBJbml0RGVsYXkiLCJfcGFyc2VTZWxlY3RvclRpbWVvdXQiLCJzZWxlY3RvclRpbWVvdXQiLCJfcGFyc2VBc3NlcnRpb25UaW1lb3V0IiwiYXNzZXJ0aW9uVGltZW91dCIsIl9wYXJzZVBhZ2VMb2FkVGltZW91dCIsInBhZ2VMb2FkVGltZW91dCIsIl9wYXJzZVNwZWVkIiwic3BlZWQiLCJwYXJzZUZsb2F0IiwiX3BhcnNlQ29uY3VycmVuY3kiLCJjb25jdXJyZW5jeSIsIl9wYXJzZVBvcnRzIiwicG9ydHMiLCJtYXAiLCJwb3J0c09wdGlvblJlcXVpcmVzVHdvTnVtYmVycyIsIl9wYXJzZUJyb3dzZXJMaXN0IiwiYnJvd3NlcnNBcmciLCJhcmdzIiwiX3BhcnNlU3NsT3B0aW9ucyIsInNzbCIsIl9wYXJzZVJlcG9ydGVycyIsInJlcG9ydGVyIiwicmVwb3J0ZXJzIiwic2VwYXJhdG9ySW5kZXgiLCJpbmRleE9mIiwic3Vic3RyaW5nIiwib3V0RmlsZSIsIl9wYXJzZUZpbGVMaXN0Iiwic2xpY2UiLCJfZ2V0UHJvdmlkZXJOYW1lIiwicHJvdmlkZXJOYW1lIiwibGlzdEJyb3dzZXJzIiwiYXJndiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLGtCQUFrQixxQkFBeEI7O0FBRUEsTUFBTUMsY0FBYyxzQkFBUTs7Ozs7Ozs7Ozs7OztDQUFSLENBQXBCOztBQWVlLE1BQU1DLGlCQUFOLENBQXdCO0FBQ25DQyxnQkFBYUMsR0FBYixFQUFrQjtBQUNkLGFBQUtDLE9BQUwsR0FBZSxJQUFJQyxrQkFBSixDQUFZLFVBQVosQ0FBZjs7QUFFQSxhQUFLRixHQUFMLEdBQVdBLE9BQU9HLFFBQVFILEdBQVIsRUFBbEI7O0FBRUEsYUFBS0ksR0FBTCxHQUFtQixJQUFuQjtBQUNBLGFBQUtDLFFBQUwsR0FBbUIsSUFBbkI7QUFDQSxhQUFLQyxNQUFMLEdBQW1CLElBQW5CO0FBQ0EsYUFBS0MsV0FBTCxHQUFtQixDQUFuQjtBQUNBLGFBQUtDLElBQUwsR0FBbUIsSUFBbkI7O0FBRUEs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QkFBS0Usc0JBQUw7QUFDQSxtQkFBS0UscUJBQUw7QUFDQSxtQkFBS04sa0JBQUw7QUFDQSxtQkFBS1EsV0FBTDtBQUNBLG1CQUFLSyxXQUFMO0FBQ0EsbUJBQUtJLGlCQUFMO0FBQ0EsbUJBQUtOLGlCQUFMO0FBQ0EsbUJBQUtTLGdCQUFMO0FBQ0EsbUJBQUtTLGNBQUw7O0FBRUEsa0JBQU0sT0FBS1AsZUFBTCxFQUFOO0FBeEJlO0FBeUJsQjtBQW5Sa0M7a0JBQWxCOUUsaUIiLCJmaWxlIjoiY2xpL2FyZ3VtZW50LXBhcnNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlc29sdmUsIGRpcm5hbWUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IENvbW1hbmQgfSBmcm9tICdjb21tYW5kZXInO1xuaW1wb3J0IGRlZGVudCBmcm9tICdkZWRlbnQnO1xuaW1wb3J0IHsgcmVhZFN5bmMgYXMgcmVhZCB9IGZyb20gJ3JlYWQtZmlsZS1yZWxhdGl2ZSc7XG5pbXBvcnQgbWFrZURpciBmcm9tICdtYWtlLWRpcic7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgTUVTU0FHRSBmcm9tICcuLi9lcnJvcnMvcnVudGltZS9tZXNzYWdlJztcbmltcG9ydCB7IGFzc2VydFR5cGUsIGlzIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUvdHlwZS1hc3NlcnRpb25zJztcbmltcG9ydCBnZXRWaWV3UG9ydFdpZHRoIGZyb20gJy4uL3V0aWxzL2dldC12aWV3cG9ydC13aWR0aCc7XG5pbXBvcnQgeyB3b3JkV3JhcCwgc3BsaXRRdW90ZWRUZXh0IH0gZnJvbSAnLi4vdXRpbHMvc3RyaW5nJztcbmltcG9ydCB7IGlzTWF0Y2ggfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhcnNlU3NsT3B0aW9ucyBmcm9tICcuL3BhcnNlLXNzbC1vcHRpb25zJztcblxuY29uc3QgUkVNT1RFX0FMSUFTX1JFID0gL15yZW1vdGUoPzo6KFxcZCopKT8kLztcblxuY29uc3QgREVTQ1JJUFRJT04gPSBkZWRlbnQoYFxuICAgIEluIHRoZSBicm93c2VyIGxpc3QsIHlvdSBjYW4gdXNlIGJyb3dzZXIgbmFtZXMgKGUuZy4gXCJpZVwiLCBcImNocm9tZVwiLCBldGMuKSBhcyB3ZWxsIGFzIHBhdGhzIHRvIGV4ZWN1dGFibGVzLlxuXG4gICAgVG8gcnVuIHRlc3RzIGFnYWluc3QgYWxsIGluc3RhbGxlZCBicm93c2VycywgdXNlIHRoZSBcImFsbFwiIGFsaWFzLlxuXG4gICAgVG8gdXNlIGEgcmVtb3RlIGJyb3dzZXIgY29ubmVjdGlvbiAoZS5nLiwgdG8gY29ubmVjdCBhIG1vYmlsZSBkZXZpY2UpLCBzcGVjaWZ5IFwicmVtb3RlXCIgYXMgdGhlIGJyb3dzZXIgYWxpYXMuXG4gICAgSWYgeW91IG5lZWQgdG8gY29ubmVjdCBtdWx0aXBsZSBkZXZpY2VzLCBhZGQgYSBjb2xvbiBhbmQgdGhlIG51bWJlciBvZiBicm93c2VycyB5b3Ugd2FudCB0byBjb25uZWN0IChlLmcuLCBcInJlbW90ZTozXCIpLlxuXG4gICAgVG8gcnVuIHRlc3RzIGluIGEgYnJvd3NlciBhY2Nlc3NlZCB0aHJvdWdoIGEgYnJvd3NlciBwcm92aWRlciBwbHVnaW4sIHNwZWNpZnkgYSBicm93c2VyIGFsaWFzIHRoYXQgY29uc2lzdHMgb2YgdHdvIHBhcnRzIC0gdGhlIGJyb3dzZXIgcHJvdmlkZXIgbmFtZSBwcmVmaXggYW5kIHRoZSBuYW1lIG9mIHRoZSBicm93c2VyIGl0c2VsZjsgZm9yIGV4YW1wbGUsIFwic2F1Y2VsYWJzOmNocm9tZUA1MVwiLlxuXG4gICAgWW91IGNhbiB1c2Ugb25lIG9yIG1vcmUgZmlsZSBwYXRocyBvciBnbG9iIHBhdHRlcm5zIHRvIHNwZWNpZnkgd2hpY2ggdGVzdHMgdG8gcnVuLlxuXG4gICAgTW9yZSBpbmZvOiBodHRwczovL2RldmV4cHJlc3MuZ2l0aHViLmlvL3Rlc3RjYWZlL2RvY3VtZW50YXRpb25cbmApO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDTElBcmd1bWVudFBhcnNlciB7XG4gICAgY29uc3RydWN0b3IgKGN3ZCkge1xuICAgICAgICB0aGlzLnByb2dyYW0gPSBuZXcgQ29tbWFuZCgndGVzdGNhZmUnKTtcblxuICAgICAgICB0aGlzLmN3ZCA9IGN3ZCB8fCBwcm9jZXNzLmN3ZCgpO1xuXG4gICAgICAgIHRoaXMuc3JjICAgICAgICAgPSBudWxsO1xuICAgICAgICB0aGlzLmJyb3dzZXJzICAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5maWx0ZXIgICAgICA9IG51bGw7XG4gICAgICAgIHRoaXMucmVtb3RlQ291bnQgPSAwO1xuICAgICAgICB0aGlzLm9wdHMgICAgICAgID0gbnVsbDtcblxuICAgICAgICB0aGlzLl9kZXNjcmliZVByb2dyYW0oKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX3BhcnNlUG9ydE51bWJlciAodmFsdWUpIHtcbiAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OZWdhdGl2ZU51bWJlclN0cmluZywgbnVsbCwgJ1BvcnQgbnVtYmVyJywgdmFsdWUpO1xuXG4gICAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApO1xuICAgIH1cblxuICAgIHN0YXRpYyBfb3B0aW9uVmFsdWVUb1JlZ0V4cCAobmFtZSwgdmFsdWUpIHtcbiAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmVnRXhwKHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKE1FU1NBR0Uub3B0aW9uVmFsdWVJc05vdFZhbGlkUmVnRXhwLCBuYW1lKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBfb3B0aW9uVmFsdWVUb0tleVZhbHVlIChuYW1lLCB2YWx1ZSkge1xuICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQgMClcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcblxuICAgICAgICBjb25zdCBrZXlWYWx1ZSA9IHZhbHVlLnNwbGl0KCcsJykucmVkdWNlKChvYmosIHBhaXIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IFtrZXksIHZhbF0gPSBwYWlyLnNwbGl0KCc9Jyk7XG5cbiAgICAgICAgICAgIGlmICgha2V5IHx8ICF2YWwpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLm9wdGlvblZhbHVlSXNOb3RWYWxpZEtleVZhbHVlLCBuYW1lKTtcblxuICAgICAgICAgICAgb2JqW2tleV0gPSB2YWw7XG4gICAgICAgICAgICByZXR1cm4gb2JqO1xuICAgICAgICB9LCB7fSk7XG5cbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKGtleVZhbHVlKS5sZW5ndGggPT09IDApXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKE1FU1NBR0Uub3B0aW9uVmFsdWVJc05vdFZhbGlkS2V5VmFsdWUsIG5hbWUpO1xuXG4gICAgICAgIHJldHVybiBrZXlWYWx1ZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2dldERlc2NyaXB0aW9uICgpIHtcbiAgICAgICAgLy8gTk9URTogYWRkIGVtcHR5IGxpbmUgdG8gd29ya2Fyb3VuZCBjb21tYW5kZXItZm9yY2VkIGluZGVudGF0aW9uIG9uIHRoZSBmaXJzdCBsaW5lLlxuICAgICAgICByZXR1cm4gJ1xcbicgKyB3b3JkV3JhcChERVNDUklQVElPTiwgMiwgZ2V0Vmlld1BvcnRXaWR0aChwcm9jZXNzLnN0ZG91dCkpO1xuICAgIH1cblxuICAgIF9kZXNjcmliZVByb2dyYW0gKCkge1xuICAgICAgICBjb25zdCB2ZXJzaW9uID0gSlNPTi5wYXJzZShyZWFkKCcuLi8uLi9wYWNrYWdlLmpzb24nKSkudmVyc2lvbjtcblxuICAgICAgICB0aGlzLnByb2dyYW1cblxuICAgICAgICAgICAgLnZlcnNpb24odmVyc2lvbiwgJy12LCAtLXZlcnNpb24nKVxuICAgICAgICAgICAgLnVzYWdlKCdbb3B0aW9uc10gPGNvbW1hLXNlcGFyYXRlZC1icm93c2VyLWxpc3Q+IDxmaWxlLW9yLWdsb2IgLi4uPicpXG4gICAgICAgICAgICAuZGVzY3JpcHRpb24oQ0xJQXJndW1lbnRQYXJzZXIuX2dldERlc2NyaXB0aW9uKCkpXG5cbiAgICAgICAgICAgIC5vcHRpb24oJy1iLCAtLWxpc3QtYnJvd3NlcnMgW3Byb3ZpZGVyXScsICdvdXRwdXQgdGhlIGFsaWFzZXMgZm9yIGxvY2FsIGJyb3dzZXJzIG9yIGJyb3dzZXJzIGF2YWlsYWJsZSB0aHJvdWdoIHRoZSBzcGVjaWZpZWQgYnJvd3NlciBwcm92aWRlcicpXG4gICAgICAgICAgICAub3B0aW9uKCctciwgLS1yZXBvcnRlciA8bmFtZVs6b3V0cHV0RmlsZV1bLC4uLl0+JywgJ3NwZWNpZnkgdGhlIHJlcG9ydGVycyBhbmQgb3B0aW9uYWxseSBmaWxlcyB3aGVyZSByZXBvcnRzIGFyZSBzYXZlZCcpXG4gICAgICAgICAgICAub3B0aW9uKCctcywgLS1zY3JlZW5zaG90cyA8cGF0aD4nLCAnZW5hYmxlIHNjcmVlbnNob3QgY2FwdHVyaW5nIGFuZCBzcGVjaWZ5IHRoZSBwYXRoIHRvIHNhdmUgdGhlIHNjcmVlbnNob3RzIHRvJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1TLCAtLXNjcmVlbnNob3RzLW9uLWZhaWxzJywgJ3Rha2UgYSBzY3JlZW5zaG90IHdoZW5ldmVyIGEgdGVzdCBmYWlscycpXG4gICAgICAgICAgICAub3B0aW9uKCctcCwgLS1zY3JlZW5zaG90LXBhdGgtcGF0dGVybiA8cGF0dGVybj4nLCAndXNlIHBhdHRlcm5zIHRvIGNvbXBvc2Ugc2NyZWVuc2hvdCBmaWxlIG5hbWVzIGFuZCBwYXRoczogJHtCUk9XU0VSfSwgJHtCUk9XU0VSX1ZFUlNJT059LCAke09TfSwgZXRjLicpXG4gICAgICAgICAgICAub3B0aW9uKCctcSwgLS1xdWFyYW50aW5lLW1vZGUnLCAnZW5hYmxlIHRoZSBxdWFyYW50aW5lIG1vZGUnKVxuICAgICAgICAgICAgLm9wdGlvbignLWQsIC0tZGVidWctbW9kZScsICdleGVjdXRlIHRlc3Qgc3RlcHMgb25lIGJ5IG9uZSBwYXVzaW5nIHRoZSB0ZXN0IGFmdGVyIGVhY2ggc3RlcCcpXG4gICAgICAgICAgICAub3B0aW9uKCctZSwgLS1za2lwLWpzLWVycm9ycycsICdtYWtlIHRlc3RzIG5vdCBmYWlsIHdoZW4gYSBKUyBlcnJvciBoYXBwZW5zIG9uIGEgcGFnZScpXG4gICAgICAgICAgICAub3B0aW9uKCctdSwgLS1za2lwLXVuY2F1Z2h0LWVycm9ycycsICdpZ25vcmUgdW5jYXVnaHQgZXJyb3JzIGFuZCB1bmhhbmRsZWQgcHJvbWlzZSByZWplY3Rpb25zLCB3aGljaCBvY2N1ciBkdXJpbmcgdGVzdCBleGVjdXRpb24nKVxuICAgICAgICAgICAgLm9wdGlvbignLXQsIC0tdGVzdCA8bmFtZT4nLCAncnVuIG9ubHkgdGVzdHMgd2l0aCB0aGUgc3BlY2lmaWVkIG5hbWUnKVxuICAgICAgICAgICAgLm9wdGlvbignLVQsIC0tdGVzdC1ncmVwIDxwYXR0ZXJuPicsICdydW4gb25seSB0ZXN0cyBtYXRjaGluZyB0aGUgc3BlY2lmaWVkIHBhdHRlcm4nKVxuICAgICAgICAgICAgLm9wdGlvbignLWYsIC0tZml4dHVyZSA8bmFtZT4nLCAncnVuIG9ubHkgZml4dHVyZXMgd2l0aCB0aGUgc3BlY2lmaWVkIG5hbWUnKVxuICAgICAgICAgICAgLm9wdGlvbignLUYsIC0tZml4dHVyZS1ncmVwIDxwYXR0ZXJuPicsICdydW4gb25seSBmaXh0dXJlcyBtYXRjaGluZyB0aGUgc3BlY2lmaWVkIHBhdHRlcm4nKVxuICAgICAgICAgICAgLm9wdGlvbignLWEsIC0tYXBwIDxjb21tYW5kPicsICdsYXVuY2ggdGhlIHRlc3RlZCBhcHAgdXNpbmcgdGhlIHNwZWNpZmllZCBjb21tYW5kIGJlZm9yZSBydW5uaW5nIHRlc3RzJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1jLCAtLWNvbmN1cnJlbmN5IDxudW1iZXI+JywgJ3J1biB0ZXN0cyBjb25jdXJyZW50bHknKVxuICAgICAgICAgICAgLm9wdGlvbignLS10ZXN0LW1ldGEgPGtleT12YWx1ZVssa2V5Mj12YWx1ZTIsLi4uXT4nLCAncnVuIG9ubHkgdGVzdHMgd2l0aCBtYXRjaGluZyBtZXRhZGF0YScpXG4gICAgICAgICAgICAub3B0aW9uKCctLWZpeHR1cmUtbWV0YSA8a2V5PXZhbHVlWyxrZXkyPXZhbHVlMiwuLi5dPicsICdydW4gb25seSBmaXh0dXJlcyB3aXRoIG1hdGNoaW5nIG1ldGFkYXRhJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tZGVidWctb24tZmFpbCcsICdwYXVzZSB0aGUgdGVzdCBpZiBpdCBmYWlscycpXG4gICAgICAgICAgICAub3B0aW9uKCctLWFwcC1pbml0LWRlbGF5IDxtcz4nLCAnc3BlY2lmeSBob3cgbXVjaCB0aW1lIGl0IHRha2VzIGZvciB0aGUgdGVzdGVkIGFwcCB0byBpbml0aWFsaXplJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tc2VsZWN0b3ItdGltZW91dCA8bXM+JywgJ3NldCB0aGUgYW1vdW50IG9mIHRpbWUgd2l0aGluIHdoaWNoIHNlbGVjdG9ycyBtYWtlIGF0dGVtcHRzIHRvIG9idGFpbiBhIG5vZGUgdG8gYmUgcmV0dXJuZWQnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1hc3NlcnRpb24tdGltZW91dCA8bXM+JywgJ3NldCB0aGUgYW1vdW50IG9mIHRpbWUgd2l0aGluIHdoaWNoIGFzc2VydGlvbiBzaG91bGQgcGFzcycpXG4gICAgICAgICAgICAub3B0aW9uKCctLXBhZ2UtbG9hZC10aW1lb3V0IDxtcz4nLCAnc2V0IHRoZSBhbW91bnQgb2YgdGltZSB3aXRoaW4gd2hpY2ggVGVzdENhZmUgd2FpdHMgZm9yIHRoZSBgd2luZG93LmxvYWRgIGV2ZW50IHRvIGZpcmUgb24gcGFnZSBsb2FkIGJlZm9yZSBwcm9jZWVkaW5nIHRvIHRoZSBuZXh0IHRlc3QgYWN0aW9uJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tc3BlZWQgPGZhY3Rvcj4nLCAnc2V0IHRoZSBzcGVlZCBvZiB0ZXN0IGV4ZWN1dGlvbiAoMC4wMSAuLi4gMSknKVxuICAgICAgICAgICAgLm9wdGlvbignLS1wb3J0cyA8cG9ydDEscG9ydDI+JywgJ3NwZWNpZnkgY3VzdG9tIHBvcnQgbnVtYmVycycpXG4gICAgICAgICAgICAub3B0aW9uKCctLWhvc3RuYW1lIDxuYW1lPicsICdzcGVjaWZ5IHRoZSBob3N0bmFtZScpXG4gICAgICAgICAgICAub3B0aW9uKCctLXByb3h5IDxob3N0PicsICdzcGVjaWZ5IHRoZSBob3N0IG9mIHRoZSBwcm94eSBzZXJ2ZXInKVxuICAgICAgICAgICAgLm9wdGlvbignLS1wcm94eS1ieXBhc3MgPHJ1bGVzPicsICdzcGVjaWZ5IGEgY29tbWEtc2VwYXJhdGVkIGxpc3Qgb2YgcnVsZXMgdGhhdCBkZWZpbmUgVVJMcyBhY2Nlc3NlZCBieXBhc3NpbmcgdGhlIHByb3h5IHNlcnZlcicpXG4gICAgICAgICAgICAub3B0aW9uKCctLXNzbCA8b3B0aW9ucz4nLCAnc3BlY2lmeSBTU0wgb3B0aW9ucyB0byBydW4gVGVzdENhZmUgcHJveHkgc2VydmVyIG92ZXIgdGhlIEhUVFBTIHByb3RvY29sJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tZGlzYWJsZS1wYWdlLXJlbG9hZHMnLCAnZGlzYWJsZSBwYWdlIHJlbG9hZHMgYmV0d2VlbiB0ZXN0cycpXG4gICAgICAgICAgICAub3B0aW9uKCctLWRldicsICdlbmFibGVzIG1lY2hhbmlzbXMgdG8gbG9nIGFuZCBkaWFnbm9zZSBlcnJvcnMnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1xci1jb2RlJywgJ291dHB1dHMgUVItY29kZSB0aGF0IHJlcGVhdHMgVVJMcyB1c2VkIHRvIGNvbm5lY3QgdGhlIHJlbW90ZSBicm93c2VycycpXG4gICAgICAgICAgICAub3B0aW9uKCctLXNmLCAtLXN0b3Atb24tZmlyc3QtZmFpbCcsICdzdG9wIGFuIGVudGlyZSB0ZXN0IHJ1biBpZiBhbnkgdGVzdCBmYWlscycpXG4gICAgICAgICAgICAub3B0aW9uKCctLWRpc2FibGUtdGVzdC1zeW50YXgtdmFsaWRhdGlvbicsICdkaXNhYmxlcyBjaGVja3MgZm9yIFxcJ3Rlc3RcXCcgYW5kIFxcJ2ZpeHR1cmVcXCcgZGlyZWN0aXZlcyB0byBydW4gZHluYW1pY2FsbHkgbG9hZGVkIHRlc3RzJylcblxuXG4gICAgICAgICAgICAvLyBOT1RFOiB0aGVzZSBvcHRpb25zIHdpbGwgYmUgaGFuZGxlZCBieSBjaGFsayBpbnRlcm5hbGx5XG4gICAgICAgICAgICAub3B0aW9uKCctLWNvbG9yJywgJ2ZvcmNlIGNvbG9ycyBpbiBjb21tYW5kIGxpbmUnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1uby1jb2xvcicsICdkaXNhYmxlIGNvbG9ycyBpbiBjb21tYW5kIGxpbmUnKTtcbiAgICB9XG5cbiAgICBfZmlsdGVyQW5kQ291bnRSZW1vdGVzIChicm93c2VyKSB7XG4gICAgICAgIGNvbnN0IHJlbW90ZU1hdGNoID0gYnJvd3Nlci5tYXRjaChSRU1PVEVfQUxJQVNfUkUpO1xuXG4gICAgICAgIGlmIChyZW1vdGVNYXRjaCkge1xuICAgICAgICAgICAgdGhpcy5yZW1vdGVDb3VudCArPSBwYXJzZUludChyZW1vdGVNYXRjaFsxXSwgMTApIHx8IDE7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBfcGFyc2VGaWx0ZXJpbmdPcHRpb25zICgpIHtcbiAgICAgICAgdGhpcy5vcHRzLnRlc3RHcmVwICAgID0gQ0xJQXJndW1lbnRQYXJzZXIuX29wdGlvblZhbHVlVG9SZWdFeHAoJy0tdGVzdC1ncmVwJywgdGhpcy5vcHRzLnRlc3RHcmVwKTtcbiAgICAgICAgdGhpcy5vcHRzLmZpeHR1cmVHcmVwID0gQ0xJQXJndW1lbnRQYXJzZXIuX29wdGlvblZhbHVlVG9SZWdFeHAoJy0tZml4dHVyZS1ncmVwJywgdGhpcy5vcHRzLmZpeHR1cmVHcmVwKTtcbiAgICAgICAgdGhpcy5vcHRzLnRlc3RNZXRhICAgID0gQ0xJQXJndW1lbnRQYXJzZXIuX29wdGlvblZhbHVlVG9LZXlWYWx1ZSgnLS10ZXN0LW1ldGEnLCB0aGlzLm9wdHMudGVzdE1ldGEpO1xuICAgICAgICB0aGlzLm9wdHMuZml4dHVyZU1ldGEgPSBDTElBcmd1bWVudFBhcnNlci5fb3B0aW9uVmFsdWVUb0tleVZhbHVlKCctLWZpeHR1cmUtbWV0YScsIHRoaXMub3B0cy5maXh0dXJlTWV0YSk7XG5cbiAgICAgICAgdGhpcy5maWx0ZXIgPSAodGVzdE5hbWUsIGZpeHR1cmVOYW1lLCBmaXh0dXJlUGF0aCwgdGVzdE1ldGEsIGZpeHR1cmVNZXRhKSA9PiB7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMudGVzdCAmJiB0ZXN0TmFtZSAhPT0gdGhpcy5vcHRzLnRlc3QpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRzLnRlc3RHcmVwICYmICF0aGlzLm9wdHMudGVzdEdyZXAudGVzdCh0ZXN0TmFtZSkpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRzLmZpeHR1cmUgJiYgZml4dHVyZU5hbWUgIT09IHRoaXMub3B0cy5maXh0dXJlKVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5maXh0dXJlR3JlcCAmJiAhdGhpcy5vcHRzLmZpeHR1cmVHcmVwLnRlc3QoZml4dHVyZU5hbWUpKVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICAgICAgaWYgKHRoaXMub3B0cy50ZXN0TWV0YSAmJiAhaXNNYXRjaCh0ZXN0TWV0YSwgdGhpcy5vcHRzLnRlc3RNZXRhKSlcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuZml4dHVyZU1ldGEgJiYgIWlzTWF0Y2goZml4dHVyZU1ldGEsIHRoaXMub3B0cy5maXh0dXJlTWV0YSkpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfcGFyc2VBcHBJbml0RGVsYXkgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLmFwcEluaXREZWxheSkge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OZWdhdGl2ZU51bWJlclN0cmluZywgbnVsbCwgJ1Rlc3RlZCBhcHAgaW5pdGlhbGl6YXRpb24gZGVsYXknLCB0aGlzLm9wdHMuYXBwSW5pdERlbGF5KTtcblxuICAgICAgICAgICAgdGhpcy5vcHRzLmFwcEluaXREZWxheSA9IHBhcnNlSW50KHRoaXMub3B0cy5hcHBJbml0RGVsYXksIDEwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9wYXJzZVNlbGVjdG9yVGltZW91dCAoKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuc2VsZWN0b3JUaW1lb3V0KSB7XG4gICAgICAgICAgICBhc3NlcnRUeXBlKGlzLm5vbk5lZ2F0aXZlTnVtYmVyU3RyaW5nLCBudWxsLCAnU2VsZWN0b3IgdGltZW91dCcsIHRoaXMub3B0cy5zZWxlY3RvclRpbWVvdXQpO1xuXG4gICAgICAgICAgICB0aGlzLm9wdHMuc2VsZWN0b3JUaW1lb3V0ID0gcGFyc2VJbnQodGhpcy5vcHRzLnNlbGVjdG9yVGltZW91dCwgMTApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX3BhcnNlQXNzZXJ0aW9uVGltZW91dCAoKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuYXNzZXJ0aW9uVGltZW91dCkge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OZWdhdGl2ZU51bWJlclN0cmluZywgbnVsbCwgJ0Fzc2VydGlvbiB0aW1lb3V0JywgdGhpcy5vcHRzLmFzc2VydGlvblRpbWVvdXQpO1xuXG4gICAgICAgICAgICB0aGlzLm9wdHMuYXNzZXJ0aW9uVGltZW91dCA9IHBhcnNlSW50KHRoaXMub3B0cy5hc3NlcnRpb25UaW1lb3V0LCAxMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcGFyc2VQYWdlTG9hZFRpbWVvdXQgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLnBhZ2VMb2FkVGltZW91dCkge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OZWdhdGl2ZU51bWJlclN0cmluZywgbnVsbCwgJ1BhZ2UgbG9hZCB0aW1lb3V0JywgdGhpcy5vcHRzLnBhZ2VMb2FkVGltZW91dCk7XG5cbiAgICAgICAgICAgIHRoaXMub3B0cy5wYWdlTG9hZFRpbWVvdXQgPSBwYXJzZUludCh0aGlzLm9wdHMucGFnZUxvYWRUaW1lb3V0LCAxMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcGFyc2VTcGVlZCAoKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuc3BlZWQpXG4gICAgICAgICAgICB0aGlzLm9wdHMuc3BlZWQgPSBwYXJzZUZsb2F0KHRoaXMub3B0cy5zcGVlZCk7XG4gICAgfVxuXG4gICAgX3BhcnNlQ29uY3VycmVuY3kgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLmNvbmN1cnJlbmN5KVxuICAgICAgICAgICAgdGhpcy5jb25jdXJyZW5jeSA9IHBhcnNlSW50KHRoaXMub3B0cy5jb25jdXJyZW5jeSwgMTApO1xuICAgIH1cblxuICAgIF9wYXJzZVBvcnRzICgpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5wb3J0cykge1xuICAgICAgICAgICAgdGhpcy5vcHRzLnBvcnRzID0gdGhpcy5vcHRzLnBvcnRzXG4gICAgICAgICAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgICAgICAgICAubWFwKENMSUFyZ3VtZW50UGFyc2VyLl9wYXJzZVBvcnROdW1iZXIpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRzLnBvcnRzLmxlbmd0aCA8IDIpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLnBvcnRzT3B0aW9uUmVxdWlyZXNUd29OdW1iZXJzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9wYXJzZUJyb3dzZXJMaXN0ICgpIHtcbiAgICAgICAgY29uc3QgYnJvd3NlcnNBcmcgPSB0aGlzLnByb2dyYW0uYXJnc1swXSB8fCAnJztcblxuICAgICAgICB0aGlzLmJyb3dzZXJzID0gc3BsaXRRdW90ZWRUZXh0KGJyb3dzZXJzQXJnLCAnLCcpXG4gICAgICAgICAgICAuZmlsdGVyKGJyb3dzZXIgPT4gYnJvd3NlciAmJiB0aGlzLl9maWx0ZXJBbmRDb3VudFJlbW90ZXMoYnJvd3NlcikpO1xuICAgIH1cblxuICAgIF9wYXJzZVNzbE9wdGlvbnMgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLnNzbClcbiAgICAgICAgICAgIHRoaXMub3B0cy5zc2wgPSBwYXJzZVNzbE9wdGlvbnModGhpcy5vcHRzLnNzbCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3BhcnNlUmVwb3J0ZXJzICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLm9wdHMucmVwb3J0ZXIpIHtcbiAgICAgICAgICAgIHRoaXMub3B0cy5yZXBvcnRlcnMgPSBbXTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlcG9ydGVycyA9IHRoaXMub3B0cy5yZXBvcnRlci5zcGxpdCgnLCcpO1xuXG4gICAgICAgIHRoaXMub3B0cy5yZXBvcnRlcnMgPSByZXBvcnRlcnMubWFwKHJlcG9ydGVyID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNlcGFyYXRvckluZGV4ID0gcmVwb3J0ZXIuaW5kZXhPZignOicpO1xuXG4gICAgICAgICAgICBpZiAoc2VwYXJhdG9ySW5kZXggPCAwKVxuICAgICAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IHJlcG9ydGVyIH07XG5cbiAgICAgICAgICAgIGNvbnN0IG5hbWUgICAgPSByZXBvcnRlci5zdWJzdHJpbmcoMCwgc2VwYXJhdG9ySW5kZXgpO1xuICAgICAgICAgICAgY29uc3Qgb3V0RmlsZSA9IHJlcG9ydGVyLnN1YnN0cmluZyhzZXBhcmF0b3JJbmRleCArIDEpO1xuXG4gICAgICAgICAgICByZXR1cm4geyBuYW1lLCBvdXRGaWxlIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QgcmVwb3J0ZXIgb2YgdGhpcy5vcHRzLnJlcG9ydGVycykge1xuICAgICAgICAgICAgaWYgKHJlcG9ydGVyLm91dEZpbGUpIHtcbiAgICAgICAgICAgICAgICByZXBvcnRlci5vdXRGaWxlID0gcmVzb2x2ZSh0aGlzLmN3ZCwgcmVwb3J0ZXIub3V0RmlsZSk7XG5cbiAgICAgICAgICAgICAgICBhd2FpdCBtYWtlRGlyKGRpcm5hbWUocmVwb3J0ZXIub3V0RmlsZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgX3BhcnNlRmlsZUxpc3QgKCkge1xuICAgICAgICB0aGlzLnNyYyA9IHRoaXMucHJvZ3JhbS5hcmdzLnNsaWNlKDEpO1xuICAgIH1cblxuICAgIF9nZXRQcm92aWRlck5hbWUgKCkge1xuICAgICAgICB0aGlzLm9wdHMucHJvdmlkZXJOYW1lID0gdGhpcy5vcHRzLmxpc3RCcm93c2VycyA9PT0gdHJ1ZSA/IHZvaWQgMCA6IHRoaXMub3B0cy5saXN0QnJvd3NlcnM7XG4gICAgfVxuXG4gICAgYXN5bmMgcGFyc2UgKGFyZ3YpIHtcbiAgICAgICAgdGhpcy5wcm9ncmFtLnBhcnNlKGFyZ3YpO1xuXG4gICAgICAgIHRoaXMub3B0cyA9IHRoaXMucHJvZ3JhbS5vcHRzKCk7XG5cbiAgICAgICAgLy8gTk9URTogdGhlICctbGlzdC1icm93c2Vycycgb3B0aW9uIG9ubHkgbGlzdHMgYnJvd3NlcnMgYW5kIGltbWVkaWF0ZWx5IGV4aXRzIHRoZSBhcHAuXG4gICAgICAgIC8vIFRoZXJlZm9yZSwgd2UgZG9uJ3QgbmVlZCB0byBwcm9jZXNzIG90aGVyIGFyZ3VtZW50cy5cbiAgICAgICAgaWYgKHRoaXMub3B0cy5saXN0QnJvd3NlcnMpIHtcbiAgICAgICAgICAgIHRoaXMuX2dldFByb3ZpZGVyTmFtZSgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fcGFyc2VGaWx0ZXJpbmdPcHRpb25zKCk7XG4gICAgICAgIHRoaXMuX3BhcnNlU2VsZWN0b3JUaW1lb3V0KCk7XG4gICAgICAgIHRoaXMuX3BhcnNlQXNzZXJ0aW9uVGltZW91dCgpO1xuICAgICAgICB0aGlzLl9wYXJzZVBhZ2VMb2FkVGltZW91dCgpO1xuICAgICAgICB0aGlzLl9wYXJzZUFwcEluaXREZWxheSgpO1xuICAgICAgICB0aGlzLl9wYXJzZVNwZWVkKCk7XG4gICAgICAgIHRoaXMuX3BhcnNlUG9ydHMoKTtcbiAgICAgICAgdGhpcy5fcGFyc2VCcm93c2VyTGlzdCgpO1xuICAgICAgICB0aGlzLl9wYXJzZUNvbmN1cnJlbmN5KCk7XG4gICAgICAgIHRoaXMuX3BhcnNlU3NsT3B0aW9ucygpO1xuICAgICAgICB0aGlzLl9wYXJzZUZpbGVMaXN0KCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fcGFyc2VSZXBvcnRlcnMoKTtcbiAgICB9XG59XG4iXX0=
